<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>SIP Servlets Server User Guide</title><link rel="stylesheet" type="text/css" href="css/telestax_org.css"/><meta name="generator" content="DocBook XSL Stylesheets V1.77.1"/><meta name="description" content="This user guide will help you get a better understanding of Mobicents SIP servlets and how the container can be used in an enterprise context. The guide will cover how to how to quickly get started with Mobicents SIP servlets either on top of JBoss or Apache Tomcat containers. There are sample applications included for those who want to grasp how to build SIP applications. You will also learn how to use advanced features like High Availability through Clustering and Failover. Finally, monitoring and security will be explained."/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><div class="book"><div class="titlepage"><div><p xmlns:d="http://docbook.org/ns/docbook" id="title"><a href="http://www.telestax.com" class="site_href"><strong>TeleStax.org</strong></a><a href="http://www.telestax.com/" class="doc_href"><strong>Community Documentation</strong></a></p><div><h1 class="title"><a id="d0e2"/>SIP Servlets Server User Guide</h1></div><div><h2 class="subtitle">The Guide to the SIP Servlets v1.1-Certified Server</h2></div><div><div class="authorgroup"><a id="sps-Author_Group"/><div class="author"><h3 class="author"><span class="firstname">Douglas</span> <span class="surname">Silas</span></h3><code class="email">&lt;<a class="email" href="mailto:dhensley@redhat.com">dhensley@redhat.com</a>&gt;</code></div><div class="author"><h3 class="author"><span class="firstname">Jean</span> <span class="surname">Deruelle</span></h3><code class="email">&lt;<a class="email" href="mailto:jean.deruelle (at) gmail.com">jean.deruelle (at) gmail.com</a>&gt;</code></div><div class="author"><h3 class="author"><span class="firstname">Vladimir</span> <span class="surname">Ralev</span></h3><code class="email">&lt;<a class="email" href="mailto:vladimir.ralev (at) gmail.com">vladimir.ralev (at) gmail.com</a>&gt;</code></div><div class="author"><h3 class="author"><span class="firstname">Ivelin</span> <span class="surname">Ivanov</span></h3><code class="email">&lt;<a class="email" href="mailto:ivelin.atanasoff.ivanov (at) gmail.com">ivelin.atanasoff.ivanov (at) gmail.com</a>&gt;</code></div><div class="author"><h3 class="author"><span class="firstname">Charles</span> <span class="surname">Roufay</span></h3><code class="email">&lt;<a class="email" href="mailto:charles.roufay (at) gmail.com">charles.roufay (at) gmail.com</a>&gt;</code></div><div class="author"><h3 class="author"><span class="firstname">Jared</span> <span class="surname">Morgan</span></h3><code class="email">&lt;<a class="email" href="mailto:jmorgan@redhat.com">jmorgan@redhat.com</a>&gt;</code></div></div></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><p>
This user guide will help you get a better understanding of Mobicents SIP servlets and how the container can be used in an enterprise context. The guide will cover how to  how to quickly get started with Mobicents SIP servlets either on top of JBoss or Apache Tomcat containers. There are sample applications included for those who want to grasp how to build SIP applications. You will also learn how to use advanced features like High Availability through Clustering and Failover. Finally, monitoring and security will be explained.
</p></div></div></div><hr/></div><div class="toc"><dl><dt><span class="preface"><a href="#d0e69">Preface</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e72">1. Document Conventions</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e82">1.1. Typographic Conventions</a></span></dt><dt><span class="section"><a href="#d0e298">1.2. Pull-quote Conventions</a></span></dt><dt><span class="section"><a href="#d0e317">1.3. Notes and Warnings</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#ittsss-Introduction_to_the_SIP_Servlets_Server">1. Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e342">1.1. Overview of Mobicents SIP Servlets within the Telecommunications Industry</a></span></dt><dt><span class="section"><a href="#d0e360">1.2. Overview of SIP Servlets Server</a></span></dt></dl></dd><dt><span class="chapter"><a href="#sssicar-SIP_Servlets_Server-Installing_Configuring_and_Running">2. SIP Servlets Server-Installing, Configuring and Running</a></span></dt><dd><dl><dt><span class="section"><a href="#getting-started-with-MSS-JBOSS-AS7">2.1. Getting Started with MSS for JBoss AS7 </a></span></dt><dd><dl><dt><span class="section"><a href="#d0e418">2.1.1. 
Downloading and Starting MSS for JBoss AS7
</a></span></dt><dt><span class="section"><a href="#d0e489">2.1.2. Testing Click2Call with MSS for JBOSS AS7 </a></span></dt><dt><span class="section"><a href="#d0e523">2.1.3.  Command Line Interface for MSS JBoss AS7</a></span></dt><dt><span class="section"><a href="#d0e580">2.1.4. Accessing Management Console </a></span></dt></dl></dd><dt><span class="section"><a href="#getting-started-with-MSS-Tomcat-AS7">2.2. Getting Started with MSS for Tomcat 7  </a></span></dt><dd><dl><dt><span class="section"><a href="#d0e734">2.2.1. Testing Click2CallAsync with MSS for Tomcat 7 </a></span></dt><dt><span class="section"><a href="#bssswticar-SIP_Servlets_Server_with_Tomcat-Installing_Configuring_and_Running">2.2.2. Tomcat for Windows </a></span></dt></dl></dd><dt><span class="section"><a href="#bsssc-binary-SIP_Servlets_Server-Configuring">2.3.  Sip Connectors </a></span></dt><dd><dl><dt><span class="section"><a href="#bsssc-binary-SIP_Servlets_Server-Adding_SIP_Connectors">2.3.1. Configuring SIP Connectors and Bindings</a></span></dt><dt><span class="section"><a href="#bsssc-binary-SIP_Servlets_Server-Configuring_Application_Routing">2.3.2. Application Routing and Service Configuration</a></span></dt><dt><span class="section"><a href="#bsssc-binary-SIP_Servlets_Server-Configuring_Logging">2.3.3. SIP Servlets Server Logging</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#sssicar-SIP_Servlets_Server-Application-Router">3. Application Router</a></span></dt><dd><dl><dt><span class="section"><a href="#tsdar-Default-Application-Router">3.1. Default Application Router</a></span></dt><dd><dl><dt><span class="section"><a href="#tsdar-Application-Router-Role">3.1.1. Role of the Application Router</a></span></dt><dt><span class="section"><a href="#tsdar-Mobicents-Default-Application-Router">3.1.2. Mobicents Default Application Router</a></span></dt><dt><span class="section"><a href="#tsdar-Limitations">3.1.3. Limitations of the Default Application Router</a></span></dt></dl></dd><dt><span class="section"><a href="#tsear-echarts-Application-Router">3.2. DFC Application Router</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1957">3.2.1. Description of DFC Application Router</a></span></dt><dt><span class="section"><a href="#d0e1965">3.2.2. Installing the DFC Application Router</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#ssea-SIP_Servlet_Example_Applications">4. SIP Servlet Example Applications</a></span></dt><dd><dl><dt><span class="section"><a href="#sfss-Services_for_SIP_Servlets">4.1. Operating the Example Applications</a></span></dt><dd><dl><dt><span class="section"><a href="#sfss-The_Location_Service">4.1.1. The Location Service</a></span></dt><dt><span class="section"><a href="#sfss-The_Diameter_Event-Changing_Service">4.1.2. The Diameter Event-Changing Service</a></span></dt><dt><span class="section"><a href="#sfss-The_Call-Blocking_Service">4.1.3. The Call-Blocking Service</a></span></dt><dt><span class="section"><a href="#sfss-The_Call-Forwarding_Service">4.1.4. The Call-Forwarding Service</a></span></dt><dt><span class="section"><a href="#sfss-The_Call-Controller_Service">4.1.5. The Call-Controller Service</a></span></dt><dt><span class="section"><a href="#mipbx-Media_IPBX">4.1.6. Media IPBX</a></span></dt><dt><span class="section"><a href="#concept-chapter-SS_click2call">4.1.7. Tomcat Servlet Click2call Windows Setup</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#d0e3786">5. Clustering and High Availability</a></span></dt><dd><dl><dt><span class="section"><a href="#ssfjcs-SS_for_JBoss-Clustering_Support">5.1.  Understanding Mobicents High Availabilty </a></span></dt><dt><span class="section"><a href="#sslb-MSS_Load_Balancer">5.2. Load Balancer</a></span></dt><dd><dl><dt><span class="section"><a href="#sslb-binary-SIP_Load_Balancer-Installing_Configuring_and_Running">5.2.1. SIP Load Balancer: Installing, Configuring and Running</a></span></dt><dt><span class="section"><a href="#d0e4368">5.2.2. IP Load Balancing</a></span></dt><dt><span class="section"><a href="#sslb-SIP_Load_Balancing_Basics">5.2.3. SIP Load Balancing Basics</a></span></dt><dt><span class="section"><a href="#d0e4463">5.2.4. HTTP Load Balancing Basics</a></span></dt><dt><span class="section"><a href="#d0e4499">5.2.5. Pluggable balancer algorithms</a></span></dt><dt><span class="section"><a href="#d0e4550">5.2.6. Distributed load balancing</a></span></dt><dt><span class="section"><a href="#sslb-SIP_Load_Balancer-Implementation">5.2.7. Implementation of the Mobicents Load Balancer</a></span></dt><dt><span class="section"><a href="#d0e4577">5.2.8. SIP Message Flow</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#emom-Enterprise-Monitoring-Operations-Management">6. Enterprise Monitoring and Management</a></span></dt><dt><span class="chapter"><a href="#ssecurity-Sip_Servlet_Security">7. Security</a></span></dt><dd><dl><dt><span class="section"><a href="#sss-SIP_Servlet_Security">7.1. SIP Servlets Application Security</a></span></dt><dt><span class="section"><a href="#sss-TLS">7.2. TLS</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4826">7.2.1. Quick Start</a></span></dt><dt><span class="section"><a href="#sss-TLS_production_setup">7.2.2. Production Setup</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#afotsss-Advanced_Features_of_the_SIP_Servlets_Server">8. Advanced Features of the SIP Servlets Server</a></span></dt><dd><dl><dt><span class="section"><a href="#mipbx-Media_Support">8.1. Media Support</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e5081">8.1.1. JSR 309: Media Server Control API</a></span></dt></dl></dd><dt><span class="section"><a href="#sscacc-MSS_Concurrency_and_Congestion_Control">8.2. Concurrency and Congestion Control</a></span></dt><dt><span class="section"><a href="#mssstun-MSS_STUN">8.3. STUN Support</a></span></dt><dt><span class="section"><a href="#sscacc-MSS_JSR289_Extensions">8.4. Mobicents vendor-specific Extensions to JSR 289</a></span></dt><dt><span class="section"><a href="#stf-CDI_Telco_Framework">8.5. CDI Telco Framework</a></span></dt><dt><span class="section"><a href="#ssds-Diameter_Support">8.6. Diameter Support</a></span></dt><dt><span class="section"><a href="#saimse-SIP_and_IMS_Extensions">8.7. SIP and IMS Extensions</a></span></dt><dt><span class="section"><a href="#ss_jslee_interop">8.8. SIP Servlets - JAIN SLEE Interoperability</a></span></dt><dt><span class="section"><a href="#d0e6130">8.9. Eclipse IDE Tools</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6141">8.9.1. Pre-Install requirements</a></span></dt><dt><span class="section"><a href="#d0e6146">8.9.2. Installation</a></span></dt><dt><span class="section"><a href="#d0e6157">8.9.3. SIP Servlets Core Plug-in</a></span></dt><dt><span class="section"><a href="#d0e6165">8.9.4. SIP Phone Plug-in</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#bp-Best_Practices">9. Best Practices</a></span></dt><dd><dl><dt><span class="section"><a href="#bp-Best_Practices_Perf_Tips">9.1. Mobicents SIP Servlets Performance Tips</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6183">9.1.1. Tuning JBoss</a></span></dt><dt><span class="section"><a href="#d0e6200">9.1.2. Tuning Mobicents SIP Servlets</a></span></dt><dt><span class="section"><a href="#d0e6229">9.1.3. Tuning The JAIN SIP Stack</a></span></dt><dt><span class="section"><a href="#d0e6346">9.1.4. Tuning The JVM</a></span></dt><dt><span class="section"><a href="#d0e6402">9.1.5. Tuning The Operating System</a></span></dt></dl></dd><dt><span class="section"><a href="#bp-Best_Practices_NAT">9.2. NAT Traversal</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6481">9.2.1. STUN</a></span></dt><dt><span class="section"><a href="#d0e6490">9.2.2. TURN</a></span></dt><dt><span class="section"><a href="#d0e6501">9.2.3. ICE</a></span></dt><dt><span class="section"><a href="#d0e6516">9.2.4. Other Approaches</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#Appendix">10. Apendix</a></span></dt><dd><dl><dt><span class="section"><a href="#install-configure-JDK">10.1. Java Development Kit (<acronym class="acronym">JDK</acronym>): Installing, Configuring and Running</a></span></dt><dd><dl><dt><span class="section"><a href="#JRE-or-JDK-32Bit-or-64Bit">10.1.1.  JRE versus JDK - 32-Bit versus 64-Bit</a></span></dt><dt><span class="section"><a href="#Downloading-JDK">10.1.2. Downloading JDK </a></span></dt><dt><span class="section"><a href="#install-JDK-on-windows">10.1.3. Installing JDK on Windows</a></span></dt><dt><span class="section"><a href="#setting-ENV-linux">10.1.4. Setting Linux JAVA_HOME Environment Variables </a></span></dt><dt><span class="section"><a href="#setting-correct-java-version">10.1.5. Setting the Correct Java Version </a></span></dt><dt><span class="section"><a href="#setting-ENV-windows">10.1.6. Setting JAVA_HOME Environment Variables on Windows</a></span></dt><dt><span class="section"><a href="#install-JDK-linux-windows">10.1.7.  Uninstalling JDK on Linux and Windows</a></span></dt><dt><span class="section"><a href="#setting-jboss-ENV-variable-windows-unix">10.1.8. Setting the JBOSS_HOME Environment Variable</a></span></dt><dt><span class="section"><a href="#setting-CATALINA_HOME-ENV-linux-windows">10.1.9. Setting CATALINA_HOME on Linux and Windows</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#bp-jsr289-errata">11. JSR 289 Errata</a></span></dt><dd><dl><dt><span class="section"><a href="#errata-Deviations">11.1. Mobicents SIP Servlets Deviations from JSR 289</a></span></dt></dl></dd><dt><span class="appendix"><a href="#d0e7362">A. Revision History</a></span></dt></dl></div><div class="preface"><div class="titlepage"><div><div><h1 class="title"><a id="d0e69"/>Preface</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="d0e72"/>1. Document Conventions</h2></div></div></div><p>
		This manual uses several conventions to highlight certain words and phrases and draw attention to specific pieces of information.
	</p><p>
		In PDF and paper editions, this manual uses typefaces drawn from the <a class="ulink" href="https://fedorahosted.org/liberation-fonts/">Liberation Fonts</a> set. The Liberation Fonts set is also used in HTML editions if the set is installed on your system. If not, alternative but equivalent typefaces are displayed. Note: Red Hat Enterprise Linux 5 and later includes the Liberation Fonts set by default.
	</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e82"/>1.1. Typographic Conventions</h3></div></div></div><p>
			Four typographic conventions are used to call attention to specific words and phrases. These conventions, and the circumstances they apply to, are as follows.
		</p><p>
			<code class="literal">Mono-spaced Bold</code>
		</p><p>
			Used to highlight system input, including shell commands, file names and paths. Also used to highlight key caps and key-combinations. For example:
		</p><div class="blockquote"><blockquote class="blockquote"><p>
				To see the contents of the file <code class="filename">my_next_bestselling_novel</code> in your current working directory, enter the <span class="command"><strong>cat my_next_bestselling_novel</strong></span> command at the shell prompt and press <span class="keycap"><strong>Enter</strong></span> to execute the command.
			</p></blockquote></div><p>
			The above includes a file name, a shell command and a key cap, all presented in Mono-spaced Bold and all distinguishable thanks to context.
		</p><p>
			Key-combinations can be distinguished from key caps by the hyphen connecting each part of a key-combination. For example:
		</p><div class="blockquote"><blockquote class="blockquote"><p>
				Press <span class="keycap"><strong>Enter</strong></span> to execute the command.
			</p><p>
				Press <span class="keycap"><strong>Ctrl</strong></span>+<span class="keycap"><strong>Alt</strong></span>+<span class="keycap"><strong>F1</strong></span> to switch to the first virtual terminal. Press <span class="keycap"><strong>Ctrl</strong></span>+<span class="keycap"><strong>Alt</strong></span>+<span class="keycap"><strong>F7</strong></span> to return to your X-Windows session.
			</p></blockquote></div><p>
			The first sentence highlights the particular key cap to press. The second highlights two sets of three key caps, each set pressed simultaneously.
		</p><p>
			If source code is discussed, class names, methods, functions, variable names and returned values mentioned within a paragraph will be presented as above, in <code class="literal">Mono-spaced Bold</code>. For example:
		</p><div class="blockquote"><blockquote class="blockquote"><p>
				File-related classes include <code class="classname">filesystem</code> for file systems, <code class="classname">file</code> for files, and <code class="classname">dir</code> for directories. Each class has its own associated set of permissions.
			</p></blockquote></div><p>
			<span class="application">Proportional Bold</span>
		</p><p>
			This denotes words or phrases encountered on a system, including application names; dialogue box text; labelled buttons; check-box and radio button labels; menu titles and sub-menu titles. For example:
		</p><div class="blockquote"><blockquote class="blockquote"><p>
				Choose <span class="guimenu">System &gt; Preferences &gt; Mouse</span> from the main menu bar to launch <span class="application">Mouse Preferences</span>. In the <span class="guilabel">Buttons</span> tab, click the <span class="guilabel">Left-handed mouse</span> check box and click <span class="guibutton">Close</span> to switch the primary mouse button from the left to the right (making the mouse suitable for use in the left hand).
			</p><p>
				To insert a special character into a <span class="application">gedit</span> file, choose <span class="guimenu">Applications &gt; Accessories &gt; Character Map</span> from the main menu bar. Next, choose <span class="guimenu">Search &gt; Find…</span> from the <span class="application">Character Map</span> menu bar, type the name of the character in the <span class="guilabel">Search</span> field and click <span class="guibutton">Next</span>. The character you sought will be highlighted in the <span class="guilabel">Character Table</span>. Double-click this highlighted character to place it in the <span class="guilabel">Text to copy</span> field and then click the <span class="guibutton">Copy</span> button. Now switch back to your document and choose <span class="guimenu">Edit &gt; Paste</span> from the <span class="application">gedit</span> menu bar.
			</p></blockquote></div><p>
			The above text includes application names; system-wide menu names and items; application-specific menu names; and buttons and text found within a GUI interface, all presented in Proportional Bold and all distinguishable by context.
		</p><p>
			Note the <span class="guimenu">&gt;</span> shorthand used to indicate traversal through a menu and its sub-menus. This is to avoid the difficult-to-follow 'Select <span class="guimenuitem">Mouse</span> from the <span class="guimenu">Preferences</span> sub-menu in the <span class="guimenu">System</span> menu of the main menu bar' approach.
		</p><p>
			<span class="command"><strong><em class="replaceable"><code>Mono-spaced Bold Italic</code></em></strong></span> or <span class="application"><em class="replaceable"><code>Proportional Bold Italic</code></em></span>
		</p><p>
			Whether Mono-spaced Bold or Proportional Bold, the addition of Italics indicates replaceable or variable text. Italics denotes text you do not input literally or displayed text that changes depending on circumstance. For example:
		</p><div class="blockquote"><blockquote class="blockquote"><p>
				To connect to a remote machine using ssh, type <span class="command"><strong>ssh <em class="replaceable"><code>username</code></em>@<em class="replaceable"><code>domain.name</code></em></strong></span> at a shell prompt. If the remote machine is <code class="filename">example.com</code> and your username on that machine is john, type <span class="command"><strong>ssh john@example.com</strong></span>.
			</p><p>
				The <span class="command"><strong>mount -o remount <em class="replaceable"><code>file-system</code></em></strong></span> command remounts the named file system. For example, to remount the <code class="filename">/home</code> file system, the command is <span class="command"><strong>mount -o remount /home</strong></span>.
			</p><p>
				To see the version of a currently installed package, use the <span class="command"><strong>rpm -q <em class="replaceable"><code>package</code></em></strong></span> command. It will return a result as follows: <span class="command"><strong><em class="replaceable"><code>package-version-release</code></em></strong></span>.
			</p></blockquote></div><p>
			Note the words in bold italics above — username, domain.name, file-system, package, version and release. Each word is a placeholder, either for text you enter when issuing a command or for text displayed by the system.
		</p><p>
			Aside from standard usage for presenting the title of a work, italics denotes the first use of a new and important term. For example:
		</p><div class="blockquote"><blockquote class="blockquote"><p>
				When the Apache HTTP Server accepts requests, it dispatches child processes or threads to handle them. This group of child processes or threads is known as a <em class="firstterm">server-pool</em>. Under Apache HTTP Server 2.0, the responsibility for creating and maintaining these server-pools has been abstracted to a group of modules called <em class="firstterm">Multi-Processing Modules</em> (<em class="firstterm">MPMs</em>). Unlike other modules, only one module from the MPM group can be loaded by the Apache HTTP Server.
			</p></blockquote></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e298"/>1.2. Pull-quote Conventions</h3></div></div></div><p>
			Two, commonly multi-line, data types are set off visually from the surrounding text.
		</p><p>
			Output sent to a terminal is set in <code class="computeroutput">Mono-spaced Roman</code> and presented thus:
		</p><pre class="screen">
books        Desktop   documentation  drafts  mss    photos   stuff  svn
books_tests  Desktop1  downloads      images  notes  scripts  svgs
</pre><p>
			Source-code listings are also set in <code class="computeroutput">Mono-spaced Roman</code> but are presented and highlighted as follows:
		</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_keyword">package</span><span class="java_plain">&nbsp;org</span><span class="java_separator">.</span><span class="java_plain">jboss</span><span class="java_separator">.</span><span class="java_plain">book</span><span class="java_separator">.</span><span class="java_plain">jca</span><span class="java_separator">.</span><span class="java_plain">ex1</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_keyword">import</span><span class="java_plain">&nbsp;javax</span><span class="java_separator">.</span><span class="java_plain">naming</span><span class="java_separator">.</span><span class="java_type">InitialContext</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">ExClient</span>
<!--  --><br/><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;main</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;args</span><span class="java_separator">[])</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">Exception</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">InitialContext</span><span class="java_plain">&nbsp;iniCtx&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">InitialContext</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Object</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ref&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;iniCtx</span><span class="java_separator">.</span><span class="java_plain">lookup</span><span class="java_separator">(</span><span class="java_literal">&quot;EchoBean&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">EchoHome</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;home&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">EchoHome</span><span class="java_separator">)</span><span class="java_plain">&nbsp;ref</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Echo</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&nbsp;&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;home</span><span class="java_separator">.</span><span class="java_plain">create</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_literal">&quot;Created&nbsp;Echo&quot;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">System</span><span class="java_separator">.</span><span class="java_plain">out</span><span class="java_separator">.</span><span class="java_plain">println</span><span class="java_separator">(</span><span class="java_literal">&quot;Echo.echo('Hello')&nbsp;=&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;echo</span><span class="java_separator">.</span><span class="java_plain">echo</span><span class="java_separator">(</span><span class="java_literal">&quot;Hello&quot;</span><span class="java_separator">));</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_separator">}</span>
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e317"/>1.3. Notes and Warnings</h3></div></div></div><p>
			Finally, we use three visual styles to draw attention to information that might otherwise be overlooked.
		</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>
				A note is a tip or shortcut or alternative approach to the task at hand. Ignoring a note should have no negative consequences, but you might miss out on a trick that makes your life easier.
			</p></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2><p>
				Important boxes detail things that are easily missed: configuration changes that only apply to the current session, or services that need restarting before an update will apply. Ignoring Important boxes won't cause data loss but may cause irritation and frustration.
			</p></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Warning</h2><p>
				A Warning should not be ignored. Ignoring warnings will most likely cause data loss.
			</p></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="ittsss-Introduction_to_the_SIP_Servlets_Server"/>Chapter 1. Introduction</h1></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d0e342">1.1. Overview of Mobicents SIP Servlets within the Telecommunications Industry</a></span></dt><dt><span class="section"><a href="#d0e360">1.2. Overview of SIP Servlets Server</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="d0e342"/>1.1. Overview of Mobicents SIP Servlets within the Telecommunications Industry</h2></div></div></div><p>

The <a class="ulink" href="http://www.mobicents.org/"> Mobicents Communication Platform </a> is the best architecture to create, deploy and manage services and applications integrating voice, video and data across a range of IP and legacy communications networks. It drives convergence with the following key enablers:
</p><p>
            </p><div class="figure"><a id="d0e352"/><p class="title"><strong>Figure 1.1. Mobicents Architecture Overview</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/mobicents_intro_architecture.png" alt="Mobicents Architecture Overview"/></div></div></div><p><br class="figure-break"/>

</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="d0e360"/>1.2. Overview of SIP Servlets Server</h2></div></div></div><p>

Mobicents SIP Servlets is a modern communications middleware platform. Mobicents SIP Servlets facilitates the shift towards Cloud Communications by enabling deployment and autoscaling of real time SIP Servlets apps across all major IaaS (Infrastructure as a Service) providers and also brings realtime communications (voice and video) to your Browser using HTML5 <a class="ulink" href="http://www.webrtc.org/">WebRTC </a> and SIP Over WebSockets !

</p><p>
The <a class="ulink" href=" http://code.google.com/p/sipservlets/wiki/HTML5WebRTCVideoApplication"> Mobicents HTML5 WebRTC Client </a>allows you to make video calls from and to any Web Browser supporting <a class="ulink" href="http://www.webrtc.org/">WebRTC </a> , (only Google Chrome supports it so far but all major browsers should support it in the next 6 months) as well as SIP Endpoints.
</p><p>
Mobicents SIP Servlets enables turnkey SaaS offerings such as <a class="ulink" href="http://www.restcomm.org/"> RestComm </a>.
</p><p>
Mobicents SIP Servlets implements the latest SIP Servlet v1.1 (JSR 289) standard. It can be plugged into any Application Server container (currently 7.X and JBoss 7.X) and also offers High Availability and Failover.
</p><p>
Mobicents SIP Servlets is lead by <a class="ulink" href="http://www.telestax.com/">TeleStax, Inc </a>. and developed collaboratively by a community of individual and enterprise contributors. 

</p><p>
            </p><div class="figure"><a id="d0e390"/><p class="title"><strong>Figure 1.2. Mobicents WebRTC SIP Stack</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/mss_webrtc_stack.png" alt="Mobicents WebRTC SIP Stack"/></div></div></div><p><br class="figure-break"/>

</p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="sssicar-SIP_Servlets_Server-Installing_Configuring_and_Running"/>Chapter 2. SIP Servlets Server-Installing, Configuring and Running</h1></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#getting-started-with-MSS-JBOSS-AS7">2.1. Getting Started with MSS for JBoss AS7 </a></span></dt><dd><dl><dt><span class="section"><a href="#d0e418">2.1.1. 
Downloading and Starting MSS for JBoss AS7
</a></span></dt><dt><span class="section"><a href="#d0e489">2.1.2. Testing Click2Call with MSS for JBOSS AS7 </a></span></dt><dt><span class="section"><a href="#d0e523">2.1.3.  Command Line Interface for MSS JBoss AS7</a></span></dt><dt><span class="section"><a href="#d0e580">2.1.4. Accessing Management Console </a></span></dt></dl></dd><dt><span class="section"><a href="#getting-started-with-MSS-Tomcat-AS7">2.2. Getting Started with MSS for Tomcat 7  </a></span></dt><dd><dl><dt><span class="section"><a href="#d0e734">2.2.1. Testing Click2CallAsync with MSS for Tomcat 7 </a></span></dt><dt><span class="section"><a href="#bssswticar-SIP_Servlets_Server_with_Tomcat-Installing_Configuring_and_Running">2.2.2. Tomcat for Windows </a></span></dt></dl></dd><dt><span class="section"><a href="#bsssc-binary-SIP_Servlets_Server-Configuring">2.3.  Sip Connectors </a></span></dt><dd><dl><dt><span class="section"><a href="#bsssc-binary-SIP_Servlets_Server-Adding_SIP_Connectors">2.3.1. Configuring SIP Connectors and Bindings</a></span></dt><dt><span class="section"><a href="#bsssc-binary-SIP_Servlets_Server-Configuring_Application_Routing">2.3.2. Application Routing and Service Configuration</a></span></dt><dt><span class="section"><a href="#bsssc-binary-SIP_Servlets_Server-Configuring_Logging">2.3.3. SIP Servlets Server Logging</a></span></dt></dl></dd></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="getting-started-with-MSS-JBOSS-AS7"/>2.1. Getting Started with MSS for JBoss AS7 </h2></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2> Features not yet available on MSS for JBoss AS7 </h2><p> * SIP Clustering and Failover  </p><p> * SNMP  </p><p> * Jopr Monitoring  </p></div><p>
Some of the features mentioned above will likely be added in the future. As of the time of this writing, they are not available. Even though Jopr monitoring is not available, there is a Command Line Interface (CLI), which will be discussed further down. As the features become available, this guide will be updated to reflect the changes. 
</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e418"/>2.1.1. 
Downloading and Starting MSS for JBoss AS7
</h3></div></div></div><p>
If you have been working with JBoss for some time, you will quickly notice that the JBoss AS7 iteration has gone through a lot of changes. This guide will help you understand how you can quickly get started with JBoss AS7 within the MSS framework.
</p><p>

You can go to the link below to download the latest MSS for JBoss AS7: <a class="ulink" href=" https://code.google.com/p/sipservlets/wiki/Downloads?tm=2">Download Latest Version of MSS for JBoss AS7 </a>
</p><p>
You will need to extract the content of the file into a directory on your local system. The root directory of the MSS for JBoss AS7 that you downloaded will be referred to in this guide as $JBOSS_HOME.  
</p><p>
If this is your first time working with MSS for JBoss, you will need to make sure you have Java Run Time or JDK installed on your computer. You will also need to have the environment variables set.  See the links below to  learn how to get JRE or JDK setup on your system. 
</p><p>
Installing and Configuring JDK
</p><p> <a class="xref" href="#install-configure-JDK" title="10.1. Java Development Kit (JDK): Installing, Configuring and Running">Section 10.1, “Java Development Kit (<acronym class="acronym">JDK</acronym>): Installing, Configuring and Running”</a></p><p>
Setting Environment Variables
</p><p> <a class="xref" href="#setting-jboss-ENV-variable-windows-unix" title="10.1.8. Setting the JBOSS_HOME Environment Variable">Section 10.1.8, “Setting the JBOSS_HOME Environment Variable”</a></p><p><strong> Starting MSS for JBoss AS7 . </strong>
To start the server do the following:
</p><pre class="screen">
$JBOSS_HOME/bin/standalone.sh
</pre><p>
During the startup process, you will notice that the final part of the log output will be similar to the truncated output below. Notice that the Admin Console interface can be accessed at <a class="ulink" href="http://172.0.0.1:9990">http://172.0.0.1:9990</a>. This will be explained later. 
</p><pre class="screen">
14:28:43,972 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015951: Admin console listening on http://127.0.0.1:9990
14:28:43,974 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015874: JBoss AS 7.1.2.Final "Steropes" 
started in 22148ms - Started 222 of 306 services (83 services are passive or on-demand)

</pre><p>
You will notice that the startup is very fast. The reason for this is that JBoss was rewritten from the ground up for speed with services being started concurrently and non critical services remain passive until first use. This provides better system resource management. With the simple startup above, you will be able to enter the default web interface of the application server by going to this url http://127.0.0.1:8080. The result will show a screenshot similar to the one below.
</p><p>
            </p><div class="figure"><a id="d0e459"/><p class="title"><strong>Figure 2.1. JBoss Application Server 7 Welcome Page</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/welcome-page-Mss-JBoss-AS7.png" alt="JBoss Application Server 7 Welcome Page"/></div></div></div><p><br class="figure-break"/>

</p><p>
With the standard startup script, you will not have access to any SIP functionalities. This is because of the modular approach implemented in JBoss AS7. There is a configuration file that needs to be used to activate additional functionalities like SIP and High Availability.
</p><p>
In order to start the MSS for JBoss AS7 with SIP functionalities, you need to append the startup script with the SIP configuration file. The configuration files are located in the $JBOSS_HOME/standalone/configuration directory. You can see the content of the directory below
</p><pre class="screen">
application-roles.properties  mgmt-users.properties     standalone-ha.xml
application-users.properties  mss-sip-stack.properties  standalone-sip.xml
dars                          standalone-full-ha.xml    standalone.xml
logging.properties            standalone-full.xml       standalone_xml_history
</pre><p><strong>Starting MSS for JBoss AS7 with SIP. </strong></p><p>
If you want to start MSS with SIP services activated, you need to go to the $JBOSS_HOME/bin directory. Type the following command:
</p><pre class="screen">
./standalone.sh -c standalone-sip.xml
</pre><p><strong> You will see a message similar to the one below once the server is successfully started. </strong></p><pre class="screen">
20:43:21,487 INFO  [org.jboss.as.server] (ServerService Thread Pool -- 37) JBAS018559: Deployed "click2call.war"
20:43:21,489 INFO  [org.jboss.as.server] (ServerService Thread Pool -- 37) JBAS018559: Deployed "sip-servlets-management.war"
20:43:21,647 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015951: Admin console listening on http://127.0.0.1:9990
20:43:21,648 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015874: JBoss AS 7.1.2.Final "Steropes" started in 26560ms - Started 232 of 321 services (88 services are passive or on-demand)
</pre><p>
The click2call SIP sample application bundled with MSS will become available at this url <a class="ulink" href="http://127.0.0.1:8080/click2call">http://127.0.0.1:8080/click2call</a>. You can configure multiple SIP softphones to use the sample application. See the section below for how to configure and test the SIP sample application.
</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e489"/>2.1.2. Testing Click2Call with MSS for JBOSS AS7 </h3></div></div></div><p>
Once the server is started as stated in the previous section, you can configure multiple instances of any SIP softphone you prefer. In this example, Linphone will be used.
</p><pre class="screen">
(configuring two instances of Linphone)

start Linphone 
go to the Options menu

On the Network Settings tab, 
	SIP (UDP) port to 5061. (leave the rest as default)
On the Manage SIP Accounts tab, 
	click the add button
	Your SIP identity: = sip:linphone@127.0.0.1:5080
	SIP Proxy address: = sip 127.0.0.1:5080

Leave the rest of the settings as default.
	

Configuring Linphone (on the second shell)

go to the Options menu

On the Network Settings tab, 
	SIP (UDP) port to 5062. (leave the rest as default)
On the Manage SIP Accounts tab, 
	click the add button
	Your SIP identity: = sip:linphone2@127.0.0.1:5080
	SIP Proxy address: = sip 127.0.0.1:5080

Leave the rest of the settings as default.
</pre><p>
A correctly configured Linphone will look like the screenshot below.
</p><p>
            </p><div class="figure"><a id="d0e500"/><p class="title"><strong>Figure 2.2. Successfully Configured Linphone</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/linphone-registration-port-5080.png" alt="Successfully Configured Linphone"/></div></div></div><p><br class="figure-break"/>

</p><p>
Once the phones are successfully registered with the MSS for JBoss AS7 server, you can check the result in the sample SIP application at this url, <a class="ulink" href="http://127.0.0.1:8080/click2call">http://127.0.0.1:8080/click2call</a>
</p><p>
            </p><div class="figure"><a id="d0e514"/><p class="title"><strong>Figure 2.3. Click2call SIP Registered Softphones</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/click2call-JbossAS7-registered-clients.png" alt="Click2call SIP Registered Softphones"/></div></div></div><p><br class="figure-break"/>

</p><p>
You can make calls from the sample click2call application and see the logs in the shell terminal you used to start the MSS for JBoss AS7 server. 
</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e523"/>2.1.3.  Command Line Interface for MSS JBoss AS7</h3></div></div></div><p>
Part of the task of any administrator who has to manage a JBoss server will be to monitor services offered to clients. There is a command line interface bundled with JBoss AS7 which can be accessed by going to the $JBOSS_HOME/bin directory. 

</p><p> You need to make sure that the JBoss server is running on your system and listening on port 9999. The section below will work you through steps to familiarize yourself with the CLI. 
</p><p>
There are so many features available with the MSS for JBoss AS7 CLI. The example below will concentrate on getting data from the SIP you started using the <code class="filename"> ./standalone.sh -c standalone-sip.xml </code> script. 
</p><p>
In the $JBOSS_HOME/bin directory, type

</p><pre class="screen">
./jboss-cli.sh 
</pre><p>
(This will show the message below)
</p><pre class="screen">
You are disconnected at the moment. 
Type 'connect' to connect to the server or 
'help' for the list of supported commands.
</pre><p>
At the [disconnected /] command  prompt, type 
</p><pre class="screen">
connect
</pre><p>
When you see the [standalone@localhost:9999 /] at the prompt, you are successfully connected to the server.
</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Navigating the CLI </h2><p>Moving around the MSS for JBoss AS7 CLI is similar to normal file system with a few exceptions. You can use commands like, (ls, cd, cd..) to navigate around the CLI
</p></div><p>
Follow the steps below to access SIP information from the CLI
</p><pre class="screen">
At the prompt type (ls)

[standalone@localhost:9999 /] ls
core-service                  deployment                    extension
interface                     path                          socket-binding-group
subsystem                     system-property               launch-type=STANDALONE
management-major-version=1    management-minor-version=2    name=linux-fedora
namespaces=[]                 process-type=Server           product-name=undefined
product-version=undefined     profile-name=undefined        release-codename=Steropes
release-version=7.1.2.Final   running-mode=NORMAL           schema-locations=[]
server-state=running

[standalone@localhost:9999 /] cd deployment

[standalone@localhost:9999 deployment] ls
click2call.war                sip-servlets-management.war

[standalone@localhost:9999 deployment] cd click2call.war

[standalone@localhost:9999 deployment=click2call.war] ls
subdeployment
subsystem
content=[{"path" =&gt; "deployments/click2call.war","relative-to" =&gt; "jboss.server.base.dir","archive" =&gt; true}]
enabled=true
name=click2call.war
persistent=false
runtime-name=click2call.war
status=OK

[standalone@localhost:9999 deployment=click2call.war] cd subsystem 

[standalone@localhost:9999 subsystem] ls
sip   web

[standalone@localhost:9999 subsystem] cd sip


[standalone@localhost:9999 subsystem=sip] ls
servlet
active-sip-application-sessions=7
active-sip-sessions=8
app-name=org.mobicents.servlet.sip.example.SimpleApplication
expired-sip-application-sessions=25
expired-sip-sessions=26
max-active-sip-sessions=-1
rejected-sip-application-sessions=0
rejected-sip-sessions=0
sip-application-session-avg-alive-time=180
sip-application-session-max-alive-time=230
sip-application-sessions-created=32
sip-application-sessions-per-sec=0.0
sip-session-avg-alive-time=162
sip-session-max-alive-time=180
sip-sessions-created=34
sip-sessions-per-sec=0.0


</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>No SIP data on the CLI </h2><p>
The data from the SIP subsystem are only available if you have the click2call 
sample application running and your softphones are connected to the server. 
</p></div><p><strong> SIP Servlets Management Console . </strong></p><p>
There is also a SIP servlets management console that is available at this url  <a class="ulink" href="http://127.0.0.1:8080/sip-servlets-management">http://127.0.0.1:8080/sip-servlets-management</a>. The resulting page will be similar to the screenshot below. More information will be provided about the SIP servlets management console in later chapters of this guide. 
</p><p>
            </p><div class="figure"><a id="d0e573"/><p class="title"><strong>Figure 2.4. JBoss Application Server 7 Management Console</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/sip-servlets-management-console-AS7.png" alt="JBoss Application Server 7 Management Console"/></div></div></div><p><br class="figure-break"/>

</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e580"/>2.1.4. Accessing Management Console </h3></div></div></div><p>
MSS for JBoss AS7 provides a management console that can be useful for accessing vital information about your server. In the welcome page that appears when you access <a class="ulink" href="http://127.0.0.1:8080">http://127.0.0.1:8080</a>, there is a link that points to  the Administration Console. 
</p><p>
If you don't have a user account for the management console, you will see a screenshot like the one below. It contains instructions about how to create a user account.
</p><p>
            </p><div class="figure"><a id="d0e592"/><p class="title"><strong>Figure 2.5. Administration Console Error Page</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/admin-console-error-page.png" alt="Administration Console Error Page"/></div></div></div><p><br class="figure-break"/>

</p><p><strong> Creating a User Account. </strong></p><p>
Go to the $JBoss_HOME/bin directory and run the ./add-user.sh script. You can follow the interactive user mode to create an account for the Administration Console. 
</p><p>
Once the user account has been created, you can access the Administration Console at this address <a class="ulink" href="http://127.0.0.1:9990/console/">http://127.0.0.1:9990/console/</a>
</p><p>
The screenshot below shows you what the Administration Console looks like.
</p><p>
            </p><div class="figure"><a id="d0e613"/><p class="title"><strong>Figure 2.6. Administration Console </strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/admin-console-AS7-homepage.png" alt="Administration Console"/></div></div></div><p><br class="figure-break"/>

</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2> Deleting Administration Console User Account</h2><p>
Deleting the user account isn't very intuitive. In the event that you will need to remove an account and create another one, you can remove the account from the mgmt-users.properties file. It is located in the $MSS_JBoss_HOME/standalone/configuration directory. If you are running in the domain mode, you will need to check the corresponding configuration directory. 
</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e625"/>2.1.4.1. Installing the MSS for JBoss Binary Distribution on <span class="productname">Windows</span>™</h4></div></div></div><div class="procedure"><p>For this procedure, it is assumed that the downloaded archive is saved in the <code class="filename">My Downloads</code> folder.</p><ol class="procedure" type="1"><li class="step"><p>Create a directory in <code class="filename">My Downloads</code> to extract the zip file's contents into.  For ease of identification, it is recommended that the version number of the binary is included in the folder name.  For example, <code class="filename">MSS-jboss-&lt;version&gt;</code>.</p></li><li class="step"><p>Extract the contents of the archive, specifying the destination folder as the one created in the previous step. You can either use Winzip or the opensource tool called 7-Zip to extract the content of the donwloaded MSS for JBoss AS7 file </p></li><li class="step"><p>It is recommended that the folder holding the MSS for JBoss files (in this example, the folder named <code class="filename">mss-jboss-<em class="replaceable"><code>&lt;version&gt;</code></em></code>) is moved to a user-defined location for storing executable programs.  For example, the <code class="filename">Program Files</code> folder.</p></li></ol></div><div class="procedure"><a id="d0e662"/><p class="title"><strong>Procedure 2.1. Running MSS for JBoss on <span class="productname">Windows</span>™</strong></p><p>There are several ways to start MSS for JBoss on Windows. All of the following methods accomplish the same task.</p><ol class="procedure" type="1"><li class="step"><p>Using Windows Explorer, navigate to the <code class="filename">bin</code> subdirectory in the installation directory.</p></li><li class="step"><p>The preferred way to start MSS for JBoss from the Command Prompt.  The command line interface displays details of the startup process, including any problems encountered during the startup process.</p><p>Open the Command Prompt via the <span class="guilabel">Start</span> menu and navigate to the correct folder:</p><pre class="screen">C:\Users\&lt;user&gt;My Downloads&gt; cd "mss-jboss-&lt;version&gt;"</pre></li><li class="step"><p>Start the JBoss Application Server by executing one of the following files:
        </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="filename">run.bat</code> batch file:</p><pre class="screen">C:\Users\&lt;user&gt;My Downloads\mss-jboss-&lt;version&gt;&gt;bin\run.bat</pre></li><li class="listitem"><p><code class="filename">run.jar</code> executable Java archive:</p><pre class="screen">C:\Users\&lt;user&gt;My Downloads\mss-jboss-&lt;version&gt;&gt;java -jar bin\run.jar</pre></li></ul></div><p>
        </p></li></ol></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="getting-started-with-MSS-Tomcat-AS7"/>2.2. Getting Started with MSS for Tomcat 7  </h2></div></div></div><p>
You can download the latest MSS for Tomcat 7  <a class="ulink" href=" https://code.google.com/p/sipservlets/wiki/Downloads?tm=2">Download Latest Version of MSS for Tomcat 7 </a>
</p><p>
The content of the downloaded file can be extracted to any location you prefer on your computer. The root directory to which the content of the download is extracted will be referred to as $CATALINA_HOME. 
</p><p>
The content of the $CATALINA_HOME/bin is similar to the output below.
</p><pre class="screen">
bootstrap.jar                 cpappend.bat      startup.bat
catalina.bat                  daemon.sh         startup.sh
catalina.sh                   digest.bat        tomcat-juli.jar
catalina-tasks.xml            digest.sh         tomcat-native.tar.gz
commons-daemon.jar            setclasspath.bat  tool-wrapper.bat
commons-daemon-native.tar.gz  setclasspath.sh   tool-wrapper.sh
configtest.bat                shutdown.bat      version.bat
configtest.sh                 shutdown.sh       version.sh

</pre><p>

You can start MSS for Tomcat 7 by going to $CATALINA_HOME/bin directory and typing the following: 
</p><pre class="screen">
sudo ./catalina.sh run 
</pre><p>
The startup process is slightly different from MSS for JBoss AS7. If you see an output like the one below, you know that Tomcat is correctly started. This is a truncated log from the startup process.
</p><pre class="screen">

2012-08-21 22:23:41,025 INFO  [SipApplicationDispatcherImpl] (main) SipApplicationDispatcher Started
2012-08-21 22:23:41,025 INFO  [SipStandardService] (main) SIP Standard Service Started.
Aug 21, 2012 10:23:41 PM org.apache.catalina.startup.Catalina start
INFO: Server startup in 3608 ms


</pre><p>
If you get an error message about environment variables or Java, make sure you have the CATALINA environment variables set. 
</p><p>
Setting Environment Variables - JAVA and CATALINA
</p><p> <a class="xref" href="#setting-CATALINA_HOME-ENV-linux-windows" title="10.1.9. Setting CATALINA_HOME on Linux and Windows">Section 10.1.9, “Setting CATALINA_HOME on Linux and Windows”</a></p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e734"/>2.2.1. Testing Click2CallAsync with MSS for Tomcat 7 </h3></div></div></div><p>
If MSS for Tomcat 7 is started and running, you should be able to use your web browser to access the welcome page at this url <a class="ulink" href="http://127.0.0.1:8080/">http://127.0.0.1:8080/</a> This will show you a screenshot similar to the one below.
</p><p>
            </p><div class="figure"><a id="d0e744"/><p class="title"><strong>Figure 2.7. JBoss Application Server 7 Welcome Page</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/welcome-page-MSS-Tomcat-7.png" alt="JBoss Application Server 7 Welcome Page"/></div></div></div><p><br class="figure-break"/>

</p><p>
Deploying your application once the server is running is simple. You need to copy your .War files to the  $CATALINA_HOME/webapps directory.
</p><p>
 There is a pre-installed sample SIP application that you can use to test your MSS Tomcat 7 configuration. The application is also located in the $CATALINA_HOME/webapps directory
</p><p>
Start your web browser and go to the link, <a class="ulink" href="http://127.0.0.1:8080/Click2CallAsync/">http://127.0.0.1:8080/Click2CallAsync/</a>
</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2> Sample Application Name</h2><p>
Note that the application name is case-sensitive and will not work if you try to access it as <a class="ulink" href="http://127.0.0.1:8080/click2callasync/">http://127.0.0.1:8080/click2callasync/</a>
</p></div><p>
The sample SIP application page will be similar to the screenshot below. 
</p><p>
            </p><div class="figure"><a id="d0e772"/><p class="title"><strong>Figure 2.8. SIP Sample Click2CallAsync Application</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/click2call-tomcat-AS7-application.png" alt="SIP Sample Click2CallAsync Application"/></div></div></div><p><br class="figure-break"/>

</p><p>

In order to use the application, you can download a softphone and start multiple instances of the phone on a single server. In this guide, the softphone that will be used is Linphone. The configuration is as follows:
</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2> Multiple Instances of Linphone</h2><p>
On some Linux systems, you might need to use a different user profile in order to start a second instance of Linphone. Ex. sudo linphone
</p></div><pre class="screen">
(configuring two instances of Linphone)

start Linphone 
go to the Options menu

On the Network Settings tab, 
        SIP (UDP) port to 5061. (leave the rest as default)
On the Manage SIP Accounts tab, 
        click the add button
        Your SIP identity: = sip:linphone@127.0.0.1:5080
        SIP Proxy address: = sip 127.0.0.1:5080

Leave the rest of the settings as default.
        

Configuring Linphone (on the second shell)

go to the Options menu

On the Network Settings tab, 
        SIP (UDP) port to 5062. (leave the rest as default)
On the Manage SIP Accounts tab, 
        click the add button
        Your SIP identity: = sip:linphone2@127.0.0.1:5080
        SIP Proxy address: = sip 127.0.0.1:5080

Leave the rest of the settings as default.
</pre><p>
Once the softphones are configured and are successfully registered with the MSS for Tomcat 7 server, you will see a screenshot like the one below in the web browser at this url <a class="ulink" href="http://127.0.0.1:8080/Click2CallAsync/">http://127.0.0.1:8080/Click2CallAsync/</a>
</p><p>
            </p><div class="figure"><a id="d0e795"/><p class="title"><strong>Figure 2.9. SIP Click2CallAsync with Registers Clients</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/click2callasync-tomcat-registered-clients.png" alt="SIP Click2CallAsync with Registers Clients"/></div></div></div><p><br class="figure-break"/>

</p><p>
You can make calls using the application and the softphones you configured will start ringing. It is important to start MSS for Tomcat 7 in a terminal using the (./catalina.sh run) script. It will help with troubleshooting SIP calls. The logs you see on the terminal will let you know when a softphone registers with the Tomcat server and you will also be able to see the status of call setup and shutdown.
</p><p><strong>Stopping MSS for Tomcat 7 . </strong></p><p>
The best way to stop a server is using the CTRL-D on the terminal in which the server was started. If you started the MSS for Tomcat 7 server using the $CATALINA_HOME/bin/startup.sh, you can stop the server using $CATALINA_HOME/bin/shutdown.sh
</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="bssswticar-SIP_Servlets_Server_with_Tomcat-Installing_Configuring_and_Running"/>2.2.2. Tomcat for Windows </h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e817"/>2.2.2.1. Installing the MSS for Tomcat 7 Binary Distribution on Windows</h4></div></div></div><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>For this example, we'll assume that you downloaded the binary distribution zip file to the <code class="filename">My Downloads</code> folder. First, using Windows Explorer, create a subdirectory in <code class="filename">My Downloads</code> to extract the zip file's contents into. When you name this folder, it is good practice to include the version number; if you do so, remember to correctly match it with the version of the MSS for Tomcat binary distribution you downloaded. In these instructions, we will refer to this folder as <code class="filename">mss-tomcat-<em class="replaceable"><code>&lt;version&gt;</code></em></code>.</p></li><li class="step"><p>Double-click the downloaded zip file, selecting as the destination folder the one you just created to hold the zip file's contents.</p><ul class="stepalternatives">
          <li class="step"><p>Alternatively, it is also possible to use Java's <span class="command"><strong>jar <code class="option">-xvf</code></strong></span> command to extract the binary distribution files from the zip archive. To use this method instead, first move the downloaded zip file from <code class="filename">My Downloads</code> to the folder that you just created to hold the SIP Servlets Server files.</p></li>
          <li class="step"><p>Then, open the Windows Command Prompt and navigate to the folder holding the archive using the <span class="command"><strong>cd</strong></span> command.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><a id="bssswticar-binary-SIP_Servlets_Server_with_Tomcat-Opening_the_Command_Prompt_from_Windows_Explorer"/><h2>Opening the Command Prompt from Windows Explorer</h2><p>If you are using Windows Vista®, you can open the Command Prompt directly from Explorer. Hold down the <span class="keycap"><strong>Shift</strong></span> key and right-click on either a folder, the desktop, or inside a folder. This will cause an <span class="guimenuitem">Open Command Window Here</span> context menu item to appear, which can be used to open the Command Prompt with the current working directory set to either the folder you opened, or opened it from.</p></div></li>
          <li class="step"><p>Finally, use the <span class="command"><strong>jar <code class="option">-xvf</code></strong></span> command to extract the archive contents into the current folder.</p><pre class="screen">C:\Users\Me\My Downloads\mss-tomcat-&lt;version&gt;&gt;jar -xvf "mss-1.6.0.FINAL-apache-tomcat-6.0.20-1007051527.zip"</pre></li>
        </ul></li><li class="step"><p>At this point, you may want to move the folder holding the MSS for Tomcat binary files (in this example, the folder named <code class="filename">mss-tomcat-<em class="replaceable"><code>&lt;version&gt;</code></em></code>) to another location. This step is not strictly necessary, but it is probably a good idea to move the installation folder from <code class="filename">My Downloads</code> to a user-defined location for storing runnable programs. Any location will suffice, however.</p></li><li class="step"><p>You may want to delete the zip file after extracting its contents in order to free disk space:</p><pre class="screen">C:\Users\Me\My Downloads\mss-tomcat-&lt;version&gt;&gt;delete "mss-1.6.0.FINAL-apache-tomcat-6.0.20-1007051527.zip"</pre></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="bssswticar-binary-SIP_Servlets_Server_with_Tomcat-Configuring"/>2.2.2.2. Configuring</h4></div></div></div><p>Configuring MSS for Tomcat consists in setting the <code class="envar">CATALINA_HOME</code> environment variable and then, optionally, customizing your MSS for Tomcat container by adding SIP Connectors, configuring the application router, and configuring logging. See <a class="xref" href="#bsssc-binary-SIP_Servlets_Server-Configuring" title="2.3.  Sip Connectors">Section 2.3, “ Sip Connectors ”</a> to learn what and how to configure MSS for Tomcat.</p><p>Alternatively, you can simply run your MSS for Tomcat container now and return to this section to configure it later.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="bssswticar-binary-SIP_Servlets_Server_with_Tomcat-Running"/>2.2.2.3. Running</h4></div></div></div><p>Once installed, you can run the Tomcat Servlet Container by executing the one of the startup scripts in the <code class="filename">bin</code> directory (on Linux or Windows), or by double-clicking the <code class="filename">run.bat</code> executable batch file in that same directory (on Windows only). However, we suggest always starting Tomcat using the terminal or Command Prompt because you are then able to read—and act upon—any startup messages, and possibly debug any problems that may arise. In the Linux terminal or Command Prompt, you will be able to tell that the container started successfully if the last line of output is similar to the following:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Using CATALINA_BASE:   /home/user/temp/apps/sip_servlets_server/
Using CATALINA_HOME:   /home/user/temp/apps/sip_servlets_server/
Using CATALINA_TMPDIR: /home/user/temp/apps/sip_servlets_server/temp
Using JRE_HOME:       /etc/java-config-2/current-system-vm</pre><p>Detailed instructions are given below, arranged by platform.</p><div class="procedure"><a id="d0e927"/><p class="title"><strong>Procedure 2.2. Running MSS for Tomcat on Windows</strong></p><ol class="procedure" type="1"><li class="step"><p>There are several different ways to start the Tomcat Servlet Container on Windows. All of the following methods accomplish the same task.</p><p>Using Windows Explorer, change your folder to the one in which you unzipped the downloaded zip file, and then to the <code class="filename">bin</code> subdirectory.</p></li><li class="step"><p>Although not the preferred way (see below), it is possible to start the Tomcat Servlet Container by double-clicking on the <code class="filename">startup.bat</code> executable batch file.</p><ul class="stepalternatives">
          <li class="step"><p>As mentioned above, the best way to start the Tomcat Servlet Container is by using the Command Prompt. Doing it this way will allow you to view all of the server startup details, which will enable you to easily determine whether any problems were encountered during the startup process. You can open the Command Prompt directly from the <code class="filename">&lt;topmost_directory&gt;\bin</code> folder in Windows Explorer, or you can open the Command Prompt via the <span class="guilabel">Start</span> menu and navigate to the correct folder:</p><pre class="screen">C:\Users\Me\My Downloads&gt; cd "mss-tomcat-&lt;version&gt;"</pre></li>
          <li class="step"><p>Start the Tomcat Servlet Container by running the executable <code class="filename">startup.bat</code> batch file:</p><pre class="screen">C:\Users\Me\My Downloads\mss-tomcat-&lt;version&gt;&gt;bin\startup.bat</pre></li>
        </ul></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="bssswticar-binary-SIP_Servlets_Server_with_Tomcat-Stopping"/>2.2.2.4. Stopping</h4></div></div></div><p>Detailed instructions for stopping the Tomcat Servlet Container are given below, arranged by platform. Note that if you properly stop the server, you will see the following three lines as the last output in the Linux terminal or Command Prompt (both running and stopping the Tomcat Servlet Container produces the same output):</p><pre class="screen">Using CATALINA_BASE:   /home/user/temp/apps/sip_servlets_server
Using CATALINA_HOME:   /home/user/temp/apps/sip_servlets_server
Using CATALINA_TMPDIR: /home/user/temp/apps/sip_servlets_server/temp
Using JRE_HOME:       /etc/java-config-2/current-system-vm</pre><div class="procedure"><a id="d0e977"/><p class="title"><strong>Procedure 2.3. Stopping MSS for Tomcat on Windows</strong></p><ul class="procedure"><li class="step"><p>Stopping the Tomcat Servlet Container on Windows consists in executing the <code class="filename">shutdown.bat</code> executable batch script in the <code class="filename">bin</code> subdirectory of the SIP Servlets-customized Tomcat binary distribution:</p><pre class="screen">C:\Users\Me\My Downloads\mss-tomcat-&lt;version&gt;&gt;bin\shutdown.bat</pre></li></ul></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="bsssc-binary-SIP_Servlets_Server-Configuring"/>2.3.  Sip Connectors </h2></div></div></div><p>
Mobicents comes with default settings that are designed to get your system up and running without the need to know about all the detailed configurations. That said, there are situations in which you might like to fine-tune your setttings to adapt it to your needs. That is what the following section will help you achieve. You will get a better understand of SIP connectors and how to make them work for you.
</p><p> </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="bsssc-binary-SIP_Servlets_Server-Adding_SIP_Connectors"/>2.3.1. Configuring SIP Connectors and Bindings</h3></div></div></div><p>

There are two important configuration files that you might need to modifying depending on your system needs. The standalone-sip.xml file in MSS for JBoss AS7 and the server.xml file in MSS for Tomcat. The extracts below will give you a snapshot of default configurations.
</p><p><strong> For JBoss. </strong></p><p>
Changing the ports and other configuration for the SIP connector can be done in the standalone-sip.xml file. Below is an extract.
</p><div class="example"><a id="d0e1012"/><p class="title"><strong>Example 2.1. Adding a SIP Connector to $JBOSS_HOME/standalone/configuration/standalone-sip.xml</strong></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

 &lt;socket-binding-group name="standard-sockets" default-interface="public" port-offset="${jboss.socket.binding.port-offset:0}"&gt;
        &lt;socket-binding name="management-native" interface="management" port="${jboss.management.native.port:9999}"/&gt;
        &lt;socket-binding name="management-http" interface="management" port="${jboss.management.http.port:9990}"/&gt;
        &lt;socket-binding name="management-https" interface="management" port="${jboss.management.https.port:9443}"/&gt;
        &lt;socket-binding name="ajp" port="8009"/&gt;
        &lt;socket-binding name="http" port="8080"/&gt;
        &lt;socket-binding name="https" port="8443"/&gt;
        &lt;socket-binding name="sip-udp" port="5080"/&gt;
        &lt;socket-binding name="sip-tcp" port="5080"/&gt;
        &lt;socket-binding name="sip-tls" port="5081"/&gt;
        &lt;socket-binding name="osgi-http" interface="management" port="8090"/&gt;
        &lt;socket-binding name="remoting" port="4447"/&gt;
        &lt;socket-binding name="txn-recovery-environment" port="4712"/&gt;
        &lt;socket-binding name="txn-status-manager" port="4713"/&gt;
        &lt;outbound-socket-binding name="mail-smtp"&gt;
            &lt;remote-destination host="localhost" port="25"/&gt;
        &lt;/outbound-socket-binding&gt;
    &lt;/socket-binding-group&gt;

</pre></div></div><br class="example-break"/><p><strong> For Tomcat. </strong></p><p>
Changing the ports and other configuration for the SIP connector can be done in the server.xml file. Below is an extract.
</p><div class="example"><a id="d0e1023"/><p class="title"><strong>Example 2.2. Adding a SIP Connector to $CATALINA_HOME/conf/server.xml</strong></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
  &lt;Connector port="5080" 
ipAddress="127.0.0.1"
 protocol="org.mobicents.servlet.sip.startup.SipProtocolHandler"
 signalingTransport="udp"
 useStun="false"
 stunServerAddress="stun01.sipphone.com"
 stunServerPort="3478"
 staticServerAddress="122.122.122.122" 
 staticServerPort="44"
 useStaticAddress="true"
 httpFollowsSip="false"/&gt;</pre></div></div><br class="example-break"/><div class="variablelist"><p class="title"><strong>SIP &lt;connector&gt; Attributes</strong></p><dl class="variablelist"><dt><span class="term">port</span></dt><dd><p>The port number on which the container will be able to receive SIP messages.</p></dd><dt><span class="term">ipAddress</span></dt><dd><p>The IP address at which the container will be able to receive SIP messages. The container can be configured to listen to all available IP addresses by setting <em class="parameter"><code>ipAddress</code></em> to <strong class="userinput"><code>0.0.0.0 &lt;sipPathName&gt;</code></strong>.</p></dd><dt><span class="term">protocol</span></dt><dd><p>Specifies the connector is a SIP Connector and not an HTTP Connector. There is no need to change this property.</p></dd><dt><span class="term">signalingTransport</span></dt><dd><p>Specifies the transport on which the container will be able to receive SIP messages. For example, "udp".</p></dd><dt><span class="term">useStun</span></dt><dd><p>Enables Session Traversal Utilities for NAT (STUN) support for this Connector. The attribute defaults to "false". If set to "true", ensure that the <code class="literal">ipAddress</code> attribute is <span class="emphasis"><em>not</em></span> set to <code class="literal">127.0.0.1</code>. Refer to <a class="xref" href="#mssstun-MSS_STUN" title="8.3. STUN Support">Section 8.3, “STUN Support”</a> for more information about STUN.</p></dd><dt><span class="term">stunServerAddress</span></dt><dd><p>Specifies the STUN server address used to discover the public IP address of the SIP Connector. This attribute is only required if the <code class="literal">useStun</code> attribute is set to "true". Refer to <a class="xref" href="#mssstun-MSS_STUN" title="8.3. STUN Support">Section 8.3, “STUN Support”</a> for more information about STUN and public STUN servers.</p></dd><dt><span class="term">stunServerPort</span></dt><dd><p>Specifies the STUN server port of the STUN server used in the <code class="literal">stunServerAddress</code> attribute. You should rarely need to change this attribute; also, it is only needed if the <code class="literal">useStun</code> attribute is set to "true". Refer to <a class="xref" href="#mssstun-MSS_STUN" title="8.3. STUN Support">Section 8.3, “STUN Support”</a> for more information about STUN.</p></dd><dt><span class="term">useStaticAddress</span></dt><dd><p>Specifies whether the settings in staticServerAddress and staticServerPort are activated. The default value is "false" (deactivated).</p></dd><dt><span class="term">staticServerAddress</span></dt><dd><p>Specifies what load-balancer server address is inserted in Contact/Via headers for server-created requests. This parameter  is useful for  cluster configurations where  requests should  be bound to a load-balancer address, rather than  a specific node address.</p></dd><dt><span class="term">staticServerPort</span></dt><dd><p>Specifies the port of the load-balancer specified in staticServerAddress. This parameter is useful in cluster configurations where requests should be bound to a load-balancer address rather than a specific node address.</p></dd><dt><span class="term">httpFollowsSip</span></dt><dd><p>
          Makes the application server aware of how the SIP Load Balancers assign request affinity, and stores this information in the application session.
          </p><p>
          When the HTTP Load Balancer sends HTTP requests that are not associated with the application session, the application server will force the HTTP request to be repeated until it lands on the correct node.
          </p></dd></dl></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>A comprehensive list of implementing classes for the SIP Stack is available from the <a class="ulink" href="http://ci.jboss.org/jenkins/job/jain-sip/lastSuccessfulBuild/artifact/javadoc/javax/sip/SipStack.html">Class SipStackImpl page on nist.gov</a>.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="bsssc-binary-SIP_Servlets_Server-Configuring_Application_Routing"/>2.3.2. Application Routing and Service Configuration</h3></div></div></div><p>The application router is called by the container to select a SIP Servlet application to service an initial request. It embodies the logic used to choose which applications to invoke. An application router is required for a container to function, but it is a separate logical entity from the container.</p><p>The application router is responsible for application selection and must not implement application logic. For example, the application router cannot modify a request or send a response.</p><p>For more information about the application router, refer to the following sections of the <a class="ulink" href="http://jcp.org/en/jsr/detail?id=289">JSR 289 specification</a>: Application Router Packaging and Deployment, Application Selection Process, and Appendix C.
   </p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2> </h2><p>
See the example chapters for more information about the Application Router Configuration for SIP MSS for JBoss AS7
</p><p>
 <a class="xref" href="#sfss-Services_for_SIP_Servlets" title="4.1. Operating the Example Applications">Section 4.1, “Operating the Example Applications”</a> 
</p></div><p>In order to configure the application router for Tomcat, you should edit the <code class="literal">Service</code> element in the container's <code class="filename">server.xml</code> configuration file</p><div class="example"><a id="bsssc-Configuring_the_Service_Element_in_the_Containers_server.xml"/><p class="title"><strong>Example 2.3. Configuring the Service Element in the Container's server.xml</strong></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
  &lt;Service name="Sip-Servlets"
 className="org.mobicents.servlet.sip.startup.SipStandardService"
 sipApplicationDispatcherClassName="org.mobicents.servlet.sip.core.SipApplicationDispatcherImpl"
 usePrettyEncoding="false" 
 additionalParameterableHeaders="Header1,Header2" 
 bypassResponseExecutor="false" 
 bypassRequestExecutor="false" 
 baseTimerInterval="500"
 t2Interval="4000"
 t4Interval="5000"
 timerDInterval="32000"
 dispatcherThreadPoolSize="4"
 darConfigurationFileLocation="file:///home/user/workspaces/sip-servlets/
 sip-servlets-examples/reinvite-demo/reinvite-dar.properties"
 sipStackPropertiesFile="conf/mss-sip-stack.properties"
 dialogPendingRequestChecking="false"
 canceledTimerTasksPurgePeriod="1"&gt;
 </pre></div></div><br class="example-break"/><p>For MSS for JBoss AS7 this is located in standalone-sip.xml file :</p><div class="example"><a id="bsssc-Configuring_the_mobicents_subsystem_in_the_Containers_standalone-sip.xml"/><p class="title"><strong>Example 2.4. Configuring the Mobicents SubSystem Element in the Container's standalone.xml</strong></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
  &lt;subsystem xmlns="urn:org.mobicents:sip-servlets-as7:1.0" application-router="dars/mobicents-dar.properties" stack-properties="mss-sip-stack.properties" path-name="gov.nist" app-dispatcher-class="org.mobicents.servlet.sip.core.SipApplicationDispatcherImpl" concurrency-control-mode="SipApplicationSession" congestion-control-interval="-1"&gt;
            &lt;connector name="sip-udp" protocol="SIP/2.0" scheme="sip" socket-binding="sip-udp"/&gt;
            &lt;connector name="sip-tcp" protocol="SIP/2.0" scheme="sip" socket-binding="sip-tcp"/&gt;
            &lt;connector name="sip-tls" protocol="SIP/2.0" scheme="sip" socket-binding="sip-tls"/&gt;
        &lt;/subsystem&gt;
 </pre></div></div><br class="example-break"/><div class="variablelist"><p class="title"><strong>SIP Service element attributes</strong></p><dl class="variablelist"><dt><span class="term">className</span></dt><dd><p>This attribute specifies that the servlet container is a <span class="emphasis"><em>converged</em></span> (i.e. SIP + HTTP) servlet container.</p></dd><dt><span class="term">sipApplicationDispatcherClassName</span></dt><dd><p>This attribute specifies the class name of the <code class="literal">org.mobicents.servlet.sip.core.SipApplicationDispatcher</code> implementation to use. The routing algorithm and application selection process is performed in that class.</p></dd><dt><span class="term">darConfigurationFileLocation</span></dt><dd><p>The default application router file location. This is used by the default application router to determine the application selection logic. Refer to Appendix C of the JSR 289 specification for more details.</p></dd><dt><span class="term">sipStackPropertiesFile</span></dt><dd><p>Specifies the location of the file containing key value pairs corresponding to the SIP Stack configuration properties. This attribute is used to further tune the JAIN SIP Stack. If this property is omitted, the following default values are assumed:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>gov.nist.javax.sip.LOG_MESSAGE_CONTENT=true</p></li><li class="listitem"><p>gov.nist.javax.sip.TRACE_LEVEL=32</p></li><li class="listitem"><p>gov.nist.javax.sip.DEBUG_LOG=logs/mss-jsip-debuglog.txt</p></li><li class="listitem"><p>gov.nist.javax.sip.SERVER_LOG=logs/mss-jsip-messages.xml</p></li><li class="listitem"><p>javax.sip.STACK_NAME=Mobicents-SIP-Servlets</p></li><li class="listitem"><p>javax.sip.AUTOMATIC_DIALOG_SUPPORT=off</p></li><li class="listitem"><p>gov.nist.javax.sip.DELIVER_UNSOLICITED_NOTIFY=true</p></li><li class="listitem"><p>gov.nist.javax.sip.THREAD_POOL_SIZE=64</p></li><li class="listitem"><p>gov.nist.javax.sip.REENTRANT_LISTENER=true</p></li><li class="listitem"><p>gov.nist.javax.sip.MAX_FORK_TIME_SECONDS=0. Dialog forking is not enabled by default as it has an impact on memory. If set to a value greater than 0, Dialog Forking will be enabled on Mobicents Sip Servlets.</p></li><li class="listitem"><p>gov.nist.javax.sip.AUTOMATIC_DIALOG_ERROR_HANDLING=false. Merged requests Loop Detection is turned off by default</p></li></ul></div><p>SIP Servlets also adds its own properties to allow for even more configuration and flexibility:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>If the property <code class="literal">org.mobicents.servlet.sip.SERVER_HEADER</code> is set, a server header will be added to all SIP Responses leaving the container.</p></li><li class="listitem"><p>If the property <code class="literal">org.mobicents.servlet.sip.USER_AGENT_HEADER</code> is set, a server header will be added to all SIP Requests leaving the container.</p></li></ul></div></dd><dt><span class="term">usePrettyEncoding</span></dt><dd><p>Allows Via, Route, and RecordRoute header field information to be split into multiple lines, rather than each header field being separating with a comma. The attribute defaults to "true". Leaving this attribute at the default setting may assist in debugging non-RFC3261 compliant SIP servers.</p></dd><dt><span class="term">additionalParameterableHeaders</span></dt><dd><p>Comma separated list of header names that are treated as parameterable by the container. The specified headers are classed as valid, in addition to the standard parameterable headers defined in the Sip Servlets 1.1 Specification.</p><p>Setting and getting parameters is allowed for both the standard and the additional parameters. Parameters that are not specified in <code class="literal">additionalParameterableHeaders</code> will result in a ServletParseException error.</p></dd><dt><span class="term">bypassRequestExecutor/bypassResponseExecutor</span></dt><dd><p>If set to false, the SIP Servlets server uses a ThreadPoolExecutor linked to a LinkedBlockingQueue to dispatch the request/response threads. The container can then handle two different responses (for example a 180 Ringing and a 200 OK) concurrently. However, a race condition can occur where the second response overtakes the first one (200 OK dispatched to the application before the 180 Ringing) on UDP.</p><p>These flags are set to true by defauilt, Jain sip serializing is used per transaction to ensure such race conditions don't occur in Mobicents Sip Servlets even though they can still happen on UDP at jain sip level.</p></dd><dt><span class="term">baseTimerInterval</span></dt><dd><p>Specifies the <code class="literal">T1</code> Base Timer Interval, which allows the SIP Servlets container to adjust its timers depending on network conditions. The default interval is 500 (milliseconds).</p><p>For more information about available timers, refer to the <a class="ulink" href="http://tools.ietf.org/html/rfc3261#appendix-A">RFC326 "Table of Timer Values"1</a>, and the document contained in the <a class="ulink" href="http://www.3gpp.org/ftp/Specs/html-info/24229.htm">3GPP-IMS TS 24.229 v9.1.0 specification ZIP archive</a>.</p><p>All of the timers present in the tables depend on <code class="literal">T1</code>, <code class="literal">T2</code>, <code class="literal">T4</code>, and <code class="literal">Timer D</code>.</p></dd><dt><span class="term">t2Interval</span></dt><dd><p>Specifies the <code class="literal">T2</code> Interval, which allows the SIP Servlets container to adjust its timers depending on network conditions. The default interval is 4000 (milliseconds).</p><p>For more information about available timers, refer to the <a class="ulink" href="http://tools.ietf.org/html/rfc3261#appendix-A">RFC326 "Table of Timer Values"1</a>, and the document contained in the <a class="ulink" href="http://www.3gpp.org/ftp/Specs/html-info/24229.htm">3GPP-IMS TS 24.229 v9.1.0 specification ZIP archive</a>.</p><p>All of the timers present in the tables depend on <code class="literal">T1</code>, <code class="literal">T2</code>, <code class="literal">T4</code>, and <code class="literal">Timer D</code>.</p></dd><dt><span class="term">t4Interval</span></dt><dd><p>Specifies the <code class="literal">T4</code> Interval, which allows the SIP Servlets container to adjust its timers depending on network conditions. The default interval is 5000 (milliseconds).</p><p>For more information about available timers, refer to the <a class="ulink" href="http://tools.ietf.org/html/rfc3261#appendix-A">RFC326 "Table of Timer Values"1</a>, and the document contained in the <a class="ulink" href="http://www.3gpp.org/ftp/Specs/html-info/24229.htm">3GPP-IMS TS 24.229 v9.1.0 specification ZIP archive</a>.</p><p>All of the timers present in the tables depend on <code class="literal">T1</code>, <code class="literal">T2</code>, <code class="literal">T4</code>, and <code class="literal">Timer D</code>.</p></dd><dt><span class="term">timerDInterval</span></dt><dd><p>Specifies the <code class="literal">Timer D</code> Interval, which allows the SIP Servlets container to adjust its timers depending on network conditions. The default interval is 32000 (milliseconds).</p><p>For more information about available timers, refer to the <a class="ulink" href="http://tools.ietf.org/html/rfc3261#appendix-A">RFC326 "Table of Timer Values"1</a>, and the document contained in the <a class="ulink" href="http://www.3gpp.org/ftp/Specs/html-info/24229.htm">3GPP-IMS TS 24.229 v9.1.0 specification ZIP archive</a>.</p><p>All of the timers present in the tables depend on <code class="literal">T1</code>, <code class="literal">T2</code>, <code class="literal">T4</code>, and <code class="literal">Timer D</code>.</p></dd><dt><span class="term">dispatcherThreadPoolSize</span></dt><dd><p>The number of threads used for processing SIP messages inside the Sip Servlets container by the dispatcher. The default value is 4.</p></dd><dt><span class="term">dialogPendingRequestChecking</span></dt><dd><p>This property enables and disables error checking when SIP transactions overlap. If within a single dialog an INVITE request arrives while there is antoher transaction proceeding, the container will send a 491 error response. The default value is false.</p></dd><dt><span class="term">dnsServerLocatorClass</span></dt><dd><p>Specifies the <code class="classname">org.mobicents.ext.javax.sip.dns.DNSServerLocator</code> implementation class that will be used by the container to perform DNS lookups compliant with RFC 3263 : Locating SIP Servers and E.164 NUmber Mapping. The default class used by the container is <code class="classname">org.mobicents.ext.javax.sip.dns.DefaultDNSServerLocator</code>, but any class implementing the <code class="classname">org.mobicents.ext.javax.sip.dns.DNSServerLocator</code> interface. To disable DNS lookups, this attribute should be left empty.</p></dd><dt><span class="term">addressResolverClass</span></dt><dd><p>Specifies the <code class="classname">gov.nist.core.net.AddressResolver</code> implementation class that will be used by the container to perform DNS lookups. The default class used by the container is <code class="classname">org.mobicents.servlet.sip.core.DNSAddressResolver</code>, but any class implementing the <code class="classname">gov.nist.core.net.AddressResolver</code> NIST SIP Stack interface and having a constructor with a <code class="classname">org.mobicents.servlet.sip.core.SipApplicationDispatcher</code> parameter can be used. To disable DNS lookups, this attribute should be left empty.</p><p>This attribute has been deprecated in favor of <code class="literal">dnsServerLocatorClass</code> attribute which provides better compliance with RFC 3263 : Location SIP Servers and ENUM support</p></dd><dt><span class="term">canceledTimerTasksPurgePeriod</span></dt><dd><p>Defines a period to due a purge in the container timer schedulers. The purge may prevent excessive memory usage for apps that cancel most of the timers it sets.</p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="bsssc-binary-SIP_Servlets_Server-Configuring_Logging"/>2.3.3. SIP Servlets Server Logging</h3></div></div></div><p>
Logging is an important part of working with Mobicents. There are a few files that you need to be familiar with in order to successfully troubleshoot and adapt MSS server monitoring and logging to your environment.
</p><p><strong>Logging Files for MSS for JBoss AS7. </strong></p><p>
$JBOSS/standalone/configuration/logging.properties
</p><p>
$JBOSS/standalone/configuration/mss-sip-stack.properties
</p><p>
$JBOSS/standalone/configuration/standalone-sip.xml
</p><div class="example"><a id="standalone-sip.xml-logging-configuration"/><p class="title"><strong>Example 2.5. 
Setting the log file name in $JBOSS/standalone/configuration/standalone-sip.xml
</strong></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">


 &lt;/formatter&gt;
&lt;file relative-to="jboss.server.log.dir" path="server.log"/&gt;
&lt;suffix value=".yyyy-MM-dd"/&gt;
&lt;append value="true"/&gt;


</pre></div></div><br class="example-break"/><p>

The configuration above produces SIP logs that can be found in the  $JBOSS_HOME/standalone/log directory. Below is an extract of the log files.

</p><pre class="screen">
                       server.log.2012-08-14  server.log.2012-08-24
server.log             server.log.2012-08-16  server.log.2012-08-25
server.log.2012-08-07  server.log.2012-08-21  server.log.2012-08-26
server.log.2012-08-13  server.log.2012-08-22
</pre><p><strong>Logging Files for MSS for Tomcat . </strong></p><p>
If you are working with Tomcat, the log configuration files are located in the $CATALINA_HOME/conf/ directory. The log4j configuration file is located in $CATALINA_HOME/lib/ directory
</p><p>
$CATALINA_HOME/conf/logging.properties
</p><p>
$CATALINA_HOME/conf/mss-sip-stack.properties
</p><p>
$CATALINA_HOME/conf/server.xml
</p><p>
$CATALINA_HOME/lib/log4j.xml
</p><p><strong>Truncated Sample Configuration from Server.xml  . </strong></p><div class="example"><a id="server.xml-logging-configuration"/><p class="title"><strong>Example 2.6. 
Setting the log file name $CATALINA_HOME/conf/server.xml
</strong></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">



&lt;Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs"  
               prefix="localhost_access_log." suffix=".txt"
               pattern="%h %l %u %t &amp;quot;%r&amp;quot; %s %b" resolveHosts="false"/&gt;



</pre></div></div><br class="example-break"/><p><strong>Truncated Sample Configuration from log4j.xml  . </strong></p><div class="example"><a id="log4j.xml-logging-configuration"/><p class="title"><strong>Example 2.7. 
Configuring the log file name $CATALINA_HOME/lib/log4j.xml
</strong></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;log4j:configuration xmlns:log4j="http://jakarta.apache.org/log4j/"&gt;
  &lt;appender name="rolling-file" class="org.apache.log4j.RollingFileAppender"&gt; 
    &lt;param name="file" value="${catalina.home}/logs/sip-server.log"/&gt;
    &lt;param name="MaxFileSize" value="1000KB"/&gt;


</pre></div></div><br class="example-break"/><p>
The result of the extracted configuration above that is taken from the log4j.xml file  and can be found in the $CATALINA_HOME/logs directory. 
</p><p>JAIN-SIP Stack Logging</p><p>There are two separate levels of logging:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Logging at the container level, which can be configured using the <code class="filename">log4j.xml</code> or <code class="filename">standalone-sip.xml</code> configuration file seen above</p></li><li class="listitem"><p>Logging of the JAIN SIP stack, which is configured through the container logging and the SIP stack properties themselves</p></li></ul></div><p>You can setup the logging so that the JAIN SIP Stack will log into the container logs.</p><p>To use LOG4J in JAIN SIP Stack in Tomcat, you need to define a category in <code class="filename">CATALINE_HOME/lib/jboss-log4j.xml</code> and set it to <code class="literal">DEBUG</code>.</p><div class="example"><a id="bsssc-Configuring_the_Stack_Logs_in_the_Container_log4j.xml"/><p class="title"><strong>Example 2.8. Configuring the JAIN SIP Stack to log into the Tomcat Container's logs</strong></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                        &lt;category name="gov.nist"&gt;
                        &lt;priority value="DEBUG"/&gt;
                        &lt;/category&gt;
                </pre></div></div><br class="example-break"/><p>To use LOG4J in JAIN SIP Stack in JBoss, you need to define a logger in <code class="filename">JBOSS_HOME/standalone/configuration/standalone-sip.xml</code> and set it to <code class="literal">DEBUG</code>.</p><div class="example"><a id="bsssc-Configuring_the_Stack_Logs_in_the_Container_standlaone-sip.xml"/><p class="title"><strong>Example 2.9. Configuring the JAIN SIP Stack to log into the JBoss Container's logs</strong></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                        &lt;logger category="gov.nist"&gt;
                		&lt;level name="DEBUG"/&gt;
            		&lt;/logger&gt;
                </pre></div></div><br class="example-break"/><p>For this category to be used in MSS, you need to specify it in <code class="filename">JBOSS_HOME/standalone/configuration/mss-sip-stack.properties</code> or <code class="filename">CATALINE_HOME/conf/mss-sip-stack.properties</code>, add the <code class="literal">gov.nist.javax.sip.LOG4J_LOGGER_NAME=gov.nist</code> property, and set the <code class="literal">gov.nist.javax.sip.TRACE_LEVEL=LOG4J</code> property.</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="sssicar-SIP_Servlets_Server-Application-Router"/>Chapter 3. Application Router</h1></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#tsdar-Default-Application-Router">3.1. Default Application Router</a></span></dt><dd><dl><dt><span class="section"><a href="#tsdar-Application-Router-Role">3.1.1. Role of the Application Router</a></span></dt><dt><span class="section"><a href="#tsdar-Mobicents-Default-Application-Router">3.1.2. Mobicents Default Application Router</a></span></dt><dt><span class="section"><a href="#tsdar-Limitations">3.1.3. Limitations of the Default Application Router</a></span></dt></dl></dd><dt><span class="section"><a href="#tsear-echarts-Application-Router">3.2. DFC Application Router</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1957">3.2.1. Description of DFC Application Router</a></span></dt><dt><span class="section"><a href="#d0e1965">3.2.2. Installing the DFC Application Router</a></span></dt></dl></dd></dl></div><p>Application Routing is
  performed within the Mobicents Sip Servlets container by the Default
  Application Router. The following sections describe the Default Application Router, and how other JSR 289 compliant Application Router implementations
  can be installed.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="tsdar-Default-Application-Router"/>3.1. Default Application Router</h2></div></div></div><p>The Application Router is called by the container to select a SIP
  Servlet application to service an initial request. It embodies the logic
  used to choose which applications to invoke.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="tsdar-Application-Router-Role"/>3.1.1. Role of the Application Router</h3></div></div></div><p>An Application Router is required for a container to function, but
    it is a separate logical entity from the container. The Application Router
    is responsible for application selection and does not implement
    application logic. For example, the Application Router cannot modify a
    request or send a response.</p><p>There is no direct interaction between the Application Router and
    applications, only between the SIP Servlets Container and the Application
    Router.</p><p>The
    SIP Servlets container is responsible for passing the required information to the Application Router within the initial request so the Application Router can make informed routing decisions. The Application Router is free to make use of any information or data stores, except for the information passed by the container. It is up to the individual implementation how the Application Router makes use of the information or data stores.</p><p>The
    deployer in a SIP Servlet environment controls application composition by
    defining and deploying the Application Router implementation. Giving the
    deployer control over application composition is desirable because the deployer is solely responsible for the services available to subscribers.</p><p>Furthermore, the SIP Servlets
    specification intentionally allows the Application Router implementation
    to consult arbitrary information or data stores. This is because the
    deployer maintains subscriber information and this information is often
    private and valuable.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="tsdar-Mobicents-Default-Application-Router"/>3.1.2. Mobicents Default Application Router</h3></div></div></div><p>Mobicents SIP Servlets provides an implementation of the Default
    Application Router (DAR) as defined in the SIP Servlets 1.1 specification,
    Appendix C.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="tsdar-DAR-Configuration-File"/>3.1.2.1. The DAR Configuration File</h4></div></div></div><p>The Default Application Router (DAR) obtains its operational parameters from a 
      configuration text file that is modeled as a Java properties file. The configuration file 
      contains the information needed by the Application Router to select
      which SIP Servlet application will handle an incoming initial request.
       </p><p>In the case of Mobicents
          SIP Servlets, it is also possible to configure the DAR through the
          <code class="filename">server.xml</code> configuration file (see <a class="xref" href="#bsssc-Configuring_the_Service_Element_in_the_Containers_server.xml" title="Example 2.3. Configuring the Service Element in the Container's server.xml">Example 2.3, “Configuring the Service Element in the Container's server.xml”</a> and  <a class="xref" href="#">???</a>).</p><p>The properties file has the following characteristics and requirements:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>It must be made available to the DAR.</p></li><li class="listitem"><p>It must allow the contents and file structure to be accessible from a hierarchical
          URI supplied as a system property
          <code class="filename">javax.servlet.sip.ar.dar.configuration</code>.</p></li><li class="listitem"><p>It is first read by the container when it
          loads up and is refreshed each time an application is
          deployed and undeployed.</p></li><li class="listitem"><p>It has a simple format in which the name of
          the property is the SIP method and the value is a comma-separated string value for the <code class="literal">SipApplicationRouterInfo</code>
          object.</p><pre class="screen">INVITE: (sip-router-info-1), (sip-router-info-2)..
SUBSCRIBE: (sip-router-info-3), (sip-router-info-4)..
ALL: (sip-router-info-5), (sip-router-info-6)..</pre><p>Mobicents SIP Servlets defines a new keyword called <code class="literal">ALL</code>.  The keyword 
        allows mapping between the sip-router-info data, and all methods
        supported by the container (for example, INVITE, REGISTER, SUBSCRIBE). This mapping can 
        save time when configuring an application that listens to all
        incoming methods. </p></li></ul></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>If <code class="literal">ALL</code>, and a specific method are defined in
        the DAR file, the specific method takes precedence over <code class="literal">ALL</code>. When the specific method no longer has applications to serve, <code class="literal">ALL</code> is enabled again. </p></div><p>The sip-router-info data specified in the properties file is a
      string value version of the <code class="literal">SipApplicationRouterInfo</code> object. It consists
      of the following information:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>The name of the application as known to the container. The application name can be obtained from the <span class="markup">&lt;app-name&gt;</span> element of the <code class="filename">sip.xml</code> deployment
          descriptor of the application, or the <code class="literal">@SipApplication</code>
          annotation.</p></li><li class="listitem"><p>The identity of the subscriber that the DAR returns. The DAR can 
          return any header in the SIP request using the DAR directive
          <code class="literal">DAR:SIP_HEADER</code>.  For example,  <code class="literal">DAR:From</code> would return the SIP URI in the <code class="literal">From</code>
          header. The DAR can  alternatively  return any string from the SIP request.</p></li><li class="listitem"><p>The routing region, which consists of one of the following strings:  <code class="literal">ORIGINATING</code>,
          <code class="literal">TERMINATING</code> or <code class="literal">NEUTRAL</code>.  This information is not currently used
          by the DAR to make routing decisions.</p></li><li class="listitem"><p>A SIP URI indicating the route as returned by the Application
          Router, which can be used to route the request externally.  The value may be an empty string.</p></li><li class="listitem"><p>A route modifier, which consists of one of the following strings: <code class="literal">ROUTE</code>,
          <code class="literal">ROUTE_BACK</code> or <code class="literal">NO_ROUTE</code>.  The route modifier is used in conjunction with the 
          route information to route a request externally.</p></li><li class="listitem"><p>A string representing the order in which  applications must be
          invoked (starts at 0).  The string is removed later on in the routing process,  and substituted with the order positions of sip-router-info data.</p></li><li class="listitem"><p>
				An optional string that contains Mobicents-specific parameters. Currently, only the <code class="literal">DIRECTION</code> and <code class="literal">REGEX</code> parameters are supported.
			</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>
					The field can contain unsupported <code class="literal">key=value</code> properties that may be supported in future releases. The unsupported properties will be ignored during parsing, until support for the attributes is provided.
				</p></div><p>
				The syntax is demonstrated in <a class="xref" href="#example-DAR_Direction_Example" title="Example 3.1. DIRECTION Example">Example 3.1, “DIRECTION Example”</a>.
			</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><p>
						The <code class="literal">DIRECTION</code> parameter specifies whether an application serves external(INBOUND) requests or initiates (OUTBOUND) requests.
					</p><p>
						If an application is marked <code class="literal">DIRECTION=INBOUND</code>, it will not be called for requests initiated by applications behaving as UAC. To mark an application as UAC, specify <code class="literal">DIRECTION=INBOUND</code> in the optional parameters in the DAR.
					</p><p>
						Applications that do not exist in the DAR list for the container are assumed to be <code class="literal">OUTBOUND</code>. Because undefined applications are incapable of serving external requests, they must have self-initiated the request. The Sip Servlets Management Console can be used to specify the <code class="literal">DIRECTION</code> parameter.
					</p></li><li class="listitem"><p>
						The <code class="literal">REGEX</code> parameter specifies a regular expression to be matched against the initial request passed to the Application Router.
					</p><p>
          				If the regular expression matches a part of the initial request, the application is called. If it does not, it is skipped.
          			</p><p>
          				For example, in the following sip-router-info data: </p><pre class="screen">INVITE - ("org.mobicents.servlet.sip.testsuite.SimpleApplication", "DAR:From", "ORIGINATING", "", "NO_ROUTE", "0", "REGEX=From:.*sip:.*@sip-servlets\.com")</pre><p> - only incoming initial requests with a From Header with a SIP URI that belongs to the sip-servlets.com domain will be passed to the SimpleApplication.
           			</p></li></ul></div></li></ul></div><div class="example"><a id="example-DAR_Direction_Example"/><p class="title"><strong>Example 3.1. DIRECTION Example</strong></p><div class="example-contents"><p>In this example, two applications are declared for the
   <code class="literal">INVITE</code>
   request. The
   <code class="literal">LocationServiceApplication</code> is called for requests coming from outside the container, but it
   will not be
   called for the requests initiated by the UAC application
   <code class="literal">Click2DialApplication</code>.    </p><pre class="screen">
INVITE: ("org.mobicents.servlet.sip.testsuite.Click2DialApplication", "DAR:From",
"ORIGINATING", "", "NO_ROUTE", "0", "DIRECTION=OUTBOUND"), \
("org.mobicents.servlet.sip.testsuite.LocationServiceApplication", "DAR\:From",
"ORIGINATING", "", "NO_ROUTE", "0", "DIRECTION=INBOUND")</pre><p>This type of configuration is useful in cases where different application must be responsible for both requests initiated by the container,  and external requests received by the container.
  </p></div></div><br class="example-break"/><div class="example"><a id="d0e1795"/><p class="title"><strong>Example 3.2. ORIGINATING/TERMINATING DAR Example</strong></p><div class="example-contents"><p>In this example, the DAR is configured to invoke two applications on
      receipt of an INVITE request; one each in the originating and the terminating halves. The applications are identified by their application deployment descriptor names.</p><pre class="screen">INVITE: ("OriginatingCallWaiting", "DAR:From", "ORIGINATING", "", "NO_ROUTE", "0"), ("CallForwarding", "DAR:To", "TERMINATING", "","NO_ROUTE", "1") </pre><p>For this example, the returned subscriber identity is the URI from each application's 
      <code class="literal">From</code> and <code class="literal">To</code> headers respectively.  The DAR does
      not return any route to the container, and maintains the invocation state
      in the <code class="literal">stateInfo</code> as the index of the last application in the
      list.</p></div></div><br class="example-break"/></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1813"/>3.1.2.2. Routing of SIP Messages to Applications</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="d0e1816"/>3.1.2.2.1. Initial Requests and Application Selection Process</h5></div></div></div><p>Initial Requests are those that can essentially be dialog
        creating (such as, <code class="literal">INVITE</code>, <code class="literal">SUBSCRIBE</code> and  <code class="literal">NOTIFY</code>),  and not part of an already existing dialog.</p><p>Initial requests are routed to applications deployed in
        the container according to the SIP Servlets 1.1 specification, Section
        15.4.1 Procedure for Routing an Initial Request.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>There are
        some other corner cases that apply to initial requests. Refer to Appendix B, Definition of an Initial Request in the SIP Servlets 1.1
        specification. </p></div><div class="example"><a id="d0e1837"/><p class="title"><strong>Example 3.3. INVITE Routing</strong></p><div class="example-contents"><p>The following example describes how the DAR routes an INVITE to two applications  deployed in a container. The applications in this example are a
        Location Service and a Call Blocking application.</p><p>In the example, the assumption of a request coming to the server is described. However, applications can act as a UAC, and  generate initial requests
          on their own. For routing purposes, it is not necessary for 
          the specified application initiating the request to have an  entry in the DAR file.</p><p>The DAR file  contains the required information for the  two
        applications to be invoked in the correct order.</p><pre class="screen">INVITE: ("LocationService", "DAR:From", "ORIGINATING", "", "NO_ROUTE", "0"), ("CallBlocking", "DAR:To", "TERMINATING", "","NO_ROUTE", "1") </pre><p>Processing occurs in the following order:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>A new <code class="literal">INVITE</code> (not a re-INVITE) arrives at the container.  </p><p>The <code class="literal">INVITE</code>  is a  dialog creating request, and is  not part of any
        dialog.</p></li><li class="listitem"><p>The Application Router is called. </p><p>From the <code class="literal">INVITE</code> information, the first
        application to invoke is the Location Service. </p></li><li class="listitem"><p>The Application Router returns  the application invocation order 
        information to the container (along with the rest of the
        sip-router-info data) so  the container knows which application to
        invoke.</p></li><li class="listitem"><p>The container   invokes the LocationService that proxies the
        <code class="literal">INVITE</code>. </p><p>The proxied <code class="literal">INVITE</code> is considered  as a new <code class="literal">INVITE</code> to the known IP Address of the registered user for the Request
        URI</p><p>For further information regarding <code class="literal">INVITE</code> handling, refer to  "Section 15.2.2 Sending an Initial Request" in the  SIP
        Servlets 1.1 Specification.</p></li><li class="listitem"><p>Because the <code class="literal">INVITE</code> has been proxied, the container  invokes the
        Application Router for the proxied <code class="literal">INVITE</code> to see if any more
        applications are interested in the event. </p></li><li class="listitem"><p>From the proxied invite, the Application Router determines that the second application to invoke is the Call Blocking application.
        </p></li><li class="listitem"><p>The Application Router returns  information regarding the Call Blocking application to the container (along with the
        rest of the sip-router-info data) so  the container knows which
        application to invoke.</p></li><li class="listitem"><p>The container routes the <code class="literal">INVITE</code> for the Call Blocking application to the next application in the chain.</p></li><li class="listitem"><p>The Call Blocking application determines  that the user that initiated the call  is black listed. The application rejects the
        call with a "Forbidden" response. </p></li><li class="listitem"><p>Because the Call Blocking application acts as a UAS,
        the Application Selection Process is stopped for the original <code class="literal">INVITE</code>.</p></li></ol></div><p>The path  the <code class="literal">INVITE</code> has taken (that is, LocationService to 
        CallBlocking) is called the application path.  The routing of the
        responses will now occur as explained in the next section.</p></div></div><br class="example-break"/></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="d0e1928"/>3.1.2.2.2. Response Routing</h5></div></div></div><p>Responses always follow the reverse of the path taken by the
        corresponding request. In our case, the Forbidden response will first
        go back to the LocationService, and then back to the caller. This is true for
        responses to both initial and subsequent requests. The application
        path is a logical concept and as such may or may not be explicitly
        represented within containers.</p><p>Another possible outcome could have been that the Call Blocking
        application, instead of sending a Forbidden response, allowed the call
        and proxied the INVITE to the same Request URI chosen by the Location
        Service. Then when the callee sends back the 200 OK Response, this
        response goes back the same way through the application path (so in
        the present case Call Blocking, then Location Service, then back to
        the caller).</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>The Call Blocking application cannot just do nothing with the
          request and expect the container to route the request in its place
          (either to a next application in chain if another one is present or
          to the outside world if none is present). The Application has to do
          something with request (either proxy it or act as a UAS).</p></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="d0e1938"/>3.1.2.2.3. Subsequent Requests</h5></div></div></div><p>Subsequent requests are all requests that are not
        Initial.</p><p>The second scenario, where the Call Blocking application allowed
        the call, will be used in this section to showcase subsequent requests.
        The caller has received the 200 OK response back. Now, according to
        the SIP specification (RFC 3261), it sends an ACK. The ACK arrives at
        the container, and is not a dialog creating request and is already part
        of an ongoing dialog (early dialog) so the request is detected as a
        Subsequent request and will follow the application path created by the
        initial request. The ACK will go through Location Service, Call
        Blocking, and finally to the callee.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="tsdar-Limitations"/>3.1.3. Limitations of the Default Application Router</h3></div></div></div><p>The DAR  is a minimalist Application Router implementation that is part of the reference implementation.  While it could be used instead of a production Application Router, it offers no
    processing logic except for  the declaration of the application order. </p><p>In real world deployments, the Application Router plays
    an extremely important role in application orchestration and composition.
    It is likely that the Application Router would  make use of complex rules and diverse data
    repositories in future implementations.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="tsear-echarts-Application-Router"/>3.2. DFC Application Router</h2></div></div></div><p> </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1957"/>3.2.1. Description of DFC Application Router</h3></div></div></div><p>Instead of using the Mobicents Default Application Router, any SIP
    Servlets 1.1 compliant Application Router can be used, including the eCharts <a class="ulink" href="http://echarts.org/EChartsSipServletManual/sip-echartsse4.html#x6-140004.1">DFC Application Router</a>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1965"/>3.2.2. Installing the DFC Application Router</h3></div></div></div><p>Detailed instructions are available from <a class="ulink" href="http://echarts.org/Blog/Running-E4SS-apps-on-Mobicents-SIP-Servlets.html">the eCharts website</a>. The following procedure describe how to install the eCharts DFC Application Router (DFCAR) on a variety of SIP Servlet Server platforms.</p><div class="procedure"><a id="d0e1974"/><p class="title"><strong>Procedure 3.1. Installing DFCAR on Tomcat</strong></p><ol class="procedure" type="1"><li class="step"><p class="title"><strong>Deploy the DFCAR</strong></p><p>Drop the <code class="filename">dfcar.jar</code> from the ECharts distribution package in the
      <code class="literal">TOMCAT_HOME/lib</code> directory.</p></li><li class="step"><p class="title"><strong>Remove the DAR</strong></p><p>Remove the Mobicents
      Default Application Router located in
      <code class="literal">TOMCAT_HOME/lib/sip-servlets-application-router-*.jar</code>.</p></li></ol></div><p>
Please see the following link to learn how to deploy jar files in MSS for JBoss AS7. 
</p><div class="procedure"><a id="d0e1999"/><p class="title"><strong>Procedure 3.2. Installing DFCAR on JBoss AS7</strong></p><ol class="procedure" type="1"><li class="step"><p class="title"><strong>Deploy the DFCAR</strong></p><p>Create a directory under <code class="literal">JBOSS_HOME/modules/system/layers/base/org/echarts/</code></p><p>Drop the <code class="filename">dfcar.jar</code> from the ECharts distribution package in the
      <code class="literal">JBOSS_HOME/modules/system/layers/base/org/echarts/ </code>directory.</p><p>Create a <code class="literal">module.xml</code> file under the same directory with the following contents</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;module xmlns="urn:jboss:module:1.1" name="org.echarts"&gt;
&lt;resources&gt;
&lt;resource-root path="dfcar.jar"/&gt;
&lt;/resources&gt;
&lt;dependencies&gt;
&lt;module name="org.apache.log4j"/&gt;
&lt;module name="org.mobicents.javax.servlet.sip"/&gt;
&lt;/dependencies&gt;
&lt;/module&gt;</pre></li><li class="step"><p class="title"><strong>Remove the DAR</strong></p><p>Remove the Mobicents Default Application Router
      located in 
      <code class="literal">JBOSS_HOME/modules/system/layers/base/org/mobicents/dar</code>.</p></li><li class="step"><p class="title"><strong>Use the DFC DAR</strong></p><p>In <code class="literal">JBOSS_HOME/modules/system/layers/base/org/jboss/as/web/main/module.xml</code>, replace the following line </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;module name="org.mobicents.dar" export="true"/&gt;</pre><p>by this one</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;module name="org.echarts" export="true"/&gt;</pre><p>
	</p></li></ol></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="ssea-SIP_Servlet_Example_Applications"/>Chapter 4. SIP Servlet Example Applications</h1></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#sfss-Services_for_SIP_Servlets">4.1. Operating the Example Applications</a></span></dt><dd><dl><dt><span class="section"><a href="#sfss-The_Location_Service">4.1.1. The Location Service</a></span></dt><dt><span class="section"><a href="#sfss-The_Diameter_Event-Changing_Service">4.1.2. The Diameter Event-Changing Service</a></span></dt><dt><span class="section"><a href="#sfss-The_Call-Blocking_Service">4.1.3. The Call-Blocking Service</a></span></dt><dt><span class="section"><a href="#sfss-The_Call-Forwarding_Service">4.1.4. The Call-Forwarding Service</a></span></dt><dt><span class="section"><a href="#sfss-The_Call-Controller_Service">4.1.5. The Call-Controller Service</a></span></dt><dt><span class="section"><a href="#mipbx-Media_IPBX">4.1.6. Media IPBX</a></span></dt><dt><span class="section"><a href="#concept-chapter-SS_click2call">4.1.7. Tomcat Servlet Click2call Windows Setup</a></span></dt></dl></dd></dl></div><p>The SIP Servlet Server has a selection of examples that demonstrate particular capabilities of the server. <a class="xref" href="#tab-ssea-SIP_Servlet_Example_Applications" title="Table 4.1. Available Examples">Table 4.1, “Available Examples”</a> lists the available examples, their location, and a brief description about the functionality each example demonstrates. The examples can also provide a useful starting point for developing SIP Applications, therefore it is encouraged to experiment and adapt the base examples. Each example is available in both binary and source formats.</p><div class="table"><a id="tab-ssea-SIP_Servlet_Example_Applications"/><p class="title"><strong>Table 4.1. Available Examples</strong></p><div class="table-contents"><table summary="Available Examples" border="1"><colgroup><col align="left" class="c1"/><col align="left" class="c2"/></colgroup><thead><tr><th align="center">Example</th><th align="center">Description</th></tr></thead><tbody><tr><td align="left">
<a class="xref" href="#sfss-The_Call-Blocking_Service" title="4.1.3. The Call-Blocking Service">Section 4.1.3, “The Call-Blocking Service”</a>
</td><td align="left">Demonstrates how to block calls by specifying that the INVITE SIP Extension checks the <code class="literal">From</code> address to see if it is specified in the block list. If the blocked SIP address matches, the Call Blocking application send a FORBIDDEN response.</td></tr><tr><td align="left">
<a class="xref" href="#sfss-The_Call-Forwarding_Service" title="4.1.4. The Call-Forwarding Service">Section 4.1.4, “The Call-Forwarding Service”</a>
</td><td align="left">Demonstrates how to forward calls by specifying that the INVITE SIP Extension checks the <code class="literal">To</code> address to see if it is specified in the forward list. If the SIP address matches, the application acts as a back-to-back user agent (B2BUA).</td></tr><tr><td align="left">
<a class="xref" href="#sfss-The_Call-Controller_Service" title="4.1.5. The Call-Controller Service">Section 4.1.5, “The Call-Controller Service”</a>
</td><td align="left">Call Blocking and Call Forwarding are merged to create a new service.</td></tr><tr><td align="left">
<a class="ulink" href="https://code.google.com/p/sipservlets/wiki/SpeedDial">Speed Dial</a>
</td><td align="left">Demonstrates how to implement speed dialing for SIP addresses. The demonstration uses a static list of speed dial numbers. The numbers are translated into a complete address based on prior configuration. The SIP addresses are proxied without record-routing, or supervised mode.</td></tr><tr><td align="left">
<a class="xref" href="#sfss-The_Location_Service" title="4.1.1. The Location Service">Section 4.1.1, “The Location Service”</a>
</td><td align="left">Demonstrates a location service that performs a lookup based on the request URI, into a hard-coded list of addresses. The request is proxied to the set of destination addresses associated with that URI.</td></tr><tr><td align="left">
<a class="ulink" href="https://code.google.com/p/sipservlets/wiki/SpeedDialLocationService">Composed Speed Dial and Location</a>
</td><td align="left">Speed Dial and Location are merged to create a new service. Speed Dial proxies the speed dial number to a SIP address, then Location Service proxies the call to the actual location of the call recipient.</td></tr><tr><td align="left">
<a class="ulink" href="concept-chapter-SS_click2call">Click to Call</a>
</td><td align="left">Demonstrates how SIP Servlets can be used along with HTTP servlets as a converged application to place calls from a web portal. The example is a modified version of the click to dial example from the Sailfin project, but has been reworked to comply with JSR 289.</td></tr><tr><td align="left">
<a class="ulink" href="https://code.google.com/p/sipservlets/wiki/ChatServer">Chat Server</a>
</td><td align="left">Demonstrates <code class="literal">MESSAGE</code> SIP Extension support. This example is based on the chatroom server demonstration from the BEA dev2dev project, and has been modified to meet JSR 289 requirements.</td></tr><tr><td align="left">
<a class="ulink" href="https://code.google.com/p/sipservlets/wiki/MediaDemo">Media JSR 309 Example</a>
</td><td align="left">Demonstrates how the Sip Servlets Application Developers can leverage the JSR-309 API, which provides to application developers multimedia capabilities with a generic media server (MS) abstraction interface. This example is only compatible with JBoss AS5. The solution is know to work with Twinkle and linphone SIP soft-phones.</td></tr><tr><td align="left">
<a class="ulink" href="https://code.google.com/p/sipservlets/wiki/ShoppingDemo">Shopping</a>
</td><td align="left">Demonstrates integration with Seam and Java Enterprise Edition (JEE), and JSR 309 Media integration with text to speech (TTS) and dual-tone multi-frequency (DTMF) tones. The demonstration builds on the Converged Demo example, and adds support for the SIP Servlets v1.1 specification.</td></tr><tr><td align="left">
<a class="xref" href="#sfss-The_Diameter_Event-Changing_Service" title="4.1.2. The Diameter Event-Changing Service">Section 4.1.2, “The Diameter Event-Changing Service”</a>
</td><td align="left">Demonstrates how the Diameter Event Charging, and the Location service, can be used to perform fixed-rated charging of calls (event charging). When a call is initiated, a debit of ten euros is applied to the <code class="literal">A Party</code> account. If the call is rejected by the <code class="literal">B Party</code>, or <code class="literal">A Party</code> hangs up before <code class="literal">B Party</code> can answer the call, the ten euro charge is credited to the <code class="literal">A Party</code> account.</td></tr><tr><td align="left">
<a class="ulink" href="https://code.google.com/p/sipservlets/wiki/DiameterSh">Diameter Sh OpenIMS Integration</a>
</td><td align="left">Demonstrates the integration between Mobicents and OpenIMS, using the Diameter Sh interface to receive profile updates and SIP.</td></tr><tr><td align="left">
<a class="ulink" href="https://code.google.com/p/sipservlets/wiki/DiameterRoRf">Diameter Ro/Rf IIntegration</a>
</td><td align="left">A Diameter Ro/Rf service that performs online call charging.</td></tr><tr><td align="left">
<a class="ulink" href="https://code.google.com/p/sipservlets/wiki/ConferenceDemo">Conference</a>
</td><td align="left">Demonstrates the capabilities of the Media Server, such as endpoint composition and conferencing, as well as proving that SIP Servlets are capable of working seamlessly with any third-party web framework, without repackaging or modifying the deployment descriptors. The demonstration uses Google's GWT Ajax framework with server-push updates to provide a desktop-like user interface experience and JSR 309 for Media Control. </td></tr><tr><td align="left">
<a class="ulink" href="https://code.google.com/p/sipservlets/wiki/AlertingApplication">Alerting Application</a>
</td><td align="left">This application was developed so that the JBoss RHQ/Jopr Enterprise Management Solution would be able to notify system administrators when a monitoring alert is fired by Jopr/RHQ.</td></tr><tr><td align="left">
<a class="ulink" href="https://code.google.com/p/sipservlets/wiki/PresenceClientExample">SIP Presence Client Application</a>
</td><td align="left">A Call Blocking application interoperating with the PLATFORM_NAME; SIP Presence Service (Technology Preview) to fetch the blocked contacts through XCAP.</td></tr></tbody></table></div></div><br class="table-break"/><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sfss-Services_for_SIP_Servlets"/>4.1. Operating the Example Applications</h2></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2> Important Information  </h2><p>
Before trying out the examples in this section, you must have installed, configured and have MSS for JBoss or MSS for Tomcat AS7 running on your system.
</p><p>
See the chapters below for detailed instructions.
</p><p>
 <a class="xref" href="#getting-started-with-MSS-JBOSS-AS7" title="2.1. Getting Started with MSS for JBoss AS7">Section 2.1, “Getting Started with MSS for JBoss AS7 ”</a> 
</p><p>
<a class="xref" href="#getting-started-with-MSS-Tomcat-AS7" title="2.2. Getting Started with MSS for Tomcat 7">Section 2.2, “Getting Started with MSS for Tomcat 7  ”</a> 
</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sfss-The_Location_Service"/>4.1.1. The Location Service</h3></div></div></div><p>The Mobicents Location Service contains a list of mappings of
request URIs to destination addresses. When the Location Service receives
a request, it performs a lookup on that mapping and proxies the request
simultaneously to the destination address (or addresses) associated with
that URI.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><a id="sfss-The_Location_Service_Mappings_Cannot_Currently_Be_Configured"/><h2>The Location Service Mappings Cannot Currently Be Configured</h2><p>The Location Service currently performs a lookup on a hard-coded
list of addresses. This model is evolving toward the eventual use of a
database.</p></div><p>Regardless of whether you are using the JBoss Application Server or
the Tomcat Servlet Container as the Servlets Server, the application,
container and Location Service perform the following steps:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>A user—let us call her Alice—makes a call to
<code class="literal">sip:receiver@sip-servlets.com</code>. The
<code class="literal">INVITE</code> is received by the servlet container, which
then starts the Location Service.</p></li><li class="listitem"><p>The Location Service, using non-SIP means, determines that the
callee (i.e. the receiver) is registered at two locations, identified
by the two SIP URIs, <code class="literal">sip:receiver@127.0.0.1:5090</code>
and <code class="literal">sip:receiver@127.0.0.1:6090</code>.</p></li><li class="listitem"><p>The Location Service proxies to those two destinations in
parallel, without record-routing, and without making use of supervised
mode.</p></li><li class="listitem"><p>One of the destinations returns a <code class="literal">200 OK</code>
status code; the second proxy is then canceled.</p></li><li class="listitem"><p>The <code class="literal">200 OK</code> is forwarded to Alice, and call
setup is completed as usual.</p></li></ul></div><p>Here is the current list of hard-coded contacts and their location
URIs:</p><div class="itemizedlist"><p class="title"><strong>sip:receiver@sip-servlets.com</strong></p><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="literal">sip:receiver@127.0.0.1:5090</code></p></li><li class="listitem"><p><code class="literal">sip:receiver@127.0.0.1:6090</code></p></li></ul></div><div class="section"><div class="titlepage"/><p><a id="sfss-binary-Location_Service-Downloading"/><strong>Downloading. </strong>The Location Service is comprised of two archive files, a Web
Archive (WAR) and a Default Application Router (DAR) configuration
file, which you need to add to your installed SIP Servlets Server. For
more information about WAR files, refer to the <a class="ulink" href="http://www.jboss.org/file-access/default/members/jbossas/freezone/docs/Server_Configuration_Guide/beta422/html/index.html">JBoss Application Server Administration and Development Guide</a>. For
more information about DAR files, refer to the <a class="ulink" href="http://jcp.org/en/jsr/detail?id=289">JSR 289 spec, Appendix C</a>.</p><p>Download the Location Service's WAR file from here: <a class="ulink" href="https://oss.sonatype.org/content/groups/public/org/mobicents/servlet/sip/examples/location-service/3.0.564/location-service-3.0.564.war">https://oss.sonatype.org/content/groups/public/org/mobicents/servlet/sip/examples/location-service/3.0.564/location-service-3.0.564.war</a>.</p><p>Download the Location Service's DAR file from here: <a class="ulink" href="https://sipservlets.googlecode.com/git/sip-servlets-examples/location-service/locationservice-dar.properties">https://sipservlets.googlecode.com/git/sip-servlets-examples/location-service/locationservice-dar.properties</a>.</p><p><a id="sfss-binary-Location_Service-Installing"/><strong>Installing. </strong>Both the <code class="filename">location-service-3.0.564.war</code> WAR file
and the <code class="filename">locationservice-dar.properties</code> DAR file
that you downloaded should be placed into different directories in
your SIP Servlet Server installation hierarchy. Which directory
depends on whether you are using the Location Service with MSS for
JBoss or with MSS for Tomcat:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">MSS for JBoss AS7</span></dt><dd><p>Place <code class="filename">location-service-3.0.564.war</code> into the
<code class="filename"><code class="envar">$JBOSS_HOME</code>/standalone/deployments/</code>
directory, and <code class="filename">locationservice-dar.properties</code>
into the
<code class="filename"><code class="envar">$JBOSS_HOME</code>/standalone/configuration/dars/
</code>
directory.</p></dd><dt><span class="term">MSS for Tomcat AS7</span></dt><dd><p>Place <code class="filename">location-service-3.0.564.war</code> into the
<code class="filename"><code class="envar">$CATALINA_HOME</code>/webapps/</code>
directory, and <code class="filename">locationservice-dar.properties</code>
into the
<code class="filename"><code class="envar">$CATALINA_HOME</code>/conf/dars/</code>
directory.</p></dd></dl></div><p><a id="sfss-binary-Location_Service-Configuring"/><strong>Configuration. </strong></p><div class="variablelist"><dl class="variablelist"><dt><span class="term">MSS for JBoss</span></dt><dd><div class="example"><a id="sfss-Editing_SS_for_JBoss_server.xml_for_the_Location_Service"/><p class="title"><strong>Example 4.1. Editing MSS for JBoss's standalone-sip.xml for the Location Service</strong></p><div class="example-contents"/></div><br class="example-break"/><pre class="screen">
In the $JBOSS_HOME/standalone/configuration/standalone-sip.xml file search for the line 

 &lt;subsystem xmlns="urn:org.mobicents:sip-servlets-as7:1.0" 
application-router="dars/mobicents-dar.properties" 

and replace it with the line below

 &lt;subsystem xmlns="urn:org.mobicents:sip-servlets-as7:1.0"
 application-router="dars/locationservice-dar.properties" 
</pre></dd><dt><span class="term">MSS for Tomcat</span></dt><dd><p>Open the
<code class="filename"><code class="envar">$CATALINA_HOME</code>/conf/server.xml</code>
configuration file and find the <code class="literal">Service</code>
element. Add an attribute to it called
<strong class="userinput"><code>darConfigurationFileLocation</code></strong>, and set it to
<strong class="userinput"><code>conf/dars/locationservice-dar.properties</code></strong>:</p><div class="example"><a id="sfss-Editing_MSS_for_Tomcats_server.xml_for_the_Location_Service"/><p class="title"><strong>Example 4.2. Editing MSS for Tomcat's server.xml for the Location Service</strong></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;Service
name="Sip-Servlets"
className="org.mobicents.servlet.sip.startup.SipStandardService"
sipApplicationDispatcherClassName="org.mobicents.servlet.sip.core.SipApplicationDispatcherImpl"
darConfigurationFileLocation="conf/dars/locationservice-dar.properties"
sipStackPropertiesFile="conf/mss-sip-stack.properties"&gt;</pre></div></div><br class="example-break"/><p>Make sure that the configuration file only contains one
<code class="literal">darConfigurationFileLocation</code> attribute: your
new one.</p></dd></dl></div><p><a id="sfss-binary-Location_Service-Running"/><strong>Running. </strong>Once the WAR and DAR files have been placed in the right
directories, and the JBoss Application Server or Tomcat Servlet
Container knows where to find them (which you specified in the <code class="filename">standalone-sip.xml</code> and
<code class="filename">server.xml</code> file), then you should go ahead and
run the SIP Servlets Server.</p><p><a id="sfss-binary-Location_Service-Testing"/><strong>Testing. </strong>The following procedure shows how to test the Location
Service.</p><div class="procedure"><a id="d0e2440"/><p class="title"><strong>Procedure 4.1. </strong></p><ol class="procedure" type="1"><li class="step"><p>Start two SIP soft-phones. The first phone should be set up as
<strong class="userinput"><code>sip:receiver@sip-servlets.com</code></strong> at the IP address
<strong class="userinput"><code>127.0.0.1</code></strong> on port
<strong class="userinput"><code>5090</code></strong>. The second phone can be set up in any
way you like. Note that the SIP phones do not have to be
registered.</p></li><li class="step"><p>Using the second phone, make a call to
<code class="literal">sip:receiver@sip-servlets.com</code>. If the Location
Service has been set up correctly and is running, the first phone—as
the receiver or callee—should now be ringing.</p></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sfss-The_Diameter_Event-Changing_Service"/>4.1.2. The Diameter Event-Changing Service</h3></div></div></div><p>The Diameter Event-Changing Service is based on the Location
Service, which performs call-charging at a fixed rate. Upon the initiation
of a call, a debit of €10.00 occurs. In the cases of a call being rejected
or the caller disconnecting (hanging up) before an answer is received, the
caller's account is refunded.</p><p>Note that an MSS for JBoss installation is required to run this
example; it will not work with MSS for Tomcat.</p><p>Provided here is a step-by-step description of the procedure as
performed by the application and container:</p><div class="procedure"><a id="sfss-Diameter_Event-Changing_Service_Step-By-Step"/><p class="title"><strong>Procedure 4.2. Diameter Event-Changing Service Step-By-Step</strong></p><ol class="procedure" type="1"><li class="step"><p>A user, Alice, makes a call to
<code class="literal">sip:receiver@sip-servlets.com</code>. The
<code class="literal">INVITE</code> is received by the servlet container, which
sends a request to debit Alice's account to the Charging Server. The
servlet container then invokes the location service.</p></li><li class="step"><p>The Location Service determines, without using the SIP protocol
itself, where the callee—or receiver—is registered. The callee may be
registered at two locations identified by two SIP URIs:
<code class="literal">sip:receiver@127.0.0.1:5090</code> and
<code class="literal">sip:receiver@127.0.0.1:6090</code>.</p></li><li class="step"><p>The Location Service proxies to those two destinations
simultaneously, without record-routing and without using the supervised
mode.</p></li><li class="step"><p>One of the destinations returns <code class="literal">200 (OK)</code>, and
so the container cancels the other.</p></li><li class="step"><p>The <code class="literal">200 (OK)</code> is forwarded upstream to Alice,
and the call setup is carried out as usual.</p></li><li class="step"><p>If none of the registered destinations accepts the
call, a Diameter Accounting-Request for refund is sent to the Diameter
Charging Server in order to debit the already-credited €10.00</p></li></ol></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="sfss-binary-Diameter_Event-Changing_Service--Installing_Configuring_and_Running"/>4.1.2.1. Diameter Event-Changing Service: Installing, Configuring and Running</h4></div></div></div><p>Preparing your MSS for JBoss server to run the Diameter
Event-Changing example requires downloading a WAR archive, a DAR
archive, the Ericsson Charging Emulator, setting an attribute in JBoss's
<code class="filename">standalone-sip.xml</code> configuration file, and then running
JBoss AS. Detailed instructions in the section below.</p><p><a id="sfss-binary-Diameter_Event-Changing_Service-Pre-Install_Requirements_and_Prerequisites"/><strong>Pre-Install Requirements and Prerequisites. </strong>The following requirements must be met before installation can begin.</p><div class="variablelist"><a id="sfss-binary-Diameter_Event-Changing_Service-Software_Prerequisites"/><p class="title"><strong>Software Prerequisites</strong></p><dl class="variablelist"><dt><span class="term">One MSS for JBoss Installation</span></dt><dd><p>Before proceeding, you should follow the instructions for
installing, configuring, running and testing MSS for JBoss from
the binary distribution.</p></dd></dl></div><p><a id="sfss-binary-Diameter_Event-Changing_Service-Downloading"/><strong>Downloading. </strong>The following procedure describes how to download the required files.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>First, download the latest Web Application Archive
(<acronym class="acronym">WAR</acronym>) file corresponding to this example, the
current version of which is named
<code class="filename">diameter-event-charging-*.war</code>, from <a class="ulink" href="https://oss.sonatype.org/content/groups/public/org/mobicents/servlet/sip/examples/diameter-event-charging/3.0.564/diameter-event-charging-3.0.564.war">https://oss.sonatype.org/content/groups/public/org/mobicents/servlet/sip/examples/diameter-event-charging/3.0.564/diameter-event-charging-3.0.564.war</a>.</p></li><li class="step"><p>Secondly, download the corresponding Disk Archive
(<acronym class="acronym">DAR</acronym>) configuration file here:
<a class="ulink" href="https://sipservlets.googlecode.com/git/sip-servlets-examples/diameter-event-charging/diametereventcharging-dar.properties">https://sipservlets.googlecode.com/git/sip-servlets-examples/diameter-event-charging/diametereventcharging-dar.properties</a>.</p></li><li class="step"><p>Finally, you will need to download the Ericsson Charging
Emulator, version 1.0, from <a class="ulink" href="http://mobicents.googlecode.com/files/ChargingSDK-1_0_D31E.zip">http://mobicents.googlecode.com/files/ChargingSDK-1_0_D31E.zip</a>.</p></li></ol></div><p><a id="sfss-binary-Diameter_Event-Changing_Service-Installing"/><strong>Installing. </strong>The following procedure describes how to install the downloaded files.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Place the <code class="filename">diameter-event-charging-3.0.564.war</code>
WAR archive into the
<code class="filename">$JBOSS_HOME/standalone/deployments/</code>
directory.</p></li><li class="step"><p>Place the
<code class="filename">diametereventcharging-dar.properties</code> DAR file
in your
$JBOSS_HOME/standalone/configuration/dars/ 
directory.</p></li><li class="step"><p>Finally, open the terminal, move into the directory to which
you downloaded the Ericsson Charging SDK (for the sake of this
example, we will call this directory
<code class="filename">charging_sdk</code>), and then unzip the downloaded
zip file (you can use Java's <span class="command"><strong>jar <code class="option">-xvf</code></strong></span> command for this:</p><pre class="screen">~]$ cd charging_sdk
charging_sdk]$ jar -xvf ChargingSDK-1_0_D31E.zip</pre><p>Alternatively, you can use Linux's <span class="command"><strong>unzip</strong></span>
command to do the dirty work:</p><pre class="screen">charging_sdk]$ unzip ChargingSDK-1_0_D31E.zip</pre></li></ol></div><p><a id="sfss-binary-Diameter_Event-Changing_Service-Configuring"/><strong>Configuration. </strong></p><div class="variablelist"><dl class="variablelist"><dt><span class="term">MSS for JBoss</span></dt><dd><div class="example"><a id="sfss-Editing_the_darConfigurationFileLocation_Attribute_of_the_Service_Tag"/><p class="title"><strong>Example 4.3. Editing the standalone-sip.xml for the Diameter Event-Changer Service</strong></p><div class="example-contents"/></div><br class="example-break"/><pre class="screen">
In the $JBOSS_HOME/standalone/configuration/standalone-sip.xml
make sure the application router is pointing the mobicents-dar.properties file as follows. 

 &lt;subsystem xmlns="urn:org.mobicents:sip-servlets-as7:1.0" 
application-router="dars/mobicents-dar.properties" 

 
</pre></dd></dl></div><p><a id="sfss-binary-Diameter_Event-Changing_Service-Running"/><strong>Running. </strong>The following procedure describes how to run the Diameter Event-Changing Service.</p><div class="procedure"><a id="sfss-Diameter_Event-Changing_Service"/><p class="title"><strong>Procedure 4.3. Diameter Event-Changing Service</strong></p><ul class="procedure"><li class="step"><p>Then, run the Ericsson Charging Emulator. Open a terminal,
change the working directory to the location of the unzipped
Charging Emulator files (in
<code class="filename">ChargingSDK-1_0_D31E</code> or a similarly-named
directory), and run it with the <span class="command"><strong>java -jar <code class="filename">PPSDiamEmul.jar</code></strong></span> command:</p><pre class="screen">~]$ java -jar PPSDiamEmul.jar</pre></li></ul></div><p><a id="sfss-binary-Diameter_Event-Changing_Service-Using"/><strong>Using. </strong>Using the Event-Changing service means, firstly, inserting some
parameters into the Charging Emulator, and then, by using two SIP
(soft)phones, calling one with the other. The following sequential
instructions show you how.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><a id="sfss-SIP_SoftPhone_Which"/><h2>SIP (Soft)Phone? Which?</h2><p>The Mobicents team recommends one of the following SIP phones,
and has found that they work well: the 3CX Phone, the SJ Phone or the
WengoPhone.</p></div><div class="procedure"><a id="sfss-Using_the_Diameter_Event-Changing_Service"/><p class="title"><strong>Procedure 4.4. Using the Diameter Event-Changing Service</strong></p><ol class="procedure" type="1"><li class="step"><p class="title"><strong>Configure the Ericsson SDK Charging Emulator</strong></p><p>Once you have started the Charging Emulator, you should
configure it exactly as portrayed in <a class="xref" href="#figure-mss-ChargingEmulatorConfig" title="Figure 4.1. Configuring the Charging Emulator">Figure 4.1, “Configuring the Charging Emulator”</a>.</p><div class="figure"><a id="figure-mss-ChargingEmulatorConfig"/><p class="title"><strong>Figure 4.1. Configuring the Charging Emulator</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="sfss-mss-DiameterEventChanging-ss-ChargingEmulatorConfig"/><img src="images/mss-DiameterEventChanging-ss-ChargingEmulatorConfig.png" align="middle" alt="Configuring the Charging Emulator"/></div></div></div><br class="figure-break"/><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Set the <code class="literal">Peer ID</code> to:
<strong class="userinput"><code>aaa://127.0.0.1:21812</code></strong></p></li><li class="listitem"><p>Set the <code class="literal">Realm</code> to:
<strong class="userinput"><code>mobicents.org</code></strong></p></li><li class="listitem"><p>Set the <code class="literal">Host IP</code> to:
<strong class="userinput"><code>127.0.0.1</code></strong></p></li></ol></div></li><li class="step"><p>Start two SIP (soft)phones. You should set the first phone up
with the following parameters:
<strong class="userinput"><code>sip:receiver@sip-servlets</code></strong> on IP address
<strong class="userinput"><code>127.0.0.1</code></strong> on port
<strong class="userinput"><code>5090</code></strong>. The other phone can be set up any way
you like.</p></li><li class="step"><p>Before making a call, open the <span class="guimenu">Config</span> → <span class="guimenuitem">Options</span> dialog window, as shown in the image.</p><div class="figure"><a id="d0e2720"/><p class="title"><strong>Figure 4.2. Configuring Accounts in the Charging Emulator</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="sfss-mss-DiameterEventChanging-ss-ChargingAccountConfig"/><img src="images/mss-DiameterEventChanging-ss-ChargingAccountConfig.png" align="middle" alt="Configuring Accounts in the Charging Emulator"/></div></div></div><br class="figure-break"/><p>In the <span class="guilabel">Account Configuration</span> window of
the Charging Emulator, you can see the user's balances. Select a
user to watch the balance. You can also stretch the window
lengthwise to view the user's transaction history.</p></li><li class="step"><p>Time to call! From the second,
<span class="quote">“<span class="quote">any-configuration</span>”</span> phone, make a call to
<code class="literal">sip:receiver@sip-servlets.com</code>. Upon doing so, the
other phone should ring or signal that it is being contacted
.</p></li><li class="step"><p>You should be able to see a request—immediately following the
invite and before the other party (i.e. you) accepts or rejects the
call—sent to the Charging Emulator. That is when the debit of the
user's account is made. In the case that the call is rejected, or
the caller gives up, a second, new Diameter request is sent to
refund the initial amount charged by the call. On the other hand, if
the call is accepted, nothing else related to Diameter happens, and
no second request takes place.</p><p>Please note that this is not the correct way to do
charging, as Diameter provides other means, such as unit
reservation. However, for the purpose of a demonstration it is
sufficient to show the debit and follow-up credit working. Also,
this is a fixed-price call, regardless of the duration. Charging
can, of course, be configured so that it is time-based.</p></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sfss-The_Call-Blocking_Service"/>4.1.3. The Call-Blocking Service</h3></div></div></div><p>The Mobicents Call-Blocking Service, upon receiving an
<code class="literal">INVITE</code> request, checks to see whether the sender's
address is a blocked contact. If so, it returns a
<code class="literal">FORBIDDEN</code> reply; otherwise, call setup proceeds as
normal.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><a id="sfss-Blocked_Contacts_Cannot_Currently_Be_Configured"/><h2>Blocked Contacts Cannot Currently Be Configured</h2><p>Blocked contacts are currently hard-coded addresses. This model is
evolving towards the eventual use of a database.</p></div><p>Here is the current hard-coded list of blocked contacts:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="literal">sip:blocked-sender@sip-servlets.com</code></p></li><li class="listitem"><p><code class="literal">sip:blocked-sender@127.0.0.1</code></p></li></ul></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="sfss-binary-Call-Blocking_Service--Installing_Configuring_and_Running"/>4.1.3.1. The Call-Blocking Service: Installing, Configuring and Running</h4></div></div></div><p> </p><div class="variablelist"><a id="sfss-binary-Call-Blocking_Service-Software_Prerequisites"/><p class="title"><strong>Software Prerequisites</strong></p><dl class="variablelist"><dt><span class="term">Either an MSS for JBoss or an MSS for Tomcat Installation</span></dt><dd><p>The Call-Blocking Service requires either an MSS for JBoss
or an MSS for Tomcat binary installation.</p><p>You can find detailed instructions on installing MSS for
JBoss here: <a class="xref" href="#getting-started-with-MSS-JBOSS-AS7" title="2.1. Getting Started with MSS for JBoss AS7">Section 2.1, “Getting Started with MSS for JBoss AS7 ”</a>.
</p><p>You can find detailed instructions on installing MSS for
Tomcat here: <a class="xref" href="#bssswticar-SIP_Servlets_Server_with_Tomcat-Installing_Configuring_and_Running" title="2.2.2. Tomcat for Windows">Section 2.2.2, “Tomcat for Windows ”</a>.
</p></dd></dl></div><p><a id="sfss-binary-Call-Blocking_Service-Downloading"/><strong>Downloading. </strong>The Call-Blocking Service is comprised of two archive files, a
Web Archive (WAR) and a Default Application Router (DAR) configuration
file, which you need to add to your installed SIP Servlets Server. For
more information about WAR files, refer to the <a class="ulink" href="http://www.jboss.org/file-access/default/members/jbossas/freezone/docs/Server_Configuration_Guide/beta422/html/index.html">JBoss Application Server Administration and Development Guide</a>. For
more information about DAR files, refer to the <a class="ulink" href="http://jcp.org/en/jsr/detail?id=289">JSR 289 spec, Appendix C</a>.</p><p>Download the Call-Blocking Service's WAR file from here: <a class="ulink" href="https://oss.sonatype.org/content/groups/public/org/mobicents/servlet/sip/examples/call-blocking/3.0.564/call-blocking-3.0.564.war">https://oss.sonatype.org/content/groups/public/org/mobicents/servlet/sip/examples/call-blocking/3.0.564/call-blocking-3.0.564.war</a>.</p><p>Download the Call-Blocking Service's DAR file from here: <a class="ulink" href="https://sipservlets.googlecode.com/git/sip-servlets-examples/call-blocking/call-blocking-servlet-dar.properties">https://sipservlets.googlecode.com/git/sip-servlets-examples/call-blocking/call-blocking-servlet-dar.properties</a>.</p><p><a id="sfss-binary-Call-Blocking_Service-Installing"/><strong>Installing. </strong>Both the <code class="filename">call-blocking-3.0.564.war</code> WAR file and
the <code class="filename">call-blocking-servlet-dar.properties</code> DAR file
that you downloaded should be placed into different directories in
your SIP Servlet Server installation hierarchy. Which directory depends
on whether you are using the Call-Blocking Service with MSS for JBoss
or with MSS for Tomcat:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">MSS for JBoss</span></dt><dd><p>Place <code class="filename">call-blocking-3.0.564.war</code> into the
<code class="filename"><code class="envar">$JBOSS_HOME</code>/standalone/deployments/</code>
directory, and
<code class="filename">call-blocking-servlet-dar.properties</code> into the
<code class="filename"><code class="envar">$JBOSS_HOME</code>/standalone/configuration/dars/</code>
directory.</p></dd><dt><span class="term">MSS for Tomcat</span></dt><dd><p>Place
<code class="filename">call-blocking-servlet-dar.properties</code> into the
<code class="filename"><code class="envar">$CATALINA_HOME</code>/webapps/</code>
directory, and
<code class="filename">call-blocking-servlet-dar.properties</code> into the
<code class="filename"><code class="envar">$CATALINA_HOME</code>/conf/dars/</code>
directory.</p></dd></dl></div><p><a id="sfss-binary-Call-Blocking_Service-Configuring"/><strong>Configuring. </strong></p><div class="variablelist"><dl class="variablelist"><dt><span class="term">MSS for JBoss</span></dt><dd><div class="example"><a id="sfss-Editing_the_callBlockingService_Attribute_of_the_Service_Tag"/><p class="title"><strong>Example 4.4. Editing the standalone-sip.xml file for Call Blocking</strong></p><div class="example-contents"/></div><br class="example-break"/><pre class="screen">
In the $JBOSS_HOME/standalone/configuration/standalone-sip.xml search for the line below
 
 &lt;subsystem xmlns="urn:org.mobicents:sip-servlets-as7:1.0" 
 application-router="dars/mobicents-dar.properties"  

change it to the following

 &lt;subsystem xmlns="urn:org.mobicents:sip-servlets-as7:1.0" 
 application-router="dars/call-blocking-servlet-dar.properties" 

 </pre></dd></dl></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">MSS for Tomcat</span></dt><dd><p>Open the
<code class="filename"><code class="envar">$CATALINA_HOME</code>/conf/server.xml</code>
configuration file and find the <code class="literal">Service</code>
element. Add an attribute to it called
<strong class="userinput"><code>darConfigurationFileLocation</code></strong>, and set it to
<strong class="userinput"><code>conf/dars/call-blocking-servlet-dar.properties</code></strong>:</p><div class="example"><a id="sfss-Editing_MSS_for_Tomcats_server.xml_for_the_Call-Blocking_Service"/><p class="title"><strong>Example 4.5. Editing MSS for Tomcat's server.xml for the Call-Blocking Service</strong></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;Service
name="Sip-Servlets"
className="org.mobicents.servlet.sip.startup.SipStandardService"
sipApplicationDispatcherClassName="org.mobicents.servlet.sip.core.SipApplicationDispatcherImpl"
darConfigurationFileLocation="conf/dars/call-blocking-servlet-dar.properties"
sipStackPropertiesFile="conf/mss-sip-stack.properties"&gt;</pre></div></div><br class="example-break"/><p>Make sure that the configuration file only contains one
<code class="literal">darConfigurationFileLocation</code> attribute: your
new one.</p></dd></dl></div><p><a id="sfss-binary-Call-Blocking_Service-Running"/><strong>Running. </strong>Once the WAR and DAR files have been placed in the right
directories, and the JBoss Application Server or Tomcat Servlet
Container knows where to find them (which you specified in a
<code class="filename">server.xml</code> and the <code class="filename">standalone-sip.xml</code>  files), then you should go ahead and
run the SIP Servlets Server.</p><p><a id="sfss-binary-Call-Blocking_Service-Testing"/><strong>Testing. </strong>The following procedure shows how to test the Call-Blocking
Service.</p><div class="procedure"><a id="d0e2937"/><p class="title"><strong>Procedure 4.5. Testing the Call Blocking Service</strong></p><ol class="procedure" type="1"><li class="step"><p>Start a SIP softphone of your choice. The account name should
be <strong class="userinput"><code>blocked-sender</code></strong>. The <code class="literal">From Header</code> should list one of the following addresses:
<strong class="userinput"><code>sip:blocked-sender@sip-servlets.com</code></strong> or
<strong class="userinput"><code>sip:blocked-sender@127.0.0.1</code></strong>. The SIP
softphone does not need to be registered.</p></li><li class="step"><p>Make a call to any address, and you should receive a
<code class="literal">FORBIDDEN</code> response.</p></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sfss-The_Call-Forwarding_Service"/>4.1.4. The Call-Forwarding Service</h3></div></div></div><p>The Mobicents Call-Forwarding Service, upon receiving an
<code class="literal">INVITE</code> request, checks to see whether the sender's
address is among those in a list of addresses which need to be forwarded.
If so, then the Call-Forwarding Service acts as a Back-to-Back User Agent
(B2BUA), and creates a new call leg to the destination. When the response
is received from the new call leg, it sends it an acknowledgment
(<code class="literal">ACK</code>) and then responds to the original caller. If, on
the other hand, the server does not receive an <code class="literal">ACK</code>,
then it tears down the new call leg with a <code class="literal">BYE</code>. Once
the <code class="literal">BYE</code> is received, then it answers
<code class="literal">OK</code> directly and sends the <code class="literal">BYE</code> to
the new call leg.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><a id="sfss-Contacts_to_Forward_Cannot_Currently_Be_Configured"/><h2>Contacts to Forward Cannot Currently Be Configured</h2><p>Contacts to forward are currently hard-coded addresses. This model
is evolving toward the eventual use of a database.</p></div><p>Here is the current hard-coded list of contacts to forward:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="literal">sip:receiver@sip-servlets.com</code></p></li><li class="listitem"><p><code class="literal">sip:receiver@127.0.0.1</code></p></li></ul></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="sfss-binary-Call-Forwarding_Service--Installing_Configuring_and_Running"/>4.1.4.1. The Call-Forwarding Service: Installing, Configuring and Running</h4></div></div></div><p> </p><p><a id="sfss-binary-Call-Forwarding_Service-Pre-Install_Requirements_and_Prerequisites"/><strong>Pre-Install Requirements and Prerequisites. </strong>The following requirements must be met before installation can begin.</p><p><a id="sfss-binary-Call-Forwarding_Service-Downloading"/><strong>Downloading. </strong>The Call-Forwarding Service is comprised of two archive files, a
Web Archive (WAR) and a Data Archive (DAR), which you need to add to
your installed SIP Servlets Server. For more information about WAR and
DAR files, refer to the <a class="ulink" href="http://www.jboss.org/file-access/default/members/jbossas/freezone/docs/Server_Configuration_Guide/beta422/html/index.html">JBoss Application Server Administration and Development Guide</a>.</p><p>Download the Call-Forwarding Service's WAR file from here: <a class="ulink" href="https://oss.sonatype.org/content/groups/public/org/mobicents/servlet/sip/examples/call-forwarding/3.0.564/call-forwarding-3.0.564.war">https://oss.sonatype.org/content/groups/public/org/mobicents/servlet/sip/examples/call-forwarding/3.0.564/call-forwarding-3.0.564.war</a>.</p><p>Download the Call-Forwarding Service's DAR file from here: <a class="ulink" href="https://sipservlets.googlecode.com/git/sip-servlets-examples/call-forwarding/call-forwarding-b2bua-servlet-dar.properties">https://sipservlets.googlecode.com/git/sip-servlets-examples/call-forwarding/call-forwarding-b2bua-servlet-dar.properties</a>.</p><p><a id="sfss-binary-Call-Forwarding_Service-Installing"/><strong>Installing. </strong>Both the <code class="filename">call-forwarding-3.0.564.war</code> WAR file
and the <code class="filename">call-forwarding-servlet-dar.properties</code>
DAR file that you downloaded should be placed into different
directories in your SIP Servlet Server installation hierarchy. Which
directory depends on whether you are using the Call-Forwarding Service
with MSS for JBoss or with MSS for Tomcat:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">MSS for JBoss</span></dt><dd><p>Place <code class="filename">call-forwarding-3.0.564.war</code> into the
<code class="filename"><code class="envar">$JBOSS_HOME</code>/standalone/deployments/</code>
directory, and
<code class="filename">call-forwarding-servlet-dar.properties</code> into
the
<code class="filename"><code class="envar">$JBOSS_HOME</code>/standalone/configuration/dars/</code>
directory.</p></dd><dt><span class="term">MSS for Tomcat</span></dt><dd><p>Place <code class="filename">call-forwarding-3.0.564.war</code> into the
<code class="filename"><code class="envar">$CATALINA_HOME</code>/webapps/</code>
directory, and
<code class="filename">call-forwarding-servlet-dar.properties</code> into
the <code class="filename"><code class="envar">$CATALINA_HOME</code>/conf/dars/</code>
directory.</p></dd></dl></div><p><a id="sfss-binary-Call-Forwarding_Service-Configuring"/><strong>Configuring. </strong></p><div class="variablelist"><dl class="variablelist"><dt><span class="term">MSS for JBoss</span></dt><dd><div class="example"><a id="sfss-Editing_SS_for_JBoss_server.xml_for_the_Call-Forwarding_Service"/><p class="title"><strong>Example 4.6. Editing MSS for JBoss's standalone-sip.xml for the Call-Forwarding Service</strong></p><div class="example-contents"/></div><br class="example-break"/><pre class="screen">
In the $JBOSS_HOME/standalone/configuration/standalone-sip.xml search for the line below
 
 &lt;subsystem xmlns="urn:org.mobicents:sip-servlets-as7:1.0" 
 application-router="dars/mobicents-dar.properties"  

change it to the following

 &lt;subsystem xmlns="urn:org.mobicents:sip-servlets-as7:1.0" 
 application-router="dars/call-forwarding-b2bua-servlet-dar.properties" 

 
</pre></dd><dt><span class="term">MSS for Tomcat</span></dt><dd><p>Open the
<code class="filename"><code class="envar">$CATALINA_HOME</code>/conf/server.xml</code>
configuration file and find the <code class="literal">Service</code>
element. Add an attribute to it called
<strong class="userinput"><code>darConfigurationFileLocation</code></strong>, and set it to
<strong class="userinput"><code>conf/dars/call-forwarding-b2bua-servlet-dar.properties</code></strong>:</p><div class="example"><a id="sfss-Editing_MSS_for_Tomcats_server.xml_for_the_Call-Forwarding_Service"/><p class="title"><strong>Example 4.7. Editing MSS for Tomcat's server.xml for the Call-Forwarding Service</strong></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;Service
name="Sip-Servlets"
className="org.mobicents.servlet.sip.startup.SipStandardService"
sipApplicationDispatcherClassName="org.mobicents.servlet.sip.core.SipApplicationDispatcherImpl"
darConfigurationFileLocation="conf/dars/call-forwarding-b2bua-servlet-dar.properties"
sipStackPropertiesFile="conf/mss-sip-stack.properties"&gt;</pre></div></div><br class="example-break"/><p>Make sure that the configuration file only contains one
<code class="literal">darConfigurationFileLocation</code> attribute: your
new one.</p></dd></dl></div><p><a id="sfss-binary-Call-Forwarding_Service-Running"/><strong>Running. </strong>Once the WAR and DAR files have been placed in the right
directories, and the JBoss Application Server or Tomcat Servlet
Container knows where to find them (which you specified in a
<code class="filename">standalone-sip.xml</code> and <code class="filename">server.xml</code>  files), then you should go ahead and
run the SIP Servlets Server.</p><p><a id="sfss-binary-Call-Forwarding_Service-Testing"/><strong>Testing. </strong>The following procedure shows how to test the Call-Forwarding
Service.</p><div class="procedure"><a id="d0e3152"/><p class="title"><strong>Procedure 4.6. </strong></p><ol class="procedure" type="1"><li class="step"><p>Start two SIP soft-phones of your choice. Set the account
settings of the first SIP softphone to:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Account name:
<strong class="userinput"><code>forward-receiver</code></strong></p></li><li class="listitem"><p>IP address: <strong class="userinput"><code>127.0.0.1</code></strong></p></li><li class="listitem"><p>Port: <strong class="userinput"><code>5090</code></strong></p></li></ul></div><p>Neither of the SIP soft-phones needs to be registered.</p></li><li class="step"><p>From the second phone, make a call to
<code class="literal">sip:receiver@sip-servlets.com</code>. The first phone,
"forward-receiver", should now be ringing.</p></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sfss-The_Call-Controller_Service"/>4.1.5. The Call-Controller Service</h3></div></div></div><p>The Call-Controller service is a composition of two other services:
Call-Blocking and Call-Forwarding. Essentially, it performs the services
of both call-forwarding and call-blocking.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>To learn about how the Call-Blocking service works, refer to
<a class="xref" href="#sfss-The_Call-Blocking_Service" title="4.1.3. The Call-Blocking Service">Section 4.1.3, “The Call-Blocking Service”</a>.</p></li><li class="listitem"><p>To learn about how the Call-Forwarding service works, refer to
<a class="xref" href="#sfss-The_Call-Forwarding_Service" title="4.1.4. The Call-Forwarding Service">Section 4.1.4, “The Call-Forwarding Service”</a>.</p></li></ul></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><a id="sfss-Blocked_Contacts_and_Contacts_to_Forward_Cannot_Currently_Be_Configured"/><h2>Blocked Contacts and Contacts to Forward Cannot Currently Be Configured</h2><p>Both the list of blocked contacts and the list of contacts to
forward are currently both hard-coded. However, both of those models are
evolving toward the eventual use of databases.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="sfss-binary-Call-Controller_Service--Installing_Configuring_and_Running"/>4.1.5.1. The Call-Controller Service: Installing, Configuring and Running</h4></div></div></div><p>The Call-Controller service requires the two WAR files for the
Call-Blocking and Call-Forwarding services to be placed in the correct
directory inside your Mobicents SIP Servlets Server binary installation.
However, the Call-Controller service does <span class="emphasis"><em>not</em></span>
require their corresponding DAR files: you need only to download and
install a DAR file customized for the Call-Controller service. The
instructions below show you how to do precisely this; there is no need,
therefore, to first install either the Call-Blocking or the
Call-Forwarding services, though it is helpful to at least be familiar
with them.</p><p><a id="sfss-binary-Call-Controller_Service-Pre-Install_Requirements_and_Prerequisites"/><strong>Pre-Install Requirements and Prerequisites. </strong>The following requirements must be met before installation can begin.</p><p><a id="sfss-binary-Call-Controller_Service-Downloading"/><strong>Downloading. </strong>The Call-Controller Service is comprised of two WAR files, one
for the Call-Forwarding service and one for Call-Blocking, and a
customized Call-Controller DAR file. You do not need to install the
DAR files for the Call-Forwarding or the Call-Blocking services. For
more information about WAR files, refer to the <a class="ulink" href="http://www.jboss.org/file-access/default/members/jbossas/freezone/docs/Server_Configuration_Guide/beta422/html/index.html">JBoss Application Server Administration and Development Guide</a>. For
more information about DAR files, refer to the <a class="ulink" href="http://jcp.org/en/jsr/detail?id=289">JSR 289 spec, Appendix C</a></p><p>Download the Call-Blocking Service's WAR file from here: <a class="ulink" href="https://oss.sonatype.org/content/groups/public/org/mobicents/servlet/sip/examples/call-blocking/3.0.564/call-blocking-3.0.564.war">https://oss.sonatype.org/content/groups/public/org/mobicents/servlet/sip/examples/call-blocking/3.0.564/call-blocking-3.0.564.war</a>.</p><p>Download the Call-Forwarding Service's WAR file from here: <a class="ulink" href="https://oss.sonatype.org/content/groups/public/org/mobicents/servlet/sip/examples/call-forwarding/3.0.564/call-forwarding-3.0.564.war">https://oss.sonatype.org/content/groups/public/org/mobicents/servlet/sip/examples/call-forwarding/3.0.564/call-forwarding-3.0.564.war</a>.</p><p>Download the Call-Controller Service's DAR file from here: <a class="ulink" href="https://sipservlets.googlecode.com/git/sip-servlets-examples/call-blocking/call-controller-servlet-dar.properties">https://sipservlets.googlecode.com/git/sip-servlets-examples/call-blocking/call-controller-servlet-dar.properties</a>.</p><p><a id="sfss-binary-Call-Controller_Service-Installing"/><strong>Installing. </strong>The <code class="filename">call-blocking-3.0.564.war</code>,
<code class="filename">call-forwarding-3.0.564.war</code> and
<code class="filename">call-controller-servlet-dar.properties</code> archive
files that you downloaded should be placed into different directories
in your SIP Servlet Server installation hierarchy. Which directory
depends on whether you are using the Call-Controller Service with MSS
for JBoss or with MSS for Tomcat:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">MSS for JBoss</span></dt><dd><p>Place <code class="filename">call-blocking-3.0.564.war</code> and
<code class="filename">call-forwarding-3.0.564.war</code> into the
<code class="filename"><code class="envar">$JBOSS_HOME</code>/standalone/deployments/</code>
directory, and
<code class="filename">call-controller-servlet-dar.properties</code> into
the
<code class="filename"><code class="envar">$JBOSS_HOME</code>/standalone/configuration/dars/</code>
directory.</p></dd><dt><span class="term">MSS for Tomcat</span></dt><dd><p>Place <code class="filename">call-blocking-3.0.564.war</code> and
<code class="filename">call-forwarding-3.0.564.war</code> into the
<code class="filename"><code class="envar">$CATALINA_HOME</code>/webapps/</code>
directory, and
<code class="filename">call-controller-servlet-dar.properties</code> into
the <code class="filename"><code class="envar">$CATALINA_HOME</code>/conf/dars/</code>
directory.</p></dd></dl></div><p><a id="sfss-binary-Call-Controller_Service-Configuring"/><strong>Configuring. </strong></p><div class="variablelist"><dl class="variablelist"><dt><span class="term">MSS for JBoss</span></dt><dd><div class="example"><a id="d0e3316"/><p class="title"><strong>Example 4.8. Editing MSS for JBoss's standalone-sip.xml for the Call-Controller Service</strong></p><div class="example-contents"><pre class="screen">
In the $JBOSS_HOME/standalone/configuration/standalone-sip.xml search for the line below
 
 &lt;subsystem xmlns="urn:org.mobicents:sip-servlets-as7:1.0" 
 application-router="dars/mobicents-dar.properties"  

change it to the following

 &lt;subsystem xmlns="urn:org.mobicents:sip-servlets-as7:1.0" 
 application-router="dars/call-controller-servlet-dar.properties" 

 
</pre></div></div><br class="example-break"/><p>Make sure that the configuration file only contains one
<code class="literal">darConfigurationFileLocation</code> attribute: your
new one.</p></dd><dt><span class="term">MSS for Tomcat</span></dt><dd><p>Open the
<code class="filename"><code class="envar">$CATALINA_HOME</code>/conf/server.xml</code>
configuration file and find the <code class="literal">Service</code>
element. Add an attribute to it called
<strong class="userinput"><code>darConfigurationFileLocation</code></strong>, and set it to
<strong class="userinput"><code>conf/dars/call-controller-servlet-dar.properties </code></strong>:</p><div class="example"><a id="sfss-Editing_MSS_for_Tomcats_server.xml_for_the_Call-Controller_Service"/><p class="title"><strong>Example 4.9. Editing MSS for Tomcat's server.xml for the Call-Controller Service</strong></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;Service
name="Sip-Servlets"
className="org.mobicents.servlet.sip.startup.SipStandardService"
sipApplicationDispatcherClassName="org.mobicents.servlet.sip.core.SipApplicationDispatcherImpl"
darConfigurationFileLocation="conf/dars/call-controller-servlet-dar.properties "
sipStackPropertiesFile="conf/mss-sip-stack.properties"&gt;</pre></div></div><br class="example-break"/><p>Make sure that the configuration file only contains one
<code class="literal">darConfigurationFileLocation</code> attribute: your
new one.</p></dd></dl></div><p><a id="sfss-binary-Call-Controller_Service-Running"/><strong>Running. </strong>Once the WAR and DAR files have been placed in the right
directories, and the JBoss Application Server or Tomcat Servlet
Container knows where to find them (which you specified in a
<code class="filename">server.xml</code> file), then you should go ahead and
run the SIP Servlets Server.</p><p><a id="sfss-binary-Call-Controller_Service-Testing"/><strong>Testing. </strong>Two use-cases can be distinguished for the Call-Controller
service: one in which a call is blocked, and another in which a call
is forwarded. Therefore, we have two cases for which we can test the
Call-Controller.</p><div class="procedure"><a id="sfss-Blocking_a_Call_with_the_Call-Controller"/><p class="title"><strong>Procedure 4.7. Blocking a Call with Call-Controller</strong></p><ol class="procedure" type="1"><li class="step"><p>Start two SIP soft-phones of your choice. Set the account
settings of the SIP soft-phones to:</p><div class="itemizedlist"><p class="title"><strong>Relevant First Softphone Settings</strong></p><ul class="itemizedlist" type="disc"><li class="listitem"><p>Account name:
<strong class="userinput"><code>forward-receiver</code></strong></p></li><li class="listitem"><p>IP address: <strong class="userinput"><code>127.0.0.1</code></strong></p></li><li class="listitem"><p>Port: <strong class="userinput"><code>5090</code></strong></p></li></ul></div><div class="itemizedlist"><p class="title"><strong>Relevant Second Softphone Settings</strong></p><ul class="itemizedlist" type="disc"><li class="listitem"><p>Account name: <strong class="userinput"><code>blocked-sender</code></strong></p></li></ul></div><p>Neither of the SIP soft-phones needs to be registered.</p></li><li class="step"><p>From the second phone, <code class="literal">blocked-sender</code>, make
a call to <code class="literal">sip:receiver@sip-servlets.com</code>. You
should receive a <code class="literal">FORBIDDEN</code> response.</p></li></ol></div><div class="procedure"><a id="sfss-Forwarding_a_Call_with_the_Call-Controller"/><p class="title"><strong>Procedure 4.8. Forwarding a Call with Call-Controller</strong></p><ol class="procedure" type="1"><li class="step"><p>Start two SIP soft-phones of your choice. Set the account
settings of the SIP soft-phones to:</p><div class="itemizedlist"><p class="title"><strong>Relevant First Softphone Settings</strong></p><ul class="itemizedlist" type="disc"><li class="listitem"><p>Account name:
<strong class="userinput"><code>forward-receiver</code></strong></p></li><li class="listitem"><p>IP address: <strong class="userinput"><code>127.0.0.1</code></strong></p></li><li class="listitem"><p>Port: <strong class="userinput"><code>5090</code></strong></p></li></ul></div><div class="itemizedlist"><p class="title"><strong>Relevant Second Softphone Settings</strong></p><ul class="itemizedlist" type="disc"><li class="listitem"><p>Account name: <strong class="userinput"><code>forward-sender</code></strong></p></li></ul></div><p>Neither of the SIP soft-phones needs to be registered.</p></li><li class="step"><p>From the second softphone, <code class="literal">forward-sender</code>,
make a call to <code class="literal">sip:receiver@sip-servlets.com</code>. The
first phone, <code class="literal">forward-receiver</code>, should now be
ringing.</p></li></ol></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p><a class="xref" href="#ssea-SIP_Servlet_Example_Applications" title="Chapter 4. SIP Servlet Example Applications">Chapter 4, <em>SIP Servlet Example Applications</em></a>
provides more information about other service examples
available.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="mipbx-Media_IPBX"/>4.1.6. Media IPBX</h3></div></div></div><p>The Media IPBX provides an extensible and customizable SIP PBX solution, based on the Seam Telco Framework (STF).  While the PBX is currently provided as a capability demonstration, the ultimate goal is to transition Media IPBX into a fully-fledged SIP PBX solution.</p><p>Media IPBX terminates all calls to Mobicents Media Server conference endpoints, which provides flexibility in manipulating established calls including server-side conferencing and ring-back tones. The PBX can also be implemented as a Session Border Controller.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>Media IPBX is compatible with Mobicents SIP Servlets with JBoss AS 4.2.3. Versions prior to this release do not support Media IPBX.</p></div><p>Media IPBX provides the following major features:
      </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>User authentication.</p></li><li class="listitem"><p>SIP phone registration.</p></li><li class="listitem"><p>System configuration.</p></li><li class="listitem"><p>Individual user views.</p></li><li class="listitem"><p>Call monitoring and management.</p></li><li class="listitem"><p>Multiple SIP phone instances per user.</p></li><li class="listitem"><p>Status-based SIP phone assignment for incoming calls.</p></li><li class="listitem"><p>Public Switched Telephone Network (PSTN) support, including administrative functions.</p></li><li class="listitem"><p>Support for SIP REGISTER requests to automatically add phones by matching the username, or username and hostname (in 'strict mode' only).</p></li><li class="listitem"><p>Optionally specify local or online sources for announcements and ringback tones.</p></li><li class="listitem"><p>Session Border Controller capability.</p></li><li class="listitem"><p>Full conferencing support, including:</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><p>Privacy functions, including mute and closed-calls.</p></li><li class="listitem"><p>Call status announcement.</p></li><li class="listitem"><p>Ringback tones when waiting for other participants to join the conference.</p></li><li class="listitem"><p>Joining incoming calls to a conference.</p></li><li class="listitem"><p>Parking calls and isolating a single speaker using dual-tone multi-frequency (DTMF) tones.  This feature is currently experimental.</p></li></ul></div></li></ul></div><p>
    </p><p>Many of the features in Media IPBX are presented to the user as hints on the GUI portal pages. It is recommended that you install Media IPBX and experiment with the demonstration to gain an understanding of how the solution works.</p><p>For information about installing and running Media IPBX, including binary and source code locations, visit the <a class="ulink" href="http://www.mobicents.org/mss-ipbx.html">Media IPBX homepage</a>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="concept-chapter-SS_click2call"/>4.1.7. Tomcat Servlet Click2call Windows Setup</h3></div></div></div><p>
Mobicents SIP Servlets Server can be run on a JBoss Application Server or on the Tomcat Servlet Container. Here is how
to install and configure both JBoss a Microsoft Windows based system.
</p><p> 
Tomcat Servlet running on Microsoft Windows
The Mobicents Platform is based on Java, so you need to make sure you have both the Java Runtime Environment (JRE)
and, or the Java Development Kit (JDK) installed on your Windows based system. </p><p>
You can download the <a class="ulink" href="http://www.java.com/en/"> Java Runtime Environment here </a>. 

</p><p>
<li class="step">
Do to the following to open the cmd window
<pre class="screen"> menu &gt; Start &gt; Run &gt; CMD</pre>


In the black CMD window type 'java -version' You should see something similar to the screenshot below 



<div class="figure"><a id="d0e3560"/><p class="title"><strong>Figure 4.3. Testing if Java is installed and running</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="windows_cmd_test_java_running"/><img src="images/click2call_windows_cmd_test_java_running.png" align="middle" alt="Testing if Java is installed and running"/></div></div></div><br class="figure-break"/></li>
</p><p>
If you are a developer, you can get the <a class="ulink" href=""> Java Development Kit here </a>. 
It is recommended that you install the latest version of JDK. You can opt for the JDK Java SE (Standard Edition) for test purposes. 
Once you have downloaded JDK, you will see an executable like the one below in your download folder. 
</p><p>
<li class="step">
Double-click the .exe file and follow the menu to complete your installation. <pre class="screen"> Jdk-(version)-windows-i586.exe </pre><div class="figure"><a id="d0e3578"/><p class="title"><strong>Figure 4.4. JDK executable file</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="jdk_download_executable"/><img src="images/click2call_jdk_download_executable.png" align="middle" alt="JDK executable file"/></div></div></div><br class="figure-break"/></li>
</p><p>
JAVA_Home enviroment variable. 
In order for applications to interact with your Java installation, you need to specify the install location by setting the JAVA_HOME environment variable. 
Start the 'cmd' without the quotes and press Enter
</p><pre class="screen">
Start &gt; Run &gt; cmd
</pre><p>
</p><p>
In the CMD window, type </p><p>
</p><pre class="screen">
Set JAVA_HOME=C:\Java\jdk1.7.0_02
</pre><p>
</p><p>
</p><div class="figure"><a id="d0e3598"/><p class="title"><strong>Figure 4.5. Set environment variable</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="set_env_variable_windows"/><img src="images/click2call_set_env_variable_windows.png" align="middle" alt="Set environment variable"/></div></div></div><p><br class="figure-break"/>
</p><p>
This will set the environment variable for your session. The <code class="literal"> C:\Java\jdk1.7.0_02 </code> is the root folder where your JDK files are installed. You can go to <a class="ulink" href="http://support.microsoft.com/kb/931715"> this Microsoft page </a> to see how set your environment variable and make it permanent.
If you want to make sure the JDK environment variable is set, type </p><pre class="screen"> c:\&gt; Set </pre><p>
</p><p>
Installing Mobicents Tomcat on Windows. It is recommended that you install the latest Mobicents Sip Servlets. 
You can download the <a class="ulink" href="https://code.google.com/p/sipservlets/wiki/Downloads"> Mobicents SIP Servlets for Tomcat here </a>
Make sure you download the latest Tomcat and not the JBoss. 

</p><div class="figure"><a id="d0e3621"/><p class="title"><strong>Figure 4.6. Download Mobicents SIP Servlets for Tomcat</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="install_mobicents_tomcat_windows"/><img src="images/click2call_install_mobicents_tomcat_windows.png" align="middle" alt="Download Mobicents SIP Servlets for Tomcat"/></div></div></div><p><br class="figure-break"/>

The downloaded file will appear similar to this screenshot below

</p><div class="figure"><a id="d0e3628"/><p class="title"><strong>Figure 4.7. Downloaded Tomcat File </strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="click2call_download_latest_version_tomcat"/><img src="images/click2call_download_latest_version_tomcat.png" align="middle" alt="Downloaded Tomcat File"/></div></div></div><p><br class="figure-break"/>

The extracted file will look similar to this folder
</p><div class="figure"><a id="d0e3635"/><p class="title"><strong>Figure 4.8. Content of Tomcat Directory</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="content_mss_tomcat_directory"/><img src="images/click2call_content_mss_tomcat_directory.png" align="middle" alt="Content of Tomcat Directory"/></div></div></div><p><br class="figure-break"/> 
</p><p>

Once you have extracted the content of the MSS Tomcat server zip file, you need to set the CATALINA_HOME environment variable. Open the 'cmd' window 
</p><pre class="screen"> Start &gt; run &gt; cmd </pre><p>
In this example, the environment variable is set as follows:
</p><pre class="screen"> set CATALINA_HOME=C:\tomcat\3.0.564 </pre><p>

Start the MSS Tomcat Server

The \bin directory in the root of your Tomcat folder holds the executables you need to work with the MSS server application. 
To start the server, you need to execute the startup.bat file. First, start the cmd window as follows:
</p><pre class="screen">
Start &gt; run &gt; cmd 
</pre><p>



</p><div class="figure"><a id="d0e3653"/><p class="title"><strong>Figure 4.9. Start Tomcat Server</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="starting_tomcat_server"/><img src="images/click2call_starting_tomcat_server.png" align="middle" alt="Start Tomcat Server"/></div></div></div><p><br class="figure-break"/>


This will open another cmd.exe window similar to the one below


</p><div class="figure"><a id="d0e3660"/><p class="title"><strong>Figure 4.10. Tomcat Server Started</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="mss_tomcat_server_started"/><img src="images/click2call_mss_tomcat_server_started.png" align="middle" alt="Tomcat Server Started"/></div></div></div><p><br class="figure-break"/>

Note that the server is started and you can now begin to use the application.
</p><p>


Once the MSS Tomcat server is up and running, you should be able to go to http://localhost:8080/ 
and see the web server in action. If the page doesn’t open or you get an error message saying page 
is not found, the 8080 port might be in use by another service. You will have to change the port 
in the server.xml file located in the c:\TOMCAT_ROOT_FOLDER\conf\server.xml. You will need a text editor like Notepad++ to change the connector. 
Here is a screenshot of the server.xml file with the default port 8080.


</p><div class="figure"><a id="d0e3669"/><p class="title"><strong>Figure 4.11. Tomcat Default Http Port</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="changing_tomcat_http_default_port"/><img src="images/click2call_changing_tomcat_http_default_port.png" align="middle" alt="Tomcat Default Http Port"/></div></div></div><p><br class="figure-break"/>


The port number must be higher than 1024. In the example below, the port number for the connector has been change to 8040

</p><div class="figure"><a id="d0e3676"/><p class="title"><strong>Figure 4.12. Change Default Http Port to 8040</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="updated_tomcat_http_port"/><img src="images/click2call_updated_tomcat_http_port.png" align="middle" alt="Change Default Http Port to 8040"/></div></div></div><p><br class="figure-break"/>

</p><p>
You can use your internet browser to see the result by going to <code class="literal"> http://localhost:8040 </code>
You will see a page similar to the screenshot below

</p><div class="figure"><a id="d0e3688"/><p class="title"><strong>Figure 4.13. Localhost Homepage</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="localhost_http_homepage"/><img src="images/click2call_localhost_http_homepage.png" align="middle" alt="Localhost Homepage"/></div></div></div><p><br class="figure-break"/>

In order to manage the Click2call sip servlet clients, you need to navigate to the <code class="literal"> http://localhost:8040/click2call </code>
If you get an error message that says, page cannot be displayed, you need to make sure the
MSS Tomcat server is running by executing the startup.bat file in the <code class="literal"> MSS_Tomcat_root_folder\bin\startup.bat </code>
Here is a screenshot of what the Click2call applet will look like without any registered soft phone clients


</p><div class="figure"><a id="d0e3701"/><p class="title"><strong>Figure 4.14. Click2call Homepage</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="click2call_sip_servlets_sample_application"/><img src="images/click2call_sip_servlets_sample_application.png" align="middle" alt="Click2call Homepage"/></div></div></div><p><br class="figure-break"/> 

</p><p>
At the moment there are no registered users. That is because you need to get the softphone clients to register with the Tomcat server you started above.
You need to install a minimum of two soft phones in order to be able to run the sip servlet Click2Call sample.
In this example, we shall be using 2 soft phones clients, <span class="emphasis"><em> WengoPhone and 3CXPhone. </em></span>
Download the latest version of the soft phones, install and configure them like the screenshots below:

</p><div class="figure"><a id="d0e3713"/><p class="title"><strong>Figure 4.15. Wengo Softphone Configuration</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="wengo_softphone_configuration"/><img src="images/click2call_wengo_softphone_configuration.png" align="middle" alt="Wengo Softphone Configuration"/></div></div></div><p><br class="figure-break"/> 

</p><p>
You can use any username and password you desire. The MSS Tomcat server is listening for calls on the <span class="emphasis"><em> 127.0.0.1:5080 port </em></span>
</p><p>
<span class="emphasis"><em> Configuring the 3CXPhone </em></span> 
After the installation is complete, you can start up the 3CXPhone, you will see the screen below prompting you to create a profile. Click on the Create Profile Button.

</p><div class="figure"><a id="d0e3730"/><p class="title"><strong>Figure 4.16. 3CXphone Profile</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="3cxphone_softphone_profile"/><img src="images/click2call_3cxphone_softphone_profile.png" align="middle" alt="3CXphone Profile"/></div></div></div><p><br class="figure-break"/> 

In the Accounts window choose the <span class="emphasis"><em> 'New' </em></span> button and configure as follows

</p><div class="figure"><a id="d0e3740"/><p class="title"><strong>Figure 4.17. 3CXphone Softphone Configuration</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="3cxphone_softphone_configuration"/><img src="images/click2call_3cxphone_softphone_configuration.png" align="middle" alt="3CXphone Softphone Configuration"/></div></div></div><p><br class="figure-break"/> 
</p><p>


Once the 2 soft phone clients are configured with the SIP details, 
you can go back to the <code class="literal"> http://localhost:8040/click2call/index.jsp page and you will see the clients registered with the server. </code>


</p><div class="figure"><a id="d0e3752"/><p class="title"><strong>Figure 4.18. Registered Sip Clients</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="mobicents_sip_servlets_registered_clients"/><img src="images/click2call_mobicents_sip_servlets_registered_clients.png" align="middle" alt="Registered Sip Clients"/></div></div></div><p><br class="figure-break"/> 

Before you can make calls, you will need to specify the contact details of the person you want to call. It is just like entering the phone number. 
Because this is a SIP based setting, you will need to enter the SIP address instead of the phone number.



</p><p>
<span class="emphasis"><em> Testing the Soft Phones on Click2Call</em></span>
In order to be able to make a call from one phone to the other, you need to create a contact user. 
Because you will be using the SIP protocol, you will need to type the contact details with the testphone1 SIP pointing to the </p><pre class="screen"> testphone2@127.0.0.1 </pre><p>

</p><div class="figure"><a id="d0e3767"/><p class="title"><strong>Figure 4.19. Wengo Phone Contact User Details</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="wengo_softphone_user_contact"/><img src="images/click2call_wengo_softphone_user_contact.png" align="middle" alt="Wengo Phone Contact User Details"/></div></div></div><p><br class="figure-break"/> 
</p><p>
You need to do the same on the 3CXPhone contact. The phone contact number will be </p><pre class="screen"> sip:testphone1@127.0.0.1:5080 </pre><p>
</p><div class="figure"><a id="d0e3779"/><p class="title"><strong>Figure 4.20. 3CXPhone Contact User Details</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="3cxphone_contact_user_detail.png"/><img src="images/click2call_3cxphone_contact_user_detail.png" align="middle" alt="3CXPhone Contact User Details"/></div></div></div><p><br class="figure-break"/> 
Once you have both contact sip details configured, you can start to make calls and fully use the Click2call application.

</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="d0e3786"/>Chapter 5. Clustering and High Availability</h1></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#ssfjcs-SS_for_JBoss-Clustering_Support">5.1.  Understanding Mobicents High Availabilty </a></span></dt><dt><span class="section"><a href="#sslb-MSS_Load_Balancer">5.2. Load Balancer</a></span></dt><dd><dl><dt><span class="section"><a href="#sslb-binary-SIP_Load_Balancer-Installing_Configuring_and_Running">5.2.1. SIP Load Balancer: Installing, Configuring and Running</a></span></dt><dt><span class="section"><a href="#d0e4368">5.2.2. IP Load Balancing</a></span></dt><dt><span class="section"><a href="#sslb-SIP_Load_Balancing_Basics">5.2.3. SIP Load Balancing Basics</a></span></dt><dt><span class="section"><a href="#d0e4463">5.2.4. HTTP Load Balancing Basics</a></span></dt><dt><span class="section"><a href="#d0e4499">5.2.5. Pluggable balancer algorithms</a></span></dt><dt><span class="section"><a href="#d0e4550">5.2.6. Distributed load balancing</a></span></dt><dt><span class="section"><a href="#sslb-SIP_Load_Balancer-Implementation">5.2.7. Implementation of the Mobicents Load Balancer</a></span></dt><dt><span class="section"><a href="#d0e4577">5.2.8. SIP Message Flow</a></span></dt></dl></dd></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ssfjcs-SS_for_JBoss-Clustering_Support"/>5.1.  Understanding Mobicents High Availabilty </h2></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>High Availability in MSS for JBoss AS7 </h2><p>
Clustering and Failover features as described below are not yet implemented in MSS for JBoss AS7. This guide will be updated when the feature becomes available.
</p></div><p> High Availability </p><p>
Is a term used to describe software and hardware based strategies that are implemented to ensure optimal performance and continuous system operation in case of failure. High availability encompasses, clustering, failover and load balancing
</p><p>  Clustering </p><p>
Is a technique used to ensure continuous service availability by having two or more servers communicate with each other and share configuration and application data (replication) on  fixed, predetermined intervals. This produces two or more application servers with identical setup. There is often a primary server within a clustered cloud from which data is replicated to the secondary. The application servers within a clustered environment will use what is called a heartbeat to ensure that all servers within are alive and functioning. In the case of failure, another server (secondary) will take over the task of responding to client's requests without impacting user experience. In some clustered ecosystem, load balancing is used as explained below.

</p><p> Load Balancing</p><p>
This is ultimately about performance. All request from clients  are evenly distributed by the (load balancer) to multiple application servers that are running similar configurations.This type of setup often includes fault tolerance or failover. When one of the nodes, application server instance is not available, all traffic will be directed to the remaining servers. This ensures continuity albeit performance can degrade. Load balancing allows a single point of entry for multiple clients.
</p><p> Failover </p><p>
Failover is a way to provide continuous service to clients connecting to an application server in case of system, software or hardware failure. Connections to an unresponsive server is directed (failed over) to a backup server. This is often done within the scope of a clustered configuration aided by a load balancer.
</p><p>
It is important to note that clustering is also a way to provide failover and enhance server performance. The same can be said of load balancing. The idea behind all the above mentioned techniques is to provide high availability to connecting clients connecting to applications running on Mobicents. In a nutshell, high availability englobes all the above mentioned techniques.
</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sslb-MSS_Load_Balancer"/>5.2. Load Balancer</h2></div></div></div><div class="figure"><a id="d0e3824"/><p class="title"><strong>Figure 5.1. Star Cluster Topology.</strong></p><div class="figure-contents"><div class="mediaobject"><a id="sslb-mss-MSSSIPLoadBalancer-dia-StarNetworkTopology"/><img src="images/mss-MSSSIPLoadBalancer-dia-StarNetworkTopology.jpg" alt="Star Cluster Topology."/></div></div></div><br class="figure-break"/><p>The SIP Load Balancer is used to balance the load of SIP service requests and responses between nodes in a SIP Servlets Server cluster. Both MSS for JBoss and MSS for Tomcat servers can be used in conjunction with the SIP Load Balancer to increase the performance and availability of SIP services and applications. </p><p>In terms of functionality, the SIP Load Balancer is a simple stateless proxy server that intelligently forwards SIP session requests and responses between User Agents (UAs) on a Wide Area Network (WAN), and SIP Servlets Server nodes, which are almost always located on a Local Area Network (LAN). All SIP requests and responses pass through the SIP Load Balancer.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sslb-binary-SIP_Load_Balancer-Installing_Configuring_and_Running"/>5.2.1. SIP Load Balancer: Installing, Configuring and Running</h3></div></div></div><p> </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="sslb-binary-SIP_Load_Balancer-PreInstall_Requirements_and_Prerequisites"/>5.2.1.1. Pre-Install Requirements and Prerequisites</h4></div></div></div><p> </p><div class="variablelist"><a id="sslb-binary-SIP_Load_Balancer-Software_Prerequisites"/><p class="title"><strong>Software Prerequisites</strong></p><dl class="variablelist"><dt><span class="term">A JAIN SIP HA-enabled application server such as  Mobicents JAIN SLEE or  Mobicents SIP Servlets is required. </span></dt><dd><p>Running the SIP Load Balancer requires at least two instances of the application server as cluster nodes nodes. Therefore, before configuring the SIP Load Balancer, we should make sure we've installed a the SIP application server first. The Mobicents SIP load balancer will work with a SIP Servlets-enabled JBoss Application Server <span class="emphasis"><em>or</em></span> a JAIN SLEE application server with SIP RA.</p><p>SIP Servlets containers based on Tomcat are also supported but the session replication is not available there, thus mid-call failover will not work.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>To install a SIP Servlet-enabled JBoss Application Server, follow the instructions here: <a class="xref" href="#">???</a>.</p></li><li class="listitem"><p>To install a SIP Servlet-enabled Tomcat Servlet Container, follow these instructions: <a class="xref" href="#bssswticar-SIP_Servlets_Server_with_Tomcat-Installing_Configuring_and_Running" title="2.2.2. Tomcat for Windows">Section 2.2.2, “Tomcat for Windows ”</a>.</p></li></ul></div></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="sslb-binary-SIP_Load_Balancer-Downloading"/>5.2.1.2. Downloading</h4></div></div></div><p>The load balancer is located in the <code class="filename">sip-balancer</code> top-level directory of the MSS distribution. You will find the following files in the directory:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">SIP load balancer executable JAR file</span></dt><dd><p>This is the binary file with all dependencies</p></dd><dt><a id="sslb-binary-SIP_Load_Balancer-Configuration_Properties_File"/><span class="term">SIP load balancer Configuration Properties file</span></dt><dd><p>This is the properties files with various settings</p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="sslb-binary-SIP_Load_Balancer-Installing"/>5.2.1.3. Installing</h4></div></div></div><p>The SIP load balancer executable JAR file can be extracted anywhere in the file system. It is recommended that the file is placed in the directory containing other JAR executables, so it can be easily located in the future.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="sslb-binary-SIP_Load_Balancer-Configuring"/>5.2.1.4. Configuring</h4></div></div></div><p>Configuring the SIP load balancer and the two SIP Servlets-enabled Server nodes is described in <a class="xref" href="#sslb-Configuring_the_SIP_Load_Balancer_and_Servlet_Server_Nodes" title="Procedure 5.1. Configuring the Mobicents SIP Load Balancer and SIP Server Nodes">Procedure 5.1, “Configuring the Mobicents SIP Load Balancer and SIP Server Nodes”</a>.</p><div class="procedure"><a id="sslb-Configuring_the_SIP_Load_Balancer_and_Servlet_Server_Nodes"/><p class="title"><strong>Procedure 5.1. Configuring the Mobicents SIP Load Balancer and SIP Server Nodes</strong></p><ol class="procedure" type="1"><li class="step"><p class="title"><strong>Configure lb.properties Configuration Properties File</strong></p><p>Configure the SIP Load Balancer's Configuration Properties file by substituting valid values for your personal setup. <a class="xref" href="#sslb-Complete_Sample_lb.properties_File" title="Example 5.1. Complete Sample lb.properties File">Example 5.1, “Complete Sample lb.properties File”</a>  shows a sample <code class="filename">lb.properties</code> file, with key element descriptions provided after the example. The lines beginning with the pound sign are comments.</p><div class="example"><a id="sslb-Complete_Sample_lb.properties_File"/><p class="title"><strong>Example 5.1. Complete Sample lb.properties File</strong></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
# Mobicents Load Balancer Settings
# For an overview of the Mobicents  Load Balancer visit 
# http://docs.google.com/present/view?id=dc5jp5vx_89cxdvtxcm
# The Load balancer will listen for both TCP and UDP connections



# The binding address of the load balancer. This also specifies the 
# default value for both internalHost and externalHost if not specified separately.
host=127.0.0.1

# The binding address of the load balancer where clients should connect (if the host property is not specified)
#externalHost=127.0.0.1

# The SIP port from where servers will receive messages
# delete if you want to use only one port for both inbound and outbound)
internalPort=5065

# The SIP port used where clients should connect
externalPort=5060

# The binding address of the load balancer where SIP application servers should connect (if the host property is not specified)
#internalHost=127.0.0.1

# The RMI port used for heartbeat signals
rmiRegistryPort=2000

# The HTTP port for HTTP forwarding
# if you like to activate the integrated HTTP load balancer, this is the entry point
httpPort=2080
#If no nodes are active the LB can redirect the traffic to the unavailableHost specified in this property,
#otherwise, it will return 503 Service Unavailable
#unavailableHost=google.com

# If you are using IP load balancer, put the IP address and port here
#externalIpLoadBalancerAddress=127.0.0.1
#externalIpLoadBalancerPort=111
 
# Requests initited from the App Servers can route to this address (if you are using 2 IP load balancers for bidirectional SIP LB)
#internalIpLoadBalancerAddress=127.0.0.1
#internalIpLoadBalancerPort=111

# The addresses in the SIP LB Via headers can be either the real addresses or those specified in the external and internal IP LB addresses
useIpLoadBalancerAddressInViaHeaders=false

# Designate extra IP addresses as serer nodes
#extraServerNodes=222.221.21.12:21,45.6.6.7:9003,33.5.6.7,33.9.9.2

# Call-ID affinity algortihm settings. This algorithm is the default. No need to uncomment it.
#algorithmClass=org.mobicents.tools.sip.balancer.CallIDAffinityBalancerAlgorithm
# This property specifies how much time to keep an association before being evitcted.
# It is needed to avoid memory leaks on dead calls. The time is in seconds.
#callIdAffinityMaxTimeInCache=500
#The following attribute specified the policy after failover. If set to true all calls from the failed node
#will go to a new healthy node (all calls to the same node). If set to false the calls will go to random new nodes.
#callIdAffinityGroupFailover=false

# Uncomment to enable the consistent hash based on Call-ID algorithm.
#algorithmClass=org.mobicents.tools.sip.balancer.HeaderConsistentHashBalancerAlgorithm
# This property is not required, it defaults to Call-ID if not set, cna be "from.user" or "to.user" when you want the SIP URI username
#sipHeaderAffinityKey=Call-ID
#specify the GET HTTP parameter to be used as hash key
#httpAffinityKey=appsession
 
# Uncomment to enable the persistent consistent hash based on Call-ID algorithm.
#algorithmClass=org.mobicents.tools.sip.balancer.PersistentConsistentHashBalancerAlgorithm
# This property is not required, it defaults to Call-ID if not set
#sipHeaderAffinityKey=Call-ID
#specify the GET HTTP parameter to be used as hash key
#httpAffinityKey=appsession
 
#This is the JBoss Cache 3.1 configuration file (with jgroups), if not specified it will use default
#persistentConsistentHashCacheConfiguration=/home/config.xml
 
# Call-ID affinity algortihm settings. This algorithm is the default. No need to uncomment it.
#algorithmClass=org.mobicents.tools.sip.balancer.CallIDAffinityBalancerAlgorithm
# This property specifies how much time to keep an association before being evitcted.
# It is needed to avoid memory leaks on dead calls. The time is in seconds.
#callIdAffinityMaxTimeInCache=500

# Uncomment to enable the consistent hash based on Call-ID algorithm.
#algorithmClass=org.mobicents.tools.sip.balancer.HeaderConsistentHashBalancerAlgorithm
# This property is not required, it defaults to Call-ID if not set, cna be "from.user" or "to.user" when you want the SIP URI username
#sipHeaderAffinityKey=Call-ID
#specify the GET HTTP parameter to be used as hash key
#httpAffinityKey=appsession

# Uncomment to enable the persistent consistent hash based on Call-ID algorithm.
#algorithmClass=org.mobicents.tools.sip.balancer.PersistentConsistentHashBalancerAlgorithm
# This property is not required, it defaults to Call-ID if not set
#sipHeaderAffinityKey=Call-ID
#specify the GET HTTP parameter to be used as hash key
#httpAffinityKey=appsession
 
#This is the JBoss Cache 3.1 configuration file (with jgroups), if not specified it will use default
#persistentConsistentHashCacheConfiguration=/home/config.xml


#If a node doesnt check in within that time (in ms), it is considered dead
nodeTimeout=5100
#The consistency of the above condition is checked every heartbeatInterval milliseconds
heartbeatInterval=150


#JSIP stack configuration.....
javax.sip.STACK_NAME = SipBalancerForwarder
javax.sip.AUTOMATIC_DIALOG_SUPPORT = off
# You need 16 for logging traces. 32 for debug + traces.
# Your code will limp at 32 but it is best for debugging.
gov.nist.javax.sip.TRACE_LEVEL = 0

// Specify if message contents should be logged.
gov.nist.javax.sip.LOG_MESSAGE_CONTENT=false

gov.nist.javax.sip.DEBUG_LOG = logs/sipbalancerforwarderdebug.txt
gov.nist.javax.sip.SERVER_LOG = logs/sipbalancerforwarder.xml
gov.nist.javax.sip.THREAD_POOL_SIZE = 64
gov.nist.javax.sip.REENTRANT_LISTENER = true

            </pre></div></div><br class="example-break"/><div class="variablelist"><dl class="variablelist"><dt><span class="term">host</span></dt><dd><p>Local IP address, or interface, on which the SIP load balancer will listen for incoming requests.</p></dd><dt><span class="term">externalPort</span></dt><dd><p>Port on which the SIP load balancer listens for incoming requests from SIP User Agents.</p></dd><dt><span class="term">internalPort</span></dt><dd><p>Port on which the SIP load balancer forwards incoming requests to available, and healthy, SIP Server cluster nodes.</p></dd><dt><span class="term">rmiRegistryPort</span></dt><dd><p>Port on which the SIP load balancer will establish the RMI heartbeat connection to the application servers. When this connection fails or a disconnection instruction is received, an application server node is removed and handling of requests continues without it by redirecting the load to the lie nodes.</p></dd><dt><span class="term">httpPort</span></dt><dd><p>Port on which the SIP load balancer will accept HTTP requests to be distributed across the nodes.</p></dd><dt><span class="term">internalTransport</span></dt><dd><p>Transport protocol for the internal SIP connections associated with the internal SIP port of the load balancer. Possible choices are <code class="literal">UDP</code>, <code class="literal">TCP</code> and <code class="literal">TLS</code>.</p></dd><dt><span class="term">externalTransport</span></dt><dd><p>Transport protocol for the external SIP connections associated with the external SIP port of the load balancer. Possible choices are <code class="literal">UDP</code>, <code class="literal">TCP</code> and <code class="literal">TLS</code>. It must match the transport of the internal port.</p></dd><dt><span class="term">externalIpLoadBalancerAddress</span></dt><dd><p>Address of the IP load balancer (if any) used for incoming requests to be distributed in the direction of the application server nodes. This address may be used by the SIP load balancer to be put in SIP headers where the external address of the SIP load balancer is needed.</p></dd><dt><span class="term">externalIpLoadBalancerPort</span></dt><dd><p>The port of the external IP load balancer. Any messages arriving at this port should be distributed across the external SIP ports of a set of   SIP load balancers.</p></dd><dt><span class="term">internalIpLoadBalancerAddresst</span></dt><dd><p>Address of the IP load balancer (if any) used for outgoing requests (requests initiated from the servers) to be distributed in the direction of the clients. This address may be used by the SIP load balancer to be put in SIP headers where the internal address of the SIP load balancer is needed.</p></dd><dt><span class="term">internalIpLoadBalancerPort</span></dt><dd><p>The port of the internal IP load balancer. Any messages arriving at this port should be distributed across the internal SIP ports of a set of   SIP load balancers.</p></dd><dt><span class="term">extraServerNodes</span></dt><dd><p>Comma-separated list of hosts that are server nodes. You can put here alternative names of the application servers here and they will be recognized. Names are important, because they might be used for direction-analysis. Requests coming from these server will go in the direction of the clients and will not be routed back to the cluster.</p></dd><dt><span class="term">algorithmClass</span></dt><dd><p>The fully-qualified Java class name of the balancing algorithm to be used. There are three algorithms to choose from and you can write your own to implement more complex routing behaviour. Refer to the sample configuration file for details about the available options for each algorithm. Each algorithm can have algorithm-specific properties for fine-grained configuration.</p></dd><dt><span class="term">nodeTimeout</span></dt><dd><p>In milliseonds. Default value is 5100. If a server node doesnt check in within this time (in ms), it is considered dead.</p></dd><dt><span class="term">heartbeatInterval</span></dt><dd><p>In milliseconds. Default value is 150 milliseonds. The hearbeat interval  must be much smaller than the interval specified in the JAIN SIP property on the server machines - <code class="literal">org.mobicents.ha.javax.sip.HEARTBEAT_INTERVAL</code></p></dd></dl></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>The remaining keys and properties in the configuration properties file can be used to tune the JAIN SIP stack, but are not specifically required for load balancing. To assist with tuning, a comprehensive list of implementing classes for the SIP Stack is available from the <a class="ulink" href="http://snad.ncsl.nist.gov/proj/iptel/jain-sip-1.2/javadoc/javax/sip/SipStack.html">Interface SIP Stack page on nist.gov</a>.  For a comprehensive list of properties associated with the SIP Stack implementation, refer to <a class="ulink" href="http://snad.ncsl.nist.gov/proj/iptel/jain-sip-1.2/javadoc/gov/nist/javax/sip/SipStackImpl.html">Class SipStackImpl page on nist.gov</a>.</p></div></li><li class="step"><p class="title"><strong>Configure logging</strong></p><p>The SIP load balancer uses <a class="ulink" href="http://logging.apache.org/log4j">Log4J</a> as a logging mechanism. You can configure it through the typical log4j xml configuration file and specify the path as follows <code class="literal">-DlogConfigFile=./log4j.xml</code>.
		Please refer to Log4J documentation for more information on how to configure the logging. A shortcut exists if you want to switch between INFO/DEBUG/WARN logging levels. The JVM option
		<code class="literal">-DlogLevel=DEBUG</code> will allow you to switch all loggig categories to the specified log level.</p></li><li class="step"><p class="title"><strong>Configure the container configuration file</strong></p><p>Ensure the following attributes are configured for the <code class="literal">&lt;service&gt;</code> element in <code class="filename">server.xml</code> for Tomcat or in the mobicents <code class="literal">subsystem</code> element for JBoss AS7.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>The <code class="literal">sipPathName</code> attribute must contain the following value <code class="literal">org.mobicents.ha.balancing.only</code> to indicate that the server will be using the Mobicents JAIN SIP HA SIP Stack which is an extension of the JAIN SIP Stack offering integration with the Mobicents Load Balancer and transparent replication.</p></li></ul></div></li><li class="step"><p class="title"><strong>Configure the <code class="filename">mss-sip-stack.properties</code> configuration file</strong></p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>The <code class="literal">org.mobicents.ha.javax.sip.cache.MobicentsSipCache.cacheName</code> property must contain the name of the cache that will be responsible for holding the replicated data of the SIP Stack layer (namely the established SIP dialog data). The value has to be one of the cache name present in the jboss-cache-manager-jboss-beans.xml file of the jboss-cache-manager JBoss Service of the container. The default value is <code class="literal">standard-session-cache</code></p></li><li class="listitem"><p>The <code class="literal">org.mobicents.ha.javax.sip.BALANCERS</code> property must be configured with the list of load balancer IP address and internal ports. As an example, suppose a single  SIP Load Balancer is running with IP <code class="literal">192.168.0.1</code> and internal port <code class="literal">5065</code>, the property would be set with value <code class="literal">192.168.0.1:5065</code>. To specify multiple balancers use <code class="literal">;</code> as separator. If this property is used the balancers attribute located in server.xml should not be used as it is a replacement for it.</p></li><li class="listitem"><p>The <code class="literal">org.mobicents.ha.javax.sip.LoadBalancerHeartBeatingServiceClassName</code> property is optional, it defines the class name of the HeartBeating service implementation, currently the only one available is <code class="literal">org.mobicents.ha.javax.sip.LoadBalancerHeartBeatingServiceImpl</code></p></li><li class="listitem"><p>The <code class="literal">org.mobicents.ha.javax.sip.LoadBalancerElector</code> property is optional, it defines the class of the load balancer elector from JAIN SIP HA Stack. The elector is used to define which load balancer will receive outgoing requests, which are out of dialog or in dialog with null state. Currently only one elector implementation is available, <code class="literal">org.mobicents.ha.javax.sip.RoundRobinLoadBalancerElector</code>, which, as the class name says, uses round robin algorythm to select the balancer.</p></li></ul></div></li></ol></div><div class="section"><div class="titlepage"/><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Configuration File Locations</h2><p>On MSS for Tomcat server installations, <code class="filename">server.xml</code> is located in <code class="filename">&lt;install_directory&gt;/conf</code>.</p><p>On MSS for JBoss server installations, the default <code class="filename">standalone-sip.xml</code> configuration file is located
         in <code class="filename">standalone/configuration</code> or the default <code class="filename">domain-sip.xml</code> configuration file located
         in <code class="filename">domain/configuration</code> for cluster configurations</p></div><p><strong>Easy Node Configuration with JMX. </strong>Both SIP Servlet-enabled JBoss and Tomcat have <acronym class="acronym">JMX</acronym> (Java Management Extensions) interfaces that allow for easy server configuration. The JMX Console is available once the server has been started by navigating to <a class="ulink" href="http://localhost:8080/jmx-console/">http://localhost:8080/jmx-console/</a>.  </p><p>Both the <code class="literal">balancers</code> and <code class="literal">heartBeatInterval</code> attribute values are available under <code class="literal">name=Mobicents-SIP-Servlets,type=load-balancer-heartbeat-service</code> in the JMX Console.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">balancers</span></dt><dd><p>Host names of the SIP load balancer(s) with corresponding <code class="literal">addBalancerAddress</code> and <code class="literal">removeBalancerAddress</code> methods.</p></dd><dt><span class="term">heartBeatInterval</span></dt><dd><p>Interval at which each heartbeat is sent to the SIP load balancer(s).</p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="d0e4197"/>5.2.1.4.2. Converged Load Balancing</h5></div></div></div><div class="section"><div class="titlepage"><div><div><h6 class="title"><a id="d0e4200"/>5.2.1.4.2.1. Apache HTTP Load Balancer</h6></div></div></div><p>The MSS SIP Load Balancer can work in concert with HTTP load balancers such as <code class="literal">mod_jk</code>. Whenever an HTTP session is bound to a particular node, an instruction is sent to the SIP Load Balancer to direct the SIP calls from the same application session to the same node.
          </p><p>It is sufficient to configure <code class="literal">mod_jk</code> to work for HTTP in JBoss in order to enable cooperative load balancing. MSS will read the configuration and will use it without any extra configuration. You can read more about configuring <code class="literal">mod_jk</code> with JBoss in your JBoss Application Server documentation.</p><p>Alternatively you may disable this behaviour and make the HTTP load balancer follow the decisions made by the SIP load balancer with the httpFollowsSip flag. This is 
          achieved by changing the jvmRoute part of the session ID cookie used internally by <code class="literal">mod_jk</code>.</p><div class="section"><div class="titlepage"><div><div><h6 class="title"><a id="d0e4221"/>5.2.1.4.2.1.1. The httpFollowsSip flag</h6></div></div></div><p>The <code class="literal">httpFollowsSip</code> flag in the service configuration makes the application server aware of how different mod_jk and SIP load balancers have assigned 
          request affinity for each application session. The application servers assign exactly one node to each Sip Servlets application session and this node is the node where the
           last SIP request associated with the application session has landed (decised by the SIP load balancer). Then the application server will actively update the session ID
            cookie (the jvmRoute part) of any HTTP request that arrives at 
          the wrong node. The application server will do so with a specially composed HTTP redirect response or with a HTML refresh hint. As a backup strategy, if the request is bound to seek
           non-existing node forever and it will let the request be served by a new node. This avoids having a client stuck reloading the same page over and over.</p><p>One problem with this flag is that if you have two or more SIP sessions associated with the same application session and the load balancer has decided to send SIP requests
           to different nodes, which might happend if you use Call-ID based affinity, then the application server will have to change the jvmRoute very often for every SIP request resulting
            in significant overhead. It is generally not adviced to enable this flag if you have more than 1 SIP session per application session and the means to guarantee all SIP sessions
            from the application session will land on the same node.</p><p>This is an example how to enable the option. It is disabled by default.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;Connector port="5080" 
     ipAddress = "${jboss.bind.address}"
     ...
     httpFollowsSip="true" /&gt;
</pre></div></div><div class="section"><div class="titlepage"><div><div><h6 class="title"><a id="d0e4235"/>5.2.1.4.2.2. Integrated HTTP Load Balancer</h6></div></div></div><p>To use the integrated HTTP Load Balancer, no extra configuration is needed. If a unique <code class="literal">jvmRoute</code> is specified and enabled in each application server, it will behave exactly as the apache balancer. If <code class="literal">jvmRoute</code> is not present, it will use the session ID as a hash value and attempt to create a sticky session. The integrated balancer can be used together with the apache balancer at the same time.
          </p><p>In addition to the apache behavior, there is a consistent hash balancer algorithm that can be enabled for both HTTP and SIP messages. For both HTTP and SIP messages, there is a configurable affinity key, which is evaluated and hashed against each unassigned request. All requests with the same hash value will always be routed to the same application server node. For example, the SIP affinity key could be the callee user name and the HTTP affinity key could the <span class="quote">“<span class="quote">appsession</span>”</span> HTTP GET parameter of the request. If the desired behaviour group these requests, we can just make sure the affinity values (user name and GET parameter) are the same.</p><div class="figure"><a id="d0e4251"/><p class="title"><strong>Figure 5.2. Ensuring SIP and HTTP requests are being grouped by common affinity value.</strong></p><div class="figure-contents"><div class="mediaobject"><a id="sslb-mss-MSSSIPLoadBalancer-dia-StarNetworkTopology_1"/><img src="images/converged-integrated-lb.png" alt="Ensuring SIP and HTTP requests are being grouped by common affinity value."/></div></div></div><br class="figure-break"/></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="sslb-binary-SIP_Load_Balancer-Running"/>5.2.1.5. Running</h4></div></div></div><div class="procedure"><a id="sslb-Running_the_SIP_Load_Balancer_and_Servlet_Server_Nodes"/><p class="title"><strong>Procedure 5.2. Running the SIP Load Balancer and SIP Server Nodes</strong></p><ol class="procedure" type="1"><li class="step"><p class="title"><strong>Start the SIP Load Balancer</strong></p><p>Start the SIP load balancer, ensuring the Configuration Properties file (<code class="filename">lb.properties</code> in this example) is specified.  In the Linux terminal, or using the Windows Command Prompt, the SIP Load Balancer is started by issuing a command similar to this one:</p><pre class="screen">java -jar sip-balancer-jar-with-dependencies.jar lb-configuration.properties</pre><p>Executing the SIP load balancer produces  output similar to the following example:</p><pre class="screen">home]$ java -jar sip-balancer-jar-with-dependencies.jar lb-configuration.properties 
Oct 21, 2008 1:10:58 AM org.mobicents.tools.sip.balancer.SIPBalancerForwarder start
INFO: Sip Balancer started on address 127.0.0.1, external port : 5060, port : 5065
Oct 21, 2008 1:10:59 AM org.mobicents.tools.sip.balancer.NodeRegisterImpl startServer
INFO: Node registry starting...
Oct 21, 2008 1:10:59 AM org.mobicents.tools.sip.balancer.NodeRegisterImpl startServer
INFO: Node expiration task created
Oct 21, 2008 1:10:59 AM org.mobicents.tools.sip.balancer.NodeRegisterImpl startServer
INFO: Node registry started</pre><p>The output shows the IP address on which the SIP Load Balancer is listening, as well as the external and internal listener ports.</p></li><li class="step"><p class="title"><strong>Configure SIP Server Nodes</strong></p><p>SIP Servlets Server nodes can run on the JBoss Application Server, or the Tomcat Servlet Container.  The SIP Servlets Server binary distributions define the type of SIP Servlets Server nodes used, and should already be installed from <a class="xref" href="#sslb-binary-SIP_Load_Balancer-Software_Prerequisites" title="Software Prerequisites">Software Prerequisites</a>.</p><p>The Tomcat's <code class="filename">server.xml</code> or JBoss's <code class="filename">standalone-sip.xml</code> file specifies the nodes used.  Because there is more then one client node specified, unique listener ports must be specified for each node to monitor HTTP and/or SIP connections.  <a class="xref" href="#bsssc-binary-SIP_Servlets_Server-Adding_SIP_Connectors" title="2.3.1. Configuring SIP Connectors and Bindings">Section 2.3.1, “Configuring SIP Connectors and Bindings”</a> describes the affected element in the configuration file.</p></li><li class="step"><p class="title"><strong>Start Load Balancer Client Nodes</strong></p><p>Start all SIP load balancer client nodes.</p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="sslb-binary-SIP_Load_Balancer-Testing"/>5.2.1.6. Testing</h4></div></div></div><p>To test load balancing, the same application must be deployed manually on each node, and two SIP Softphones must be installed.</p><div class="procedure"><a id="d0e4309"/><p class="title"><strong>Procedure 5.3. Testing Load Balancing</strong></p><ol class="procedure" type="1"><li class="step"><p class="title"><strong>Deploy an Application</strong></p><p>Ensure that for each node, the DAR file is the same.</p><p>Deploy the Location service manually on both nodes.</p></li><li class="step"><p class="title"><strong>Start the "Sender" SIP softphone</strong></p><p>Start a SIP softphone client with the SIP address of <strong class="userinput"><code>sip:sender@sip-servlets-com</code></strong>, listening on port 5055. The outbound proxy must be specified as the sip-balancer (http://127.0.0.1:5060)</p></li><li class="step"><p class="title"><strong>Start the "Receiver" SIP softphone</strong></p><p>Start a SIP softphone client with the SIP address of <strong class="userinput"><code>sip:receiver-failover@sip-servlets-com</code></strong>, listening on port 5090.</p></li><li class="step"><p class="title"><strong>Initiate two calls from "Sender" SIP softphone</strong></p><p>Initiate one call from <strong class="userinput"><code>sip:sender@sip-servlets-com</code></strong> to <strong class="userinput"><code>sip:receiver-failover@sip-servlets-com</code></strong>.  Tear down the call once completed.</p><p>Initiate a second call using the same SIP address, and tear down the call once completed.  Notice that the call is handled by the second node.</p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="sslb-binary-SIP_Load_Balancer-Stopping"/>5.2.1.7. Stopping</h4></div></div></div><p>Assuming that you started the JBoss Application Server as a foreground process in the Linux terminal, the easiest way to stop it is by pressing the <span class="keycap"><strong>Ctrl</strong></span>+<span class="keycap"><strong>C</strong></span> key combination in the same terminal in which you started it.</p><p>This should produce similar output to the following:</p><pre class="screen">^COct 21, 2008 1:11:57 AM org.mobicents.tools.sip.balancer.SipBalancerShutdownHook run
INFO: Stopping the sip forwarder</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="sslb-binary-SIP_Load_Balancer-Uninstalling"/>5.2.1.8. Uninstalling</h4></div></div></div><p>To uninstall the SIP load balancer, delete the JAR file you installed.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e4368"/>5.2.2. IP Load Balancing</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e4371"/>5.2.2.1. IP Load Balancers</h4></div></div></div><p>An IP load-balancer is a network appliance that distributes traffic to an application server (or actual servers) using a  load-balancing algorithm.  IP load-balancing is often used when the other load-balancers' capacity is exceeded and can not scale further without hardware upgrades.</p><p>Routing decisions are made  based on OSI Layer 2, 3 or 4 data. This type of load balancer only examines low-level TCP, UDP or ethernet packet structures including MAC addresses, IP addresses, ports, and protocol types (TCP or UDP or other). </p><p>An IP  load balancer never reads the payload of the TCP/IP packets and therefore never parses SIP or HTTP (or any protocol above OSI Layer 4).  Because an IP load balancing device is not SIP or HTTP aware in any way, it is much more performant than <code class="literal">mod_jk</code> or the MSS SIP load-balancer.

</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e4383"/>5.2.2.2. Technical overview</h4></div></div></div><p>In its simplest form, the IP load-balancer usually "owns" the public-facing IP address (known as a VIP).   The traffic is routed to actual servers in it's private network similar to NAT. It is also possible to not change the IP address and just work on the MAC address by assuming that all actual  servers are configured to accept packets for the VIP address. The features offered by the IP load balancer depend largely on the vendor. </p><p>Some examples of  Linux-based  software load balancers include <a class="ulink" href="http://www.redhat.com/cluster_suite/">Red Hat Cluster Suite (RHCS)</a> and <a class="ulink" href="http://www.linuxvirtualserver.org/">Linux Virtual Server (LVS)</a>. There are many hardware vendors as well.</p><p>One main drawback relating to  IP load balancers is that they can not make routing decisions based on SIP messages and (with some exceptions) they can not work cooperatively with HTTP or other load balancers.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="d0e4400"/>5.2.2.3. Configuring MSS Cluster for pure IP Load Balancing</h4></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Warning</h2><p>Pure IP load balancing is not a recommented option. It is advised to use a distributed load balancer instead. Proper operation with pure IP load balancing depends on the ability of the IP load balancer to establish request affinity based on IP addresses and ports.</p></div><p>First you need to remove the SIP load balancers from any configuration in MSS. In particular the <code class="literal">org.mobicents.ha.javax.sip.BALANCERS</code> 
      attribute in <code class="filename">mss-sip-stack.properties</code>. You should remove the balancers attribute from the Service tag of 
      jboss.web service. This simply removes the default load balancer from the system and the traffic bypasses the SIP load-balancer. Next you must configure
       MSS to put the IP load balancer IP address in the <code class="literal">Via</code>, <code class="literal">Contact</code> and other system headers where 
       the IP address of the server machine is required. This will ensure that any responses or subsequent SIP requests follow the same path, but always hit 
       the load balancer instead of particular cluster node that may fail.  To specify the IP load balancer address in MSS your should edit
        this file on Tomcat <code class="filename">CATALINA_HOME/conf/server.xml</code> and specify <code class="literal">staticServerAddress</code> such as: </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;Connector port="5080" 
     ipAddress = "${jboss.bind.address}"
     ...
staticServerAddress="122.122.122.122" staticServerPort="44" 
useStaticAddress="true"/&gt;
</pre><p> and edit this file on JBoss <code class="filename">JBOSS_HOME/standalone/configuration/standalone-sip.xml</code> and specify <code class="literal">staticServerAddress</code> such as: </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;socket-binding name="sip-udp" port="5080"
     ...
staticServerAddress="122.122.122.122" staticServerPort="44" 
useStaticAddress="true"/&gt;
</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>Depending on your reliability requirements you can omit the configuration described in this section and let the servers use their own IP address in the SIP messages.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sslb-SIP_Load_Balancing_Basics"/>5.2.3. SIP Load Balancing Basics</h3></div></div></div><p>All User Agents send SIP messages, such as <code class="literal">INVITE</code> and <code class="literal">MESSAGE</code>, to the same SIP URI (the IP address and port number of the SIP Load Balancer on the WAN). The Load Balancer then parses, alters, and forwards those messages to an available node in the cluster. If the message was sent as a part of an existing SIP session, it will be forwarded to the cluster node which processed that User Agent's original transaction request.
    </p><p>The SIP Server that receives the message acts upon it and sends a response back to the SIP Load Balancer. The SIP Load Balancer reparses, alters and forwards the message back to the original User Agent. This entire proxying and provisioning process is carried out independent of the User Agent, which is only concerned with the SIP service or application it is using.
    </p><p>By using the Load Balancer, SIP traffic is balanced across a pool of available SIP Servers, increasing the overall throughput of the SIP service or application running on either individual nodes of the cluster. In the case of a MSS server with <code class="literal">&lt;/distributed&gt;</code> capabilities, load balancing advantages are applied across the entire cluster.
    </p><p>The SIP Load Balancer is also able to failover requests mid-call from unavailable nodes to available ones, thus increasing the reliability of the SIP service or application. The Load Balancer increases throughput and reliability by dynamically provisioning SIP service requests and responses across responsive nodes in a cluster. This enables SIP applications to meet the real-time demand for SIP services.
    </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e4463"/>5.2.4. HTTP Load Balancing Basics</h3></div></div></div><p>In addition to the SIP load balancing, there are several options for coordinated or cooperative load balancing with other protocols such as HTTP.
    </p><p>Typically, a JBoss Application Server will use apache HTTP server with mod_jk, mod_proxy, mod_cluster or similar extension installed as an HTTP load balancer. This apache-based load balancer will parse incoming HTTP requests and will look for the session ID of those requests in order to ensure all requests from the same session arrive at the same application server.
    </p><p>By default, this is done by examining the <code class="literal">jsessionid</code> HTTP cookie or GET parameter and looking for the <code class="literal">jvmRoute</code> assigned to the session. The typical <code class="literal">jsessionid</code> value is of the form <code class="literal">&lt;sessionId&gt;.&lt;jvmRoute&gt;</code>. The very first request for each new HTTP session does not have a session ID assigned; the apache routes the request to a random application server node.
    </p><p>When the node responds it assigns a session ID and <code class="literal">jvmRoute</code> to the response of the request in a HTTP cookie. This response goes back to the client through apache, which keeps track of which node owns each <code class="literal">jvmRoute</code>. Once the very first request is served this way, the subsequent requests from this session will carry the assigned cookie, and the apache load balancer will always route the requests to the node, which advertised itself as the <code class="literal">jvmRoute</code> owner.
    </p><p>Instead of using apache, an integrated HTTP Load Balancer is also available. The SIP Load Balancer has a HTTP port where you can direct all incoming HTTP requests. The integrated HTTP load balancer behaves exactly like apache by default, but this behavior is extensible and can be overridden completely with the pluggable balancer algorithms. The integrated HTTP load balancer is much easier to configure and generally requires no effort, because it reuses most SIP settings and assumes reasonable default values.
    </p><p>Unlike the native apache, the integrated HTTP Load Balancer is written completely in Java, thus a performance penalty should be expected when using it. However, the integrated HTTP Balancer has an advantage when related SIP and HTTP requests must stick to the same node.
    </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e4499"/>5.2.5. Pluggable balancer algorithms</h3></div></div></div><p>The SIP/HTTP Load Balancer exposes an interface to allow users to customize the routing decision making for special purposes. By default there are three built-in algorithms. Only one algorithm is active at any time and it is specified with the <code class="literal">algorithmClass</code> property in the configuration file.</p><p>It is up to the algorithm how and whether to support distributed architecture or how to store the information needed for session affinity. The algorithms will be called for every SIP and HTTP request and other significant events to make more informed decisions.
    </p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>Users must be aware that by default requests explicitly addressed to a live server node passing through the load balancer will be forwarded directly to the server node. This allows for pre-specified routing use-cases, where the target node is known by the SIP client through other means. If the target node is dead, then the node selection algorithm is used to route the request to an available node.
      </p></div><p>The following is a list of the built-in algorithms:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">org.mobicents.tools.sip.balancer.CallIDAffinityBalancerAlgorithm </span></dt><dd><p>This algorithm is not distributable. It selects nodes randomly to serve a give Call-ID extracted from the requests and responses. It keeps a map with  <code class="literal">Call-ID -&gt; nodeId</code> associations and this map is not shared with other load balancers which will cause them to make different decisions. For HTTP it behaves like apache.</p></dd><dt><a id="sslb-binary-SIP_Load_Balancer-Configuration_Properties_File_1"/><span class="term">org.mobicents.tools.sip.balancer.HeaderConsistentHashBalancerAlgorithm </span></dt><dd><p>This algorithm is distributable and can be used in distributed load balancer configurations. It extracts the hash value of specific headers from SIP and HTTP messages to decide which application server node will handle the request. Information about the options in this algorithms is available in the balancer configuration file comments.</p></dd><dt><a id="sslb-binary-SIP_Load_Balancer-Configuration_Properties_File_2"/><span class="term">org.mobicents.tools.sip.balancer.PersistentConsistentHashBalancerAlgorithm </span></dt><dd><p>This algorithm is distributable and is similar to the previous algorithm, but it attempts to keep session affinity even when the cluster nodes are removed or added, which would normally cause hash values to point to different nodes.</p></dd><dt><a id="sslb-binary-SIP_Load_Balancer-Configuration_Properties_File_3"/><span class="term">org.mobicents.tools.sip.balancer.ClusterSubdomainAffinityAlgorithm </span></dt><dd><p>This algorithm is not distributable, but supports grouping server nodes to act
             as a subcluster. Any call of a node that belongs to a cluster group will be preferentially
              failed over to a node from the same group. To configure a group you can just add the
               <code class="literal">subclusterMap</code> property in the load balancer properties and listing 
               the IP addresses of the nodes. The groups are enclosed in parentheses and the IP 
               addresses are separate by commas as follows:</p><pre class="screen">subclusterMap=( 192.168.1.1, 192.168.1.2 ) ( 10.10.10.10,  20.20.20.20,  30.30.30.30)</pre><p>The nodes specified in a group do not have to alive and nodes that are not specified are still allowed to join the cluster. Otherwise the algorthim behaves exactly as the default Call-ID affinity algorthim.</p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e4550"/>5.2.6. Distributed load balancing</h3></div></div></div><p>When the capacity of a single load balancer is exceeded, multiple load balancers can be used. With the help of an IP load balancer the traffic can be distributed between all SIP/HTTP load balancers based on some IP rules or round-robin. With consistent hash and <code class="literal">jvmRoute</code>-based balancer algorithms it doesn't matter which SIP/HTTP load balancer will process the request, because they would all make the same decisions based on information in the requests (headers, parameters or cookies) and the list of available nodes. With consistent hash algorithms there is no state to be preserved in the SIP/HTTP balancers.</p><div class="figure"><a id="d0e4558"/><p class="title"><strong>Figure 5.3. Example deployment: IP load balancers serving both directions for incoming/outgoing requests in a cluster</strong></p><div class="figure-contents"><div class="mediaobject"><a id="sslb-mss-MSSSIPLoadBalancer-dia-StarNetworkTopology_2"/><img src="images/bidirectional-distributed-sip-lb.gif" alt="Example deployment: IP load balancers serving both directions for incoming/outgoing requests in a cluster"/></div></div></div><br class="figure-break"/></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sslb-SIP_Load_Balancer-Implementation"/>5.2.7. Implementation of the Mobicents Load Balancer</h3></div></div></div><p>Each individual Mobicents SIP Server in the cluster is responsible for contacting the SIP load balancer and relaying its health status and regular "heartbeats".  
    </p><p>From these health status reports and heartbeats, the SIP Load Balancer creates and maintains a list of all available and healthy nodes in the cluster. The Load Balancer forwards SIP requests between these cluster nodes, providing that the provisioning algorithm reports that each node is healthy and is still sending heartbeats.
    </p><p>If an abnormality is detected, the SIP Load Balancer removes the unhealthy or unresponsive node from the list of available nodes. In addition, mid-session and mid-call messages are failed over to a healthy node.
    </p><p>The SIP Load Balancer first receives SIP requests from endpoints on a port that is specified in its Configuration Properties configuration file. The SIP Load Balancer, using a round-robin algorithm, then selects a node to which it forwards the SIP requests. The Load Balancer forwards all same-session requests to the first node selected to initiate the session, providing that the node is healthy and available.
    </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e4577"/>5.2.8. SIP Message Flow</h3></div></div></div><p>The SIP Load Balancer appends itself to the <code class="literal">Via</code> header of each request, so that returned responses are sent to the SIP Balancer before they are sent to the originating endpoint.
    </p><p>The Load Balancer also adds itself to the path of subsequent requests by adding Record-Route headers. It can subsequently handle mid-call failover by forwarding requests to a different node in the cluster if the node that originally handled the request fails or becomes unavailable. The SIP load balancer immediately fails over if it receives an unhealthy status, or irregular heartbeats from a node.
    </p><p>In advanced configurations, it is possible to run more than one SIP Load Balancer. Simply edit the balancers connection string in your SIP Server - the list is separated with semi-colon. </p><p><a class="xref" href="#figure-mss-Basic_IP_and_Port_Cluster_Configuration" title="Figure 5.4. Basic IP and Port Cluster Configuration">Figure 5.4, “Basic IP and Port Cluster Configuration”</a> describes a basic IP and Port Cluster Configuration. In the diagram, the SIP Load balancer is the server with the IP address of <code class="literal">192.168.1.1</code>.</p><div class="figure"><a id="figure-mss-Basic_IP_and_Port_Cluster_Configuration"/><p class="title"><strong>Figure 5.4. Basic IP and Port Cluster Configuration</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="sslb-mss-MSSSIPLoadBalancer-dia-ClusterIPsAndPorts"/><img src="images/mss-MSSSIPLoadBalancer-dia-ClusterIPsAndPorts.jpg" align="middle" alt="Basic IP and Port Cluster Configuration"/></div></div></div><br class="figure-break"/></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="emom-Enterprise-Monitoring-Operations-Management"/>Chapter 6. Enterprise Monitoring and Management</h1></div></div></div><p>There is two ways of monitoring Mobicents Sip Servlets :
  </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Through the industry standard Simple Network Management Protocol - SNMP</p></li><li class="listitem"><p>Through Jopr is an enterprise management solution for JBoss middleware
		  projects and other application technologies. This pluggable project provides
		  administration, monitoring, alerting, operational control and configuration
		  in an enterprise setting with fine-grained security and an advanced
		  extension model.</p><p>It provides support for monitoring base operating system information
		  on six operating systems as well as management of Apache, JBoss Application
		  Server (JBoss AS) and other related projects. See the <a class="ulink" href="http://www.jboss.org/jopr">Jopr website</a> or
		  the <a class="ulink" href="http://www.jboss.org/embjopr">Jopr embedded website</a> for more information.</p></li></ul></div><p>
  </p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>SNMP and Monitoring for MSS for JBoss AS7 </h2><p>
This feature is not yet implemented in MSS for JBoss AS7. This guide will be updated when SNMP and other monitoring features become available. In the meantime, see the chapter below for information about the CLI.
</p><p>
<a class="xref" href="#getting-started-with-MSS-Tomcat-AS7" title="2.2. Getting Started with MSS for Tomcat 7">Section 2.2, “Getting Started with MSS for Tomcat 7  ”</a>


</p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="ssecurity-Sip_Servlet_Security"/>Chapter 7. Security</h1></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#sss-SIP_Servlet_Security">7.1. SIP Servlets Application Security</a></span></dt><dt><span class="section"><a href="#sss-TLS">7.2. TLS</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4826">7.2.1. Quick Start</a></span></dt><dt><span class="section"><a href="#sss-TLS_production_setup">7.2.2. Production Setup</a></span></dt></dl></dd></dl></div><p>The information present in SIP requests often contains sensitive user
  information. To protect user information, SIP Security can be enabled on the
  server, and within the SIP application to mitigate the risk of unauthorised
  access to the information.</p><p>There are essentially two levels of security that can be enabled on
  the server, the communication between the server and other SIP entities and
  securing the application and its content.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sss-SIP_Servlet_Security"/>7.1. SIP Servlets Application Security</h2></div></div></div><p>Application security varies depending on the server type used. The
  following procedures describe how to configure the JBoss AS7
  and Tomcat servers to enable Security.</p><div class="procedure"><a id="d0e4647"/><p class="title"><strong>Procedure 7.1. Enable SIP Application Security in JBoss AS7</strong></p><ol class="procedure" type="1"><li class="step"><p class="title"><strong>Add Security Policy to Server Configuraton</strong></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Open the configuration file located in <code class="literal">$JBOSS_HOME/standalone/configuration/standalone-sip.xml</code> </p></li><li class="listitem"><p>Append a security domain to the under the <code class="literal">&lt;security-domains&gt;</code>:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;security-domain name="sip-servlets"&gt;
	&lt;authentication&gt; 
		&lt;login-module code="UsersRoles" flag="required"&gt; 
		    &lt;module-option name="usersProperties" value="${jboss.server.config.dir}/sip-servlets-users.properties"/&gt; 
		    &lt;module-option name="rolesProperties" value="${jboss.server.config.dir}/sip-servlets-roles.properties"/&gt; 
		    &lt;module-option name="hashAlgorithm" value="MD5"/&gt;
	        &lt;module-option name="hashEncoding" value="RFC2617"/&gt;
	        &lt;module-option name="hashUserPassword" value="false"/&gt;
           	&lt;module-option name="hashStorePassword" value="true"/&gt;
	        &lt;module-option name="passwordIsA1Hash" value="true"/&gt;
	        &lt;module-option name="storeDigestCallback" value="org.jboss.security.auth.callback.RFC2617Digest"/&gt;
		&lt;/login-module&gt; 
	&lt;/authentication&gt; 
&lt;/security-domain&gt;
  </pre></li></ol></div></li><li class="step"><p class="title"><strong>Create SIP Server User Properties File</strong></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Open a terminal and navigate to the <code class="literal">$JBOSS_HOME/standalone/configuration</code> directory:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">home]$ cd standalone/configuration</pre></li><li class="listitem"><p>Create and open a <code class="literal">sip-servlets-users.properties</code> file and
          append the user lines to the file:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""> 
  # A sample users.properties file, this line creates user "admin" with 
  # password "admin" for "sip-servlets-realm"
  admin=&lt;A1_cryptographic_string&gt;
  </pre></li><li class="listitem"><p>To create &lt;A1_cryptographic_string&gt;, execute the
          following command in a terminal:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">home]$ java -cp ../../modules/system/layers/base/org/picketbox/main/picketbox-4.0.15.Final.jar org.jboss.security.auth.callback.RFC2617Digest admin sip-servlets &lt;password&gt;</pre></li><li class="listitem"><p>Copy the A1 hash, and paste it into the admin parameter in the
          previous step.</p></li><li class="listitem"><p>Save and close <code class="literal">sip-servlets-users.properties</code>.</p></li></ol></div></li><li class="step"><p class="title"><strong>Create the SIP Server Roles File</strong></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Create and open <code class="literal">sip-servlets-roles.properties</code> (using
          your preferred editor) and append the following information to the
          file:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""> 
# A sample roles.properties file for use with some roles
# Each line in this file assigns roles to the users defined in 
# sip-servlets-users.properties
admin=caller,role1,role2,..
            </pre></li></ol></div></li><li class="step"><p class="title"><strong>Add the Security Domain to the SIP Application</strong></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Open the <code class="literal">jboss-web.xml</code> file for the SIP
          application to which security is required.</p></li><li class="listitem"><p>Add the <span class="markup">&lt;security-domain&gt;</span> element as a
          child of the <span class="markup">&lt;jboss-web&gt;</span> element:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;jboss-web&gt;
      &lt;security-domain&gt;sip-servlets&lt;/security-domain&gt;
&lt;/jboss-web&gt;

            </pre></li></ol></div></li><li class="step"><p class="title"><strong>Add Security Constraints to the SIP Application</strong></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Open the <code class="literal">sip.xml</code> file for the SIP
          application.</p></li><li class="listitem"><p>Add the <span class="markup">&lt;security-domain&gt;</span> element as a
          child of the <span class="markup">&lt;sip-app&gt;</span> element:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;security-constraint&gt;
	&lt;display-name&gt;REGISTER Method Security Constraint&lt;/display-name&gt;
	&lt;resource-collection&gt;
	   	&lt;resource-name&gt;SimpleSipServlet&lt;/resource-name&gt;
	    &lt;description&gt;Require authenticated REGSITER requests&lt;/description&gt;
	    &lt;servlet-name&gt;SimpleSipServlet&lt;/servlet-name&gt;
	    &lt;sip-method&gt;REGISTER&lt;/sip-method&gt;   
	&lt;/resource-collection&gt;   
	&lt;auth-constraint&gt;      
	  	&lt;role-name&gt;caller&lt;/role-name&gt;  
	&lt;/auth-constraint&gt;
&lt;/security-constraint&gt;
	 
&lt;login-config&gt; 
   	&lt;auth-method&gt;DIGEST&lt;/auth-method&gt; 
   	&lt;realm-name&gt;sip-servlets&lt;/realm-name&gt; 
 &lt;/login-config&gt;
</pre></li></ol></div></li></ol></div><div class="procedure"><a id="d0e4756"/><p class="title"><strong>Procedure 7.2. Enable SIP Application Security in Tomcat Server</strong></p><ol class="procedure" type="1"><li class="step"><p class="title"><strong>Activate the Memory Realm in Catalina:</strong></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Open a terminal and navigate to the <code class="filename">/conf</code>
          directory:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">home]$ cd server/default/&lt;tomcat_home&gt;/conf/</pre></li><li class="listitem"><p>Open <code class="literal">server.xml</code> and uncomment the following
          line:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;!--&lt;Realm className="org.apache.catalina.realm.MemoryRealm"/&gt;--&gt;</pre></li></ol></div></li><li class="step"><p class="title"><strong>Update SIP Server User Properties File</strong></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>In the <code class="filename">/conf</code> directory, open
          <code class="literal">tomcat-users.xml</code> (using your preferred editor)
          and append the following <span class="markup">&lt;user&gt;</span> child
          element:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;user name="user" password="password" roles="caller"/&gt;</pre></li></ol></div></li><li class="step"><p class="title"><strong>Add Security Constraints to the SIP Application</strong></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Open the <code class="literal">sip.xml</code> file for the SIP
          application to which security is required.</p></li><li class="listitem"><p>Add the <span class="markup">&lt;security-domain&gt;</span> child element
          to the <span class="markup">&lt;jboss-web&gt;</span> element:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;security-constraint&gt;
  &lt;display-name&gt;REGISTER Method Security Constraint&lt;/display-name&gt;
  &lt;resource-collection&gt;
    &lt;resource-name&gt;SimpleSipServlet&lt;/resource-name&gt;
    &lt;description&gt;Require authenticated REGISTER requests&lt;/description&gt;
    &lt;servlet-name&gt;SimpleSipServlet&lt;/servlet-name&gt;
    &lt;sip-method&gt;REGISTER&lt;/sip-method&gt;
  &lt;/resource-collection&gt;
  &lt;auth-constraint&gt;
    &lt;role-name&gt;caller&lt;/role-name&gt;
  &lt;/auth-constraint&gt;
&lt;/security-constraint&gt;
&lt;login-config&gt;
  &lt;auth-method&gt;DIGEST&lt;/auth-method&gt;
  &lt;realm-name&gt;sip-servlets-realm&lt;/realm-name&gt;
&lt;/login-config&gt;
            </pre></li></ol></div></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sss-TLS"/>7.2. TLS</h2></div></div></div><p>In order to configure TLS you will have to obtain a public/private key, a X.509 certificate,
        add those to the Java keystore and optionally add certificates from a known CA (certicate
        authority). The entire process can be confusing but in order to get a basic setup for
        testing purposes up and running with minimal effort, this section starts off with a simple
        quick start. However, for production environment you need to obtain an officially signed
        certificate from a known CA and that process is outlined in section <a class="xref" href="#sss-TLS_production_setup" title="7.2.2. Production Setup">Section 7.2.2, “Production Setup”</a>.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e4826"/>7.2.1. Quick Start</h3></div></div></div><p>This section shows how to create a self signed certificate, how to
    add that to the Java keystore and how to configure the SIP Servlet
    Container to make use of this configuration. Note, this section should
    only be used in a development environment and the main reason for this
    quickstart section is to get you going right away as well as get you
    comfortable with generating keys and certificates and adding them to the
    Java keystore.</p><div class="procedure"><a id="d0e4831"/><p class="title"><strong>Procedure 7.3. Server Side Authentication</strong></p><p> At a high-level, we will execute the following three steps: </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Generate a public/private key pair and a self signed certificate and
                            add those to the Java keystore.</p></li><li class="listitem"><p>Configure the SIP Servlet Container to load our certificate from the
                            keystore.</p></li><li class="listitem"><p>Test!</p></li></ol></div><ol class="procedure" type="1"><li class="step"><p class="title"><strong>Generate certificate</strong></p><p>Generating a new key-pair and a certificate can be done in a few different ways with a
        few different tools but here we will just use the java keytool that comes with the JDK.
        Simple issue the following command, which will generate a new public and private key,
        generate a self-signed certificate and add it all to the Java keystore: </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">keytool -genkeypair -alias myserver -keyalg RSA -keysize 1024 -keypass secret -validity 365 -storetype jks -keystore myserver.jks -storepass secret -v -dname "CN=James Smith, OU=Engineering, O=My Company, L=My City, S=My State, C=US"</pre><p>-keystore specifies which keystore we should use/update. If the keystore doesn't
          exist, a new one will be created for one. In the above example, we named the keystore
          <code class="classname">myserver.jks</code> and it will be saved in the current directory 
      </p><p>-keypass and -storepass should be chosen wisely since with bad passwords you won't
                    have much protection anyway. Also, normally you should never passwords on the
                    command prompt, it is too easy for other people to steal. If you leave these two
                    options out, the keytool command will ask you for it. </p><p>-keyalg specifies which algorithm to use when generating the keys and the keysize
                    how long those keys should be. </p><p>Note: the command -genkeypair is new in JDK 6 and was previously named -genkey. The
                    keytool in JDK 6 has some improvements over the previous versions so it is
                    recommended to use it instead. </p><p>See more about the Java keytool here: <a class="ulink" href="http://docs.oracle.com/javase/6/docs/technotes/tools/solaris/keytool.html">http://docs.oracle.com/javase/6/docs/technotes/tools/solaris/keytool.html</a></p></li><li class="step"><p class="title"><strong>Configure the SIP Servlet Container</strong></p><p>The SIP Servlet Container relies on the JAIN SIP stack to support it with TLS
                    capabilities. As such, it is the JAIN SIP stack that we need to configure to
                    have it read our certificate we added to the key store. The various
                    configuration options are described in the javadoc of the <a class="ulink" href="http://ci.jboss.org/jenkins/job/jain-sip/lastSuccessfulBuild/artifact/javadoc/gov/nist/javax/sip/SipStackImpl.html">SipStackImpl</a>
                        class but for this quickstart, we will be using the following ones: </p><p>
            </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><code class="literal">javax.net.ssl.keyStore</code> – the filename and location of the keystore to use.</p></li><li class="listitem"><p><code class="literal">javax.net.ssl.keyStorePassword</code> – the password to the keystore.</p></li><li class="listitem"><p><code class="literal">javax.net.ssl.trustStore</code> – the filename and location of the truststore to use.</p></li><li class="listitem"><p><code class="literal">javax.net.ssl.trustStorePassword</code> – the password to the truststore.</p></li><li class="listitem"><p><code class="literal">gov.nist.javax.sip.TLS_CLIENT_AUTH_TYPE</code> – which type of authentication we will require of the
                    client (for now, the client authentication type will be set to Disabled).</p></li></ul></div><p>
        </p><p>The configuration options are JVM parameters and you will have to add these to the
                        command line when you start the server:
                        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">./bin/run.sh -Djavax.net.ssl.keyStorePassword=mysecret -Dgov.nist.javax.sip.TLS_CLIENT_AUTH_TYPE=Disabled -Djavax.net.ssl.keyStore=/path/to/your/keystore/myserver.jks -Djavax.net.ssl.trustStorePassword=mysecret -Djavax.net.ssl.trustStore=/path/to/your/keystore/myserver.jks</pre><p>Once the server is up, we are ready to verify that we can get a TLS connection using the
            certificate we previously added in the first step. </p><p>Note: for this first part of the quickstart we will not require a certificate from the
            client since this involves more configuration. This is controlled by the
            <code class="literal">gov.nist.javax.sip.TLS_CLIENT_AUTH_TYPE parameter</code>. </p></li><li class="step"><p class="title"><strong>Test!</strong></p><p> To verify your setup there are a few different tools that you can use. </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><a class="ulink" href="http://www.openssl.org/">openssl</a> is an open source SSL toolkit and contains a generic SSL/TLS test
                    client</p></li><li class="listitem"><p><a class="ulink" href="http://sipp.sourceforge.net/">SIPp</a> – an open source SIP load testing tool that is capable of using TLS.
                    However, it requires some additional steps that we have not addressed in the first
                    parf of this quickstart so therefore we willl not be using SIPp.</p></li><li class="listitem"><p>Using your favorite SIP client. Most SIP clients out there are capable of
                    establishing a TLS connection but you will have to consult its documentation of how
                    to configure TLS.</p></li></ul></div><p>Using openssl:</p><p>Assuming that your server is running on localhost and is listening for TLS on port 5081
                        the command would be:
                        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">openssl s_client -host 127.0.0.1 -port 5081</pre><p>If you are successful you should see an output from openssl displaying information about
            the server certificate (which should be the one we generated in Step 1). If there are any
            issues with the setup, openssl is pretty good about giving out information about what it
            thinks is wrong. </p><p>Tip: if you add the following JVM parameter as well you will get a lot of useful debug
            information: <code class="literal">-Djavax.net.debug=ssl</code></p></li></ol></div><div class="procedure"><a id="d0e4948"/><p class="title"><strong>Procedure 7.4. Server Side Authentication</strong></p><p>In the first part of this quickstart we generated a public and private key along with a
            self-signed certificate and added them all into the Java keystore. The server was then
            configured to use this information and when a client connected, our certificate was served
            up to the client. However, normally, the client and the server would like to verify each
            others certificate to make sure they both trust each other and if not, either of them will
            terminate the connection. In the first part of the quickstart, the server did not require
            the client to present a certificate when connecting (remember that we set the <code class="literal">gov.nist.javax.sip.TLS_CLIENT_AUTH_TYPE</code> to disabled) so let's do
            that now.</p><p> At a high-level, these are the tasks we need to execute: </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Generate a public/private key pair for the client along with a
                                certificate.</p></li><li class="listitem"><p>The server need to add the client certificate to its keystore as a
                                trusted certificate.</p></li><li class="listitem"><p>Start the server with client authenticating enabled.</p></li></ol></div><ol class="procedure" type="1"><li class="step"><p class="title"><strong>Generate Client Certificate</strong></p><p>We will use the Java keytool for this step in the same we did for for the server side
                        in the previous quikstart. The command is exactly the same and the only
                        difference is that we store the information in a new keystore called
                        <code class="classname">myclient.jks</code>.
                        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">keytool -genkeypair -alias myclient -keyalg RSA -keysize 1024 -keypass secret -validity 365 -storetype jks -keystore myclient.jks -storepass secret -v -dname "CN=John Doe, OU=Engineering, O=Some Work, L=Some City, S=Some State, C=US" </pre><p>We have now generated a new keystore containing the clients authentication
                        information. However, the server needs to import the client certificate into its
                        trusted keystore so we need to extract the certificate out of the client key
                        store. This can also be done using the Java keytool.
                        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">keytool -exportcert -alias myclient -file client.cert -keystore myclient.jks -storepass secret -rfc</pre><p>The
                        certificate is saved in file 'client.cert' and we will use this file in the next
                        step. </p></li><li class="step"><p class="title"><strong>Re-configure the server</strong></p><p>Simply change the <code class="literal">gov.nist.javax.sip.TLS_CLIENT_AUTH_TYPE</code> from 'Disabled' to 'Enabled' and start the server again.</p></li><li class="step"><p class="title"><strong>Test</strong></p><p>We will once again use openssl to verify our setup but now that the client
                        will be forced to present a certificate as well, we do need the certificate's
                        private key as well. The private key is embedded into the keystore and was
                        generated when we issued the 'kenkeypair' keytool-command. Unfortunately, the
                        keytool does not have an option for exporting the private key so we will have to
                        write a small java program to extract it for us. Luckily, it is not a lot of
                        code:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">import java.io.FileInputStream;
    import java.security.Key;
    import java.security.KeyStore;
    import sun.misc.BASE64Encoder;

    /**
     * Code originally posted on Sun's developer forums but 
     * can now only be found at stackoverflow: 
     * http://stackoverflow.com/questions/150167/how-do-i-list-export-private-keys-from-a-keystore
     */
    public class DumpPrivateKey {
        
        static public void main(String[] args)
        throws Exception {
            if(args.length &lt; 3) {
            throw new IllegalArgumentException("expected args: Keystore filename, Keystore password, alias, &lt;key password: default same than keystore");
            }
            final String keystoreName = args[0];
            final String keystorePassword = args[1];
            final String alias = args[2];
            final String keyPassword = getKeyPassword(args,keystorePassword);
            KeyStore ks = KeyStore.getInstance("jks");
            ks.load(new FileInputStream(keystoreName), keystorePassword.toCharArray());
            Key key = ks.getKey(alias, keyPassword.toCharArray());
            String b64 = new BASE64Encoder().encode(key.getEncoded());
            System.out.println("-----BEGIN PRIVATE KEY-----");
            System.out.println(b64);
            System.out.println("-----END PRIVATE KEY-----");
        }

        private static String getKeyPassword(final String[] args, final String keystorePassword)
        {
        String keyPassword = keystorePassword; // default case
        if(args.length == 4) {
            keyPassword = args[3];
        }
        return keyPassword;
        }
        }</pre><p>Copy and paste the above code into a file call DumpPrivateKey.java and then compile it: </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">javac DumpPrivateKey.java</pre><p>and then use it to extract the private key: </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">java DumpPrivateKey myclient.jks secret myclient &gt; clientprivate.key</pre><p>Now that we have the private key of the client we can use openssl to verify the setup again: </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">openssl s_client -host 127.0.0.1 -port 5081 -cert client.cert -certform PEM -key clientprivate.key</pre><p>If all goes well you should successfully establish a connection and openssl will dump
                    information about the certificate exchange. </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sss-TLS_production_setup"/>7.2.2. Production Setup</h3></div></div></div><p>In a production environment it is important that you run with an officially signed
                certificate from a known CA. It is this certificate that you will load into your
                keystore and the process is very similar to the one outlined in the quick start.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p class="title"><strong>Generate a PKCS#12 Storage</strong></p><p>Assuming that you already have a private key and a signed certificate from a known CA
                you first have to wrap these two into a pkcs#12 storage (pkcs#12 is a file format
                for storing X.509 public certificates along with the private key), and then load
                that into the Java keystore. To create a pkcs#12 storage you can use the <a class="ulink" href="http://www.openssl.org/docs/apps/pkcs12.html">openssl pkcs12</a> command:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">openssl pkcs12 -inkey myprivate.key -in mycertificate.pem -export -out mystorage.pkcs12 -passout mysecret</pre><p>where myprivate.key is the private key, <code class="classname">mycertificate.pem</code> is the X.509
                    certificate. The password for the storage is 'mysecret' and the name of the
                    storage file is <code class="classname">mystorage.pkcs12</code>. </p></li><li class="step"><p class="title"><strong>Generate the Java Keystore</strong></p><p>Once the pkcs#12 has been created, use the Java keytool to load the pkcs12 storage
                    and convert it into a java keystore. </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">keytool -importkeystore -srckeystore mystorage.pkcs12 -srcstoretype PKCS12 -destkeystore myserver.jks -deststorepass mysecret -srcstorepass mysecret</pre><p>A few things to point out: </p><p>
          -srcstoretype is important and tells the Java keytool which format the key store that we are importing is in. In the previous step, we generated a pkcs#12 store so in this example, the store type must be PKCS12.
      </p><p>
          -srcstorepass is the password for the pkcs#12 storage and in the above example it is the same as the  destination key store (-deststorepass) but most likely they will be different. 
      </p></li><li class="step"><p class="title"><strong>Re-configure and Test</strong></p><p>Now that we have a java keystore the server configuration is exactly the same as
                    described in the quick start, i.e., simply set the java properties
                    <code class="literal">javax.net.ssl.keyStore</code> and <code class="literal">javax.net.ssl.trustStore</code> to point to this key keystore file and then set the
                            password through the property <code class="literal">javax.net.ssl.keyStorePassword</code> and <code class="literal">javax.net.ssl.trustStorePassword</code>. Once the server
                    has been re-started you can use openssl to verify the setup. </p></li></ol></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="afotsss-Advanced_Features_of_the_SIP_Servlets_Server"/>Chapter 8. Advanced Features of the SIP Servlets Server</h1></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#mipbx-Media_Support">8.1. Media Support</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e5081">8.1.1. JSR 309: Media Server Control API</a></span></dt></dl></dd><dt><span class="section"><a href="#sscacc-MSS_Concurrency_and_Congestion_Control">8.2. Concurrency and Congestion Control</a></span></dt><dt><span class="section"><a href="#mssstun-MSS_STUN">8.3. STUN Support</a></span></dt><dt><span class="section"><a href="#sscacc-MSS_JSR289_Extensions">8.4. Mobicents vendor-specific Extensions to JSR 289</a></span></dt><dt><span class="section"><a href="#stf-CDI_Telco_Framework">8.5. CDI Telco Framework</a></span></dt><dt><span class="section"><a href="#ssds-Diameter_Support">8.6. Diameter Support</a></span></dt><dt><span class="section"><a href="#saimse-SIP_and_IMS_Extensions">8.7. SIP and IMS Extensions</a></span></dt><dt><span class="section"><a href="#ss_jslee_interop">8.8. SIP Servlets - JAIN SLEE Interoperability</a></span></dt><dt><span class="section"><a href="#d0e6130">8.9. Eclipse IDE Tools</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6141">8.9.1. Pre-Install requirements</a></span></dt><dt><span class="section"><a href="#d0e6146">8.9.2. Installation</a></span></dt><dt><span class="section"><a href="#d0e6157">8.9.3. SIP Servlets Core Plug-in</a></span></dt><dt><span class="section"><a href="#d0e6165">8.9.4. SIP Phone Plug-in</a></span></dt></dl></dd></dl></div><p>The advanced features of SIP Servlets include Concurrency and 
Congestion Control, load balancing with the Mobicents Load Balancer, and, exclusively for MSS for JBoss, clustering and failover support.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="mipbx-Media_Support"/>8.1. Media Support</h2></div></div></div><p>Mobicents SIP Servlets provides support for applications to set up
  calls through SIP by implementing the SIP Servlets
  1.1 Specification.</p><p>As most Telco services have the need for managing and
  controlling media (for example, to play announcements, mix calls and recognize
  DTMF), Mobicents SIP Servlets allows applications to control media through JSR 309.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e5081"/>8.1.1. JSR 309: Media Server Control API</h3></div></div></div><p>This specification is a protocol agnostic API for Media Server
    Control. It provides a portable interface to create media rich
    applications with IVR, Conferencing, Speech Recognition, and similar
    features.</p><p>Mobicents Media Server provides an implementation of the <a class="ulink" href="http://jcp.org/en/jsr/detail?id=309">JSR 309 specification</a> using the MGCP protocol, to
    allow any Media Server (located in the same Virtual Machine or
    on a remote server) supporting MGCP to be controlled.</p><p>The following examples demonstrate its usage:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><a class="ulink" href="http://www.mobicents.org/mss-jsr309-demo.html">Media Example</a> : a SIP Servlet application showing how to use media
        capabilities (Media playback, Recording, Text to Speech with FreeTTS and DTMF detection).</p></li><li class="listitem"><p><a class="ulink" href="http://www.mobicents.org/conference-demo-jsr309.html">Conference Demo</a> : a Conference Media Server demo application built on GWT
        with server-push updates.</p></li><li class="listitem"><p><a class="ulink" href="http://www.mobicents.org/shopping-demo-jsr309.html">Shopping Example</a> : a Converged JEE Application showing SEAM
        integration, JEE, Media integration with TTS and DTMF support.</p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sscacc-MSS_Concurrency_and_Congestion_Control"/>8.2. Concurrency and Congestion Control</h2></div></div></div><p>Concurrency and Congestion control refer to settings that
  define the way in which messages are processed under heavy load. The way Mobicents SIP Servlets Server processes messages in a production environment is crucial to ensure quality of service for customers.</p><p>Concurrency control mode tuning affects the way in which
  the SIP Servlets Server processes messages, whereas Congestion Control tuning affects the point at which the server
  begins rejecting new requests. Both of these parameters can be set using the following methods: </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Through the SIP Servlets Management Console.</p></li><li class="listitem"><p>Editing
  the server's <code class="filename">server.xml</code> or  <code class="filename">standalone-sip.xml</code> configuration file.</p></li><li class="listitem"><p>From the
  <code class="literal">dispatcher</code> MBean.</p></li><li class="listitem"><p>From the Embedded Jopr integrated
  management platform.</p></li></ul></div><p><strong>Concurrency Control. </strong>The JSR 289 expert group does not specify how concurrency control should be implemented.  </p><p>Mobicents SIP Servlets for JBoss and Mobicents SIP Servlets for Tomcat have concurrency control implemented as
    a configurable mode, which defines the way in which the SIP Servlets Server processes messages.</p><p>It has to be noted that this concurrency control mechanism is not cluster aware and will work per node only, it is not a cluster wide lock.</p><p>The following modes are provided, and cater for the particular setup required in an implementation:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">None</span></dt><dd><p>All SIP messages are processed as soon as possible in a thread
        from the global thread pool.</p><p>When two messages
        belong to the same <code class="literal">SipSession</code>, they can be concurrently processed. Ensure that SIP Messages that access shared resources (such as the session attribute) concurrently are synchronized in a
        thread-safe manner.</p></dd><dt><span class="term">Transaction</span></dt><dd><p>Bypass the SIP Servlets request/response executors, and utilize the JAIN SIP built-in Transaction serialization to manage race conditions on the same transaction.</p><p>By default, the SIP Servlets server uses a ThreadPoolExecutor linked to a LinkedBlockingQueue to dispatch the request/response threads. The container can thus handles two different response (for example a 180 Ringing and a 200 OK) concurrently, a race condition can occur where the second response overtakes the first one (200 OK dispatched to the application before the 180 Ringing).
        </p></dd><dt><span class="term">SipSession</span></dt><dd><p>SIP messages are processed as soon as possible except for messages originating from the same <code class="literal">SipSession</code>. These messages are excluded from any simultaneous processing. </p><p>Messages from the same
        <code class="literal">SipSession</code> are processed sequentially, in the order they  originally arrived. </p><p>Two (or more) messages from different
        <code class="literal">SipSession</code> instances in the same
        <code class="literal">SipApplicationSession</code> may be processed
        simultaneously. For this reason, ensure that SIP Messages that access shared resources (such as the session attribute) concurrently  are synchronized in a
        thread-safe manner. </p><p>Thread-safety is particularly important in Back-to-Back User Agent (B2BUA) cases,  where each communication leg of the
        B2BUA consists of a different <code class="literal">SipSession</code> in the
        same <code class="literal">SipApplicationSession</code>.</p></dd><dt><span class="term">SipApplicationSession</span></dt><dd><p>SIP messages are processed as soon as possible, with the
        guarantee that no two messages from the same
        <code class="literal">SipSession</code> <span class="emphasis"><em>or</em></span> from the same
        <code class="literal">SipApplicationSession</code> will ever be processed
        simultaneously.  Of all the available methods, this mode is the best choice for guaranteed  thread-safety. </p><p>If applications  access shared resources in an unmanaged
        way (for example,  by accessing a <code class="literal">SipSession</code> attribute
        from an unmanaged thread, or from an Enterprise JavaBean) access will not be synchronized.</p></dd></dl></div><p><strong>Congestion Control. </strong>Mobicents Sip Servlets currently provides the following  congestion
    control mechanisms:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Changing Congestion Control Settings </h2><p>
All the settings and congifurations starting with gov.nist.javax.sip are located in the $JBOSS-HOME/standalone/configuration/mss-sip-stack.properties file. The section below will provide further details.
</p></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Congestion control is largely application-specific and it is implemented in a pipeline. 
      First messages arrive in the JAIN SIP message queue where they will wait on the locks needed 
      before they can be processed. To avoid keeping too many messages in the queue and potentially
       running out of memory, older messages are discarded without any error indication. This prevents
        spam and flood DoS attacks to accumulate large backlog and render the server unresponsive. It also
         guranatees flood recovery time of 20 seconds or less, in the mean time retransmissions are
          already queuing so that normal SIP calls can continue without dropping them. After the request has passed the first 
          queue it enters the SIP transaction layer where there is a customizable optional congestion control logic.
          There is one packaged congestion control algorithm which can be enabled by setting the following property
           <code class="literal">gov.nist.javax.sip.SIP_MESSAGE_VALVE=gov.nist.javax.sip.stack.CongestionControlMessageValve</code>.
           For this algorithm you can set the limit value by the following property
          <code class="literal">gov.nist.javax.sip.MAX_SERVER_TRANSACTIONS=2000</code>. 
          You can also implement your own algorithm and change the class name in <code class="literal">gov.nist.javax.sip.SIP_MESSAGE_VALVE</code> to activate it.</p><p>
          
          There is also another optional legacy congestion
           control stage with another queue where messages can be discarded based on dynamic parameters
            such as available JVM heap memory or number of messages in the queue. This method will be deprecated and is not recommended. All SIP messages which
             cannot be processed immediately are put
      into a queue, and  wait for either a free thread or for the lock
      on their session to be released. The  size of the  SIP message
      queue is a tunable parameter, which defaults to
      <code class="literal">1500</code>.</p></li><li class="listitem"><p>If the SIP Message queue becomes full, the
      container immediately begins rejecting  new SIP requests until the queue clears.  This is achieved by using one of the following methods:</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><p>Sending a <code class="literal">503</code> SIP error code  to the originating application.</p></li><li class="listitem"><p>Dropping  incoming
      messages (according to the specified  congestion control policy).</p></li></ul></div></li><li class="listitem"><p>If the container exceeds the  configurable memory threshold (90% by  default), new  SIP requests are rejected   until the
      memory usage falls below the specified memory threshold.  This is achieved by using one of the following methods:</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><p>Sending a <code class="literal">503</code> SIP error code  to the originating application.</p></li><li class="listitem"><p>Dropping  incoming
      messages (according to the specified  congestion control policy).</p></li></ul></div></li></ul></div><p>A background task gathers information about the current server congestion.  The data collection interval   can be adjusted, and congestion control deactivated,  by setting the interval to 0 or a
  negative value.</p><p>The congestion control policy defines how an  incoming
  message is handled when  the server is overloaded.  The following parameters are configurable:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>DropMessage - drop any incoming message</p></li><li class="listitem"><p>ErrorResponse - send a 503 - Service Unavailable response to any
      incoming request (Default).</p></li></ul></div><p><a id="sscacc-Configuring_the_Concurrency_and_Congestion_Control_Settings"/><strong>Configuring the Concurrency and Congestion Control Settings. </strong>The concurrency and congestion control settings can be configured
    through the SIP Servlets Management Console, using the following methods: </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Through the SIP Servlets Management Console.</p></li><li class="listitem"><p>Editing
  the server's <code class="filename">server.xml</code> or the <code class="filename">standalone-sip.xml</code> configuration file.</p></li><li class="listitem"><p>From the
  <code class="literal">dispatcher</code> MBean.</p></li><li class="listitem"><p>From the Embedded Jopr integrated
  management platform.</p></li></ul></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Tuning Parameters with the SIP Servlets Management Console</span></dt><dd><p>The easiest way to configure the <span class="guilabel">SIP Message Queue Size</span> and <span class="guilabel">Concurrency Control Mode</span>
        tunable parameters is to open the <code class="literal">SIP Servlets Management Console</code> in your browser (by going to <a class="ulink" href="http://localhost:8080/sip-servlets-management">http://localhost:8080/sip-servlets-management</a>), making
        your changes, and then clicking <span class="guibutton">Apply</span>. </p><div class="figure"><a id="d0e5335"/><p class="title"><strong>Figure 8.1. SIP Servlets Management Console Concurrency and Congestion Control Tuning Parameters</strong></p><div class="figure-contents"><div class="mediaobject" align="center"><a id="sscacc-sas-MSSSManagementConsole-ss-ServerSettings-1"/><img src="images/mss-MSSSManagementConsole-ss-ServerSettings.png" align="middle" alt="SIP Servlets Management Console Concurrency and Congestion Control Tuning Parameters"/></div></div></div><br class="figure-break"/><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Persistent Settings</h2><p>Concurrency and congestion control settings altered through the SIP Servlets Management Console are not saved to the <code class="filename">server.xml</code> on Tomcat, only on JBoss AS7 through the <code class="filename">standalone-sip.xml</code>configuration file.  </p><p>To make settings persistent, append the settings to  the <code class="filename">server.xml</code> file directly.  </p></div></dd><dt><span class="term">Making your changes permanent in <code class="filename">standalone-sip.xml</code> or <code class="filename">server.xml</code> by manual editing</span></dt><dd><p>Alternatively, you can edit your server's
        <code class="filename">standalone-sip.xml</code> or <code class="filename">server.xml</code> configuration file, which has the
        benefit of making your chosen settings changes permanent for Tomcat. Instructions
        follow, grouped by the SIP Servlets Server you are running:</p><div class="procedure"><a id="d0e5375"/><p class="title"><strong>Procedure 8.1. Tuning Mobicents SIP Servlets for JBoss Server Settings for Concurrency and Congestion Control</strong></p><ol class="procedure" type="1"><li class="step"><p class="title"><strong>Open standalone-sip.xml File</strong></p><p>Open the
            <code class="filename"><code class="envar">$JBOSS_HOME/standalone/configuration/standalone-sip.xml </code></code>
            configuration file in a text editor.</p></li><li class="step"><div class="example"><a id="standalone-sip.xml-concurrency-editing"/><p class="title"><strong>Example 8.1. 
Extract from stanalone-sip.xml file with conccurency configuration
</strong></p><div class="example-contents"><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">



&lt;subsystem xmlns="urn:org.mobicents:sip-servlets-as7:1.0" application-router="dars/mobicents-dar.properties" stack-properties="mss-sip-stack.properties" path-name="gov.nist" app-dispatcher-class="org.mobicents.servlet.sip.core.SipApplicationDispatcherImpl" concurrency-control-mode="SipApplicationSession" congestion-control-interval="-1"&gt;
            &lt;connector name="sip-udp" protocol="SIP/2.0" scheme="sip" socket-binding="sip-udp"/&gt;
            &lt;connector name="sip-tcp" protocol="SIP/2.0" scheme="sip" socket-binding="sip-tcp"/&gt;
            &lt;connector name="sip-tls" protocol="SIP/2.0" scheme="sip" socket-binding="sip-tls"/&gt;
        &lt;/subsystem&gt;




</pre></div></div><br class="example-break"/></li></ol></div><div class="procedure"><a id="d0e5395"/><p class="title"><strong>Procedure 8.2. Tuning Mobicents SIP Servlets for Tomcat Server Settings for Concurrency and Congestion Control</strong></p><ol class="procedure" type="1"><li class="step"><p class="title"><strong>Open server.xml File</strong></p><p>Open the
            <code class="filename"><code class="envar">$CATALINA_HOME</code>/conf/server.xml</code>
            configuration file in your text editor.</p></li><li class="step"><p class="title"><strong>Add Parameters to &lt;service&gt; Element</strong></p><p>Locate the <span class="markup">&lt;service&gt;</span> element, and add the
            <code class="literal">concurrencyControlMode</code> and/or 
            <code class="literal">sipMessageQueueSize</code> attributes.</p><p>Possible values for the
            <code class="literal">concurrencyControlMode</code> attribute include:
            <em class="replaceable"><code>None</code></em>,
            <em class="replaceable"><code>SipSession</code></em> or
            <em class="replaceable"><code>SipApplicationSession</code></em>.
            <em class="replaceable"><code>SipSession</code></em> is the value of this
            attribute when it is not present—and overridden—in
            <code class="filename">server.xml</code>.</p></li><li class="step"><p class="title"><strong>Define the Correct Attribute Values</strong></p><p>The following  default values for the concurrency and congestion control parameters are used regardless of whether the attributes are defined in the <code class="filename">server.xml</code> file:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>sipMessageQueueSize="1500"</p></li><li class="listitem"><p>backToNormalSipMessageQueueSize="1300"</p></li><li class="listitem"><p>congestionControlCheckingInterval="30000" (30 seconds, in milliseconds)</p></li><li class="listitem"><p>memoryThreshold="95" (in percentage)</p></li><li class="listitem"><p>backToNormalMemoryThreshold="90" (in percentage)</p></li><li class="listitem"><p>congestionControlPolicy="ErrorResponse"</p></li></ul></div><p>Experimentation is required for these tuning parameters depending on the operating system and server.</p></li></ol></div></dd><dt><span class="term">Tuning Parameters from the dispatcher MBean</span></dt><dd><p>Navigate to the <code class="literal">dispatcher</code> MBean from
        Mobicents SIP Servlets for JBoss's JMX console. </p><p>All changes performed
        at run time are effective immediately, but do not persist across
        reboots for Tomcat, only on JBoss AS7.  the <code class="filename">server.xml</code> must be appended with the settings in order to make the configuration persistent.</p><p>When editing the <code class="literal">dispatcher</code> MBean from
        Mobicents SIP Servlets for JBoss's JMX console, values allowed for the
        concurrency control mode are <strong class="userinput"><code>None</code></strong>,
        <strong class="userinput"><code>SipSession</code></strong> or
        <strong class="userinput"><code>SipApplicationSession</code></strong>.</p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="mssstun-MSS_STUN"/>8.3. STUN Support</h2></div></div></div><p>The Session Traversal Utilities for NAT (STUN) prococol is used in
  Network Address Translation (NAT) traversal for real-time voice, video,
  messaging, and related interactive IP application communications. This
  light-weight, client-server protocol allows applications passing through a
  NAT to obtain the public IP address for the UDP connections the application
  uses to connect to remote hosts.</p><p>STUN support is provided at the SIP connector level, using the <a class="ulink" href="https://stun4j.dev.java.net/">STUN for Java</a> project. The STUN
  for Java project provides a Java implementation of the STUN Protocol (RFC
  3489), which allows each SIP connector to select whether it should use STUN
  to discover a public IP address, and then use this address in the SIP messages
  sent through the connector.</p><p>To make a SIP connector STUN-enabled, three attributes must be
  appended to the <span class="markup">&lt;connector&gt;</span> child element in the <code class="filename">server.xml</code> or <span class="markup">&lt;socket-binding&gt;</span> child element in <code class="filename">standalone-sip.xml</code>
  file. The properties are:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>useStun="true"</p><p>Enables STUN support for this connector. Ensure that the
        <code class="literal">ipAddress</code> attribute is not set to
        <code class="literal">127.0.0.1</code>.</p></li><li class="listitem"><p>stunServerAddress="&lt;Public_STUN_Server&gt;"</p><p>STUN server address used to discover the public IP address of
        this SIP Connector. See <a class="xref" href="#tab-pss-Public_STUN_Servers" title="Table 8.1. Public STUN Servers">Table 8.1, “Public STUN Servers”</a>for a suggested list of public
        STUN servers.</p></li><li class="listitem"><p>stunServerPort="3478"</p><p>STUN server port of the STUN server used in the
        <code class="literal">stunServerAddress</code> attribute. Both TCP and UDP
        protocols communicate with STUN servers using this port only.</p></li></ul></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>A complete list of available SIP connector attributes and their
    descriptions is located in the <a class="xref" href="#bsssc-binary-SIP_Servlets_Server-Adding_SIP_Connectors" title="2.3.1. Configuring SIP Connectors and Bindings">Section 2.3.1, “Configuring SIP Connectors and Bindings”</a>
    section of this guide.</p></div><p>A number of public STUN servers are available, and can be specified in
  the <code class="literal">stunServerAddress</code>. Depending on the router firmware used, the STUN reply
  packets' MAPPED_ADDRESS may be changed to the router's WAN port. To
  alleviate this problem, certain public STUN servers provide
  XOR_MAPPED_ADDRESS support. <a class="xref" href="#tab-pss-Public_STUN_Servers" title="Table 8.1. Public STUN Servers">Table 8.1, “Public STUN Servers”</a>
  provides a selection of public STUN servers.</p><div class="table"><a id="tab-pss-Public_STUN_Servers"/><p class="title"><strong>Table 8.1. Public STUN Servers</strong></p><div class="table-contents"><table summary="Public STUN Servers" border="1"><colgroup><col align="left" class="c1"/><col align="left" class="c2"/><col align="left" class="c3"/></colgroup><thead><tr><th align="center">Server Address</th><th align="center">XOR Support</th><th align="center">DNS SRV Record</th></tr></thead><tbody><tr><td align="left">stun.ekiga.net</td><td align="left">Yes</td><td align="left">Yes</td></tr><tr><td align="left">stun.fwdnet.net</td><td align="left">No</td><td align="left">Yes</td></tr><tr><td align="left">stun.ideasip.com</td><td align="left">No</td><td align="left">Yes</td></tr><tr><td align="left">stun01.sipphone.com</td><td align="left">Yes</td><td align="left">No</td></tr><tr><td align="left">stun.softjoys.com</td><td align="left">No</td><td align="left">No</td></tr><tr><td align="left">stun.voipbuster.com</td><td align="left">No</td><td align="left">No</td></tr><tr><td align="left">stun.voxgratia.org</td><td align="left">No</td><td align="left">No</td></tr><tr><td align="left">stun.xten.com</td><td align="left">Yes</td><td align="left">Yes</td></tr><tr><td align="left">stunserver.org</td><td align="left">Yes</td><td align="left">Yes</td></tr></tbody></table></div></div><br class="table-break"/><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>For more information about NAT traversal best practices, refer to <a class="xref" href="#bp-Best_Practices_NAT" title="9.2. NAT Traversal">Section 9.2, “NAT Traversal”</a>.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sscacc-MSS_JSR289_Extensions"/>8.4. Mobicents vendor-specific Extensions to JSR 289</h2></div></div></div><p>Mobicents provide Extensions for applications or external systems to interact with the Mobicents SIP Servlets container as well as Extensions not defined in the specification in the JSR 289 specification that can prove useful and might be proposed for inclusion in a next release of the SIP Servlets specification </p><p><a class="ulink" href="http://ci.jboss.org/jenkins/view/Mobicents/job/MobicentsBooks/lastSuccessfulBuild/artifact/api-docs/jsr289/extensions/index.html">Javadoc for Mobicents JSR 289 Extensions</a></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="stf-CDI_Telco_Framework"/>8.5. CDI Telco Framework</h2></div></div></div><p>CDI is the Java standard for dependency injection and contextual lifecycle management, led by Gavin King for Red Hat, Inc. and is a Java Community Process(JCP) specification that integrates cleanly with the Java EE platform. Any Java EE 6-compliant application server provides support for JSR-299 (even the web profile). It seemed a natural fit create a new framework based on CDI for the Telco world.</p><p>CDI-Telco-Framework (CTF) from Mobicents brings the power and productivity benefits of CDI into the Mobicents Sip Servlets platform providing dependency injection and contextual lifecycle management for converged HTTP/SIP applications. This new framework is intended to become a replacement for our previous Seam Telco Framework.</p><p>CTF mission statement is to simplify SipServlets development by introducing a component based programming model, ease of development by making available SIP utilities out of the box, and finally providing dependency injection and contextual lifecycle management to the SipServlets.</p><div class="figure"><a id="d0e5665"/><p class="title"><strong>Figure 8.2. CDI Telco Framework Extension</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/CDI_Telco_Framework_Extension.png" alt="CDI Telco Framework Extension"/></div></div></div><br class="figure-break"/><p>More information about the CTF can be found on the <a class="ulink" href="http://docs.jboss.org/mobicents/frameworks/ctf/1.0.0.ALPHA1/user_guide/en-US/html_single/">CDI Telco Framework Documentation</a>. </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ssds-Diameter_Support"/>8.6. Diameter Support</h2></div></div></div><p>The Diameter Protocol (<a class="ulink" href="http://www.ietf.org/rfc/rfc3588.txt">RFC 3588</a>) is a computer networking protocol for Authentication, Authorization, and Accounting (AAA). The Diameter version included in Mobicents SIP Servlets currently support Base, Sh, Ro and Rf.</p><p>For more information regarding Diameter support, refer to the <a class="ulink" href="https://code.google.com/p/jdiameter/">Diameter Home Page</a>. For a list of Diameter examples, refer to <a class="xref" href="#ssea-SIP_Servlet_Example_Applications" title="Chapter 4. SIP Servlet Example Applications">Chapter 4, <em>SIP Servlet Example Applications</em></a>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="saimse-SIP_and_IMS_Extensions"/>8.7. SIP and IMS Extensions</h2></div></div></div><p>SIP Extensions in the SIP Servlets Server are based on the Internet Engineering Task Force's (IETF) Request for Comments (RFC) protocol recommendations. <a class="xref" href="#tab-sse-Supported_SIP_Extensions" title="Table 8.2. Supported SIP Extensions">Table 8.2, “Supported SIP Extensions”</a> lists the supported RFCs for the SIP Servlets Server.</p><div class="table"><a id="tab-sse-Supported_SIP_Extensions"/><p class="title"><strong>Table 8.2. Supported SIP Extensions</strong></p><div class="table-contents"><table summary="Supported SIP Extensions" border="1"><colgroup><col align="left" class="c1"/><col align="left" class="c2"/><col align="left" class="c3"/></colgroup><thead><tr><th align="center">Extension</th><th align="center">RFC Number</th><th align="center">Description</th></tr></thead><tbody><tr><td align="left">DNS</td><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3263.txt">RFC 3263</a></td><td align="left">SIP: Locating SIP Servers</td></tr><tr><td align="left">ENUM</td><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc2916.txt">RFC 2916</a></td><td align="left">E.164 number and DNS</td></tr><tr><td align="left">INFO</td><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc2976.txt">RFC 2976</a></td><td align="left">The SIP INFO Method</td></tr><tr><td align="left">IPv6</td><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc2460.txt">RFC 2460</a></td><td align="left">Internet Protocol, Version 6 (IPv6) Specification</td></tr><tr><td align="left">JOIN</td><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3911.txt">RFC 3911</a></td><td align="left">The SIP "Join" Header</td></tr><tr><td align="left">MESSAGE</td><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3428.txt">RFC 3428</a></td><td align="left">SIP Extension for Instant Messaging</td></tr><tr><td align="left">PATH</td><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3327.txt">RFC 3327</a></td><td align="left">SIP Extension Header Field for Registering Non-Adjacent Contacts</td></tr><tr><td align="left">PRACK</td><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3262.txt">RFC 3262</a></td><td align="left">Reliability of Provisional Responses in the SIP</td></tr><tr><td align="left">PUBLISH</td><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3903.txt">RFC 3903</a></td><td align="left">SIP Extension for Event State Publication</td></tr><tr><td align="left">REASON</td><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3326.txt">RFC 3326</a></td><td align="left">The Reason Header Field for the Session Initiation Protocol (SIP)</td></tr><tr><td align="left">REFER</td><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3515.txt">RFC 3515</a></td><td align="left">The SIP Refer Method</td></tr><tr><td align="left">REPLACES</td><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3891.txt">RFC 3891</a></td><td align="left">The SIP "Replaces" Header</td></tr><tr><td align="left">STUN</td><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3489.txt">RFC 3489</a></td><td align="left">STUN - Simple Traversal of User Datagram Protocol (UDP) through Network Address Translators (NATs)</td></tr><tr><td align="left">SUBSCRIBE/NOTIFY</td><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3265.txt">RFC 3265</a></td><td align="left">SIP-specific Event Notification</td></tr><tr><td align="left">Symmetric Response Routing</td><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3581.txt">RFC 3581</a></td><td align="left">An Extension to the Session Initiation Protocol (SIP) for Symmetric Response Routing</td></tr><tr><td align="left">Multipart type</td><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc4662.txt">RFC 4662</a></td><td align="left">A Session Initiation Protocol (SIP) Event Notification</td></tr><tr><td align="left">To/From Header Modification </td><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc4916.txt">RFC 4916</a></td><td align="left">Connected Identity in the Session Initiation Protocol (SIP)
</td></tr></tbody></table></div></div><br class="table-break"/><p>IMS Private Header (P-Header) Extensions are provided according to the recommendations of the <a class="ulink" href="http://www.3gpp.org/">3rd Generation Partnering Project (3GPP)</a> and the IETF. P-Header extensions are primarily used to store information about the networks a call traverses, including security or call charging details.</p><p><a class="xref" href="#tab-sse-IMS_P-Header_Extensions" title="Table 8.3. IMS P-Header Extensions">Table 8.3, “IMS P-Header Extensions”</a> describes the list of supported P-Headers, including links to the relevant ITEF memorandum where available.</p><div class="table"><a id="tab-sse-IMS_P-Header_Extensions"/><p class="title"><strong>Table 8.3. IMS P-Header Extensions</strong></p><div class="table-contents"><table summary="IMS P-Header Extensions" border="1"><colgroup><col align="left" class="c1"/><col align="left" class="c2"/></colgroup><thead><tr><th align="center">Extension</th><th align="center">Description</th></tr></thead><tbody><tr><td align="left">AuthorizationHeaderIMS</td><td align="left">Defines a new auth-param for the Authorization header used in REGISTER requests.</td></tr><tr><td align="left">PAccessNetworkInfoHeader</td><td align="left">Contains information regarding the access network the User Agent (UA) uses to connect to the SIP Proxy. The information contained in this header may be sensitive, such as the cell ID, so it is important to secure all SIP application that interface with this header.</td></tr><tr><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3324.txt">PAssertedIdentityHeader</a></td><td align="left">Contains an identity resulting from an authentication process, derived from a SIP network intermediary. The identity may be based on SIP Digest authentication.</td></tr><tr><td align="left">PAssertedServiceHeader</td><td align="left">Contains information used by "trust domains", according to Spec(T) specifications detailed in <a class="ulink" href="http://www.ietf.org/rfc/rfc3324.txt">RFC 3324</a>.</td></tr><tr><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3455.txt">PAssociatedURIHeader</a></td><td align="left">Contains a list of URIs that are allocated to the user. The header is defined in the 200 OK response to a REGISTER request. It allows the User Agent Client (UAC) to determine the URIs the service provider has associated to the user's address-of-record URI.</td></tr><tr><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3327.txt">PathHeader</a></td><td align="left">SIP Extension header, with syntax similar to the RecordRoute header. Used in conjunction with SIP REGISTER requests and 200 class messages in response to REGISTER responses.</td></tr><tr><td align="left">PCalledPartyIDHeader</td><td align="left">Typically inserted en-route into an INVITE request by the proxy, the header is populated with the Request_URI received by the proxy in the request. The header allows the User Agent Server (UAS) to identify which address-of-record the invitation was sent to, and can be used to render distinctive audio-visual alert notes based on the URI.</td></tr><tr><td align="left">PChargingFunctionAddressesHeader</td><td align="left">Contains a list of one or more of the Charging Collection Function (CCF) and the Event Charging Function (ECF) addresses. The CCF and ECF addresses may be passed during the establishment of a dialog, or in a standalone transaction.</td></tr><tr><td align="left">PChargingVectorHeader</td><td align="left">Contains a unique charging identifier and correlation information, which is used by network operators to correctly charge for routing events through their networks.</td></tr><tr><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3313.txt">PMediaAuthorizationHeader</a></td><td align="left">Contains one or more session-specific media authorization tokens, which are used for QoS of the media streams.</td></tr><tr><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3325.txt">PPreferredIdentityHeader</a></td><td align="left">Contains a SIP URI and an optional display-name.  For example, "James May" &lt;sip:james@domain.com&gt;. This header is used by trusted proxy servers to identify the user to other trusted proxies, and can be used to select the correct SIP URI in the case of multiple user identities.</td></tr><tr><td align="left">PPreferredServiceHeader</td><td align="left">Used by the PAssertedService Header to determine the preferred user service.  Multiple PPreferreedService headers may be present in a single request.</td></tr><tr><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc5002.txt">PProfileKeyHeader</a></td><td align="left">Contains a key used by a proxy to query the user database for a given profile. The key may contain wildcards that are used as part of the query into the database.</td></tr><tr><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3323.txt">PrivacyHeader</a></td><td align="left">Contains values that determine whether particular header information is deemed as private by the UA for requests and responses.</td></tr><tr><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc5502.txt">PServedUserHeader</a></td><td align="left">Contains an identity of the user that represents the served user. The header is added to the initial requests for a dialog or standalone request, which are then routed between nodes in a trusted domain.</td></tr><tr><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc4457.txt">PUserDatabaseHeader</a></td><td align="left">Contains the address of the HSS handling the user that generated the request. The header field is added to request routed from an Interrogating Call Session Control Function (I-CSCF) to a Serving Call Session Control Function (S-CSCF).</td></tr><tr><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3455.txt">PVisitedNetworkIDHeader</a></td><td align="left">Contains the identifier of a visited network. The identifier is a text string or token than it known by both the registrar or the home proxy at the home network, and the proxies in the visited network.</td></tr><tr><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3329.txt">SecurityClientHeader, SecurityServerHeader, SecurityVerifyHeader</a></td><td align="left">Contains information used to negotiate the security mechanisms between a UAC, and other SIP entities including UAS, proxy and registrar.</td></tr><tr><td align="left"><a class="ulink" href="http://www.ietf.org/rfc/rfc3608.txt">ServiceRouteHeader</a></td><td align="left">Contains a route vector that will direct requests through a specified sequence of proxies. The header may be included by a registrar in response to a REGISTER request.</td></tr><tr><td align="left"><a class="ulink" href="http://snad.ncsl.nist.gov/proj/iptel/jain-sip-1.2/javadoc/gov/nist/javax/sip/header/ims/WWWAuthenticateHeaderIms.html">WWWAuthenticateHeaderIms</a></td><td align="left">Extends the WWWAuthenticateResponse header functionality by defining an additional authorization parameter (auth-param).</td></tr></tbody></table></div></div><br class="table-break"/></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ss_jslee_interop"/>8.8. SIP Servlets - JAIN SLEE Interoperability</h2></div></div></div><p>JAIN SLEE is a more complex specification than SIP Servlets, and it
  has been know as heavyweight and with a steep learning curve. However JAIN
  SLEE has standardized a high performing event driven application server, an
  execution environment with a good concurrency model and powerful protocol
  agnostic capabilities thus covering a variety of Telco protocols.</p><p>SIP Servlets on the other hand is much simpler and easier to get started
  with. Its focus is on extending the HTTP Servlets and Java EE hosting
  environments with SIP capabilities. SIP Servlets is more of a SIP
  programming framework, while JSLEE is a complete, self sufficient application
  platform. The fact that SIP Servlets is focused on SIP and
  Java EE makes it a natural fit to build JEE converged applications.</p><div class="table"><a id="tab-ss_vs_jslee"/><p class="title"><strong>Table 8.4. SIP Servlets / JAIN SLEE Comparison Table</strong></p><div class="table-contents"><table summary="SIP Servlets / JAIN SLEE Comparison Table" border="1"><colgroup><col align="left" class="c1"/><col align="left" class="c2"/></colgroup><thead><tr><th align="center">SIP Servlets</th><th align="center">JAIN SLEE</th></tr></thead><tbody><tr><td colspan="2" align="center">
              <span class="bold"><strong>Application Architecture</strong></span>
            </td></tr><tr><td align="center">Based on HTTP Servlets. Unit of logic is the SIP Servlets</td><td align="center">Component based, Object Orientated architecture. Unit of logic is the Service Building Block</td></tr><tr><td align="center">Composition through Application Router</td><td align="center">Composition through parent-child relationship</td></tr><tr><td colspan="2" align="center">
              <span class="bold"><strong>Application State</strong></span>
            </td></tr><tr><td align="center">Servlets are stateless</td><td align="center">SBBs may be stateful</td></tr><tr><td align="center">Shared state stored in a session and visible to all Servlets with access to the session</td><td align="center">SBB state is transacted and a property of the SBB itself. Shared state may be stored in a separate ActivityContext via a type safe interface</td></tr><tr><td colspan="2" align="center">
              <span class="bold"><strong>Concurrency Control</strong></span>
            </td></tr><tr><td align="center">Application managed: use of Java monitors</td><td align="center">System Managed: isolation of concurrent transactions</td></tr><tr><td colspan="2" align="center">
              <span class="bold"><strong>Facilities (Utilities for Applications)</strong></span>
            </td></tr><tr><td align="center">Timer, Listeners</td><td align="center">Timer, Trace, Alarm, Statistics, Profiles.</td></tr><tr><td colspan="2" align="center">
              <span class="bold"><strong>Protocol Support</strong></span>
            </td></tr><tr><td align="center">SIP, HTTP and Media (JSR 309)</td><td align="center">Protocol agnostic. Consistent event model, regardless of protocol/resource</td></tr><tr><td colspan="2" align="center">
              <span class="bold"><strong>Availability Mechanisms</strong></span>
            </td></tr><tr><td align="center">Container managed state (session object) that can be replicated</td><td align="center">Container managed state (SBB CMP, Facility, ActivityContext) that can be replicated</td></tr><tr><td align="center">No transaction context for SIP message processing</td><td align="center">Transaction context for event delivery</td></tr><tr><td align="center">Non transacted state operations</td><td align="center">Container managed state operations are transacted</td></tr><tr><td align="center">Facilities are non transacted</td><td align="center">Facilities, timers, are transacted</td></tr><tr><td align="center">No defined failure model</td><td align="center">Well defined and understood failure model via transactions</td></tr><tr><td colspan="2" align="center">
              <span class="bold"><strong>Management</strong></span>
            </td></tr><tr><td align="center">No standard management mechanisms defined</td><td align="center">JMX Interface for managing applications, life cycle, upgrades, ...</td></tr></tbody></table></div></div><p><br class="table-break"/></p><p>JSLEE and SIP Servlets target different audiences with different needs,
  but they can be complementary in a number of real world cases.</p><p>SIP Servlets focuses on SIP and its integration with Java EE. It is
  also more of a SIP framework within Java EE. JSLEE is an event driven
  application server with protocol agnostic architecture, spanning any legacy
  or potential future protocols. SIP Servlets applications are generally
  simpler to implement and accelerate time to market for Web and SIP
  deployment scenarios. JSLEE has a steeper learning curve and covers a wider
  set of target deployment environments.</p><p>As JBoss is the only vendor to implement both specifications through
  Mobicents, this makes it a natural fit to build converged and interoperable
  JSLEE/SIP Servlets applications that are able to comply with standards in a
  portable manner. We built an application that could leverage standards all
  the way without resorting to vendor proprietary extensions by making SIP
  Servlets and JSLEE work together. <a class="ulink" href="http://mobicents.googlecode.com/files/deruelle-JSleeSipServletsInteroperability-final.pdf">Our "JSLEE and SIP-Servlets Interoperability with Mobicents Communication Platform" paper</a> describes our approach and the possible different
  approaches we have identified to achieve the goal of interoperability
  between SIP Servlets and JSLEE.</p><p>You can also use our <a class="ulink" href="https://code.google.com/p/sipservlets/source/browse/#git%2Fsip-servlets-examples%2Fjslee-sips-interop">JSLEE/SIP Servlets interoperability example</a>, showcasing our approach.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="d0e6130"/>8.9. Eclipse IDE Tools</h2></div></div></div><p>The SIP Servlets Eclipse tools assist developers in creating JSR-289 applications with Mobicents. You can use the Dynamic Web Project wizard for converged applications to get started with an empty project, and then test your application with a real SIP Phone right from the IDE.</p><div class="figure"><a id="d0e6135"/><p class="title"><strong>Figure 8.3. SIP Servlets Eclipse IDE Tools</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/mss-ide-screen.png" alt="SIP Servlets Eclipse IDE Tools"/></div></div></div><br class="figure-break"/><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6141"/>8.9.1. Pre-Install requirements</h3></div></div></div><p>Eclipse 3.4 is required.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6146"/>8.9.2. Installation</h3></div></div></div><p>The standard Eclipse update site installation mechanism is leveraged. The Mobicents Update Site is at the following location: <a class="ulink" href="http://mobicents.googlecode.com/svn/downloads/sip-servlets-eclipse-update-site">http://mobicents.googlecode.com/svn/downloads/sip-servlets-eclipse-update-site</a>. After adding this update site to Eclipse you can proceed with the regular Eclipse Plug-in Installation. If you need help, the process is demonstrated in <a class="ulink" href="http://www.youtube.com/watch?v=LZOmLEC2IeQ">this video</a>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6157"/>8.9.3. SIP Servlets Core Plug-in</h3></div></div></div><p>This plug-in allows you to create Dynamic Web Projects with the SIP Facet. There are a number of new Dynamic Web Project configurations for Converged applications. It is best to use the ones marked as "recommended". After you complete the wizard, a complete converged project skeleton will be generated. Working with this type of project is similar to working with normal Web projects. You can see a demo <a class="ulink" href="http://people.redhat.com/vralev/mss-eclipse-plugin-demo/mss-eclipse.htm">here</a>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6165"/>8.9.4. SIP Phone Plug-in</h3></div></div></div><p>The SIP Phone plug-in integrates a SIP phone inside your Eclipse IDE. You can use the phone to test your SIP or Media applications. The phone uses the microphone and speakers on your computer and allows you to simulate real-world scenarios.</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="bp-Best_Practices"/>Chapter 9. Best Practices</h1></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#bp-Best_Practices_Perf_Tips">9.1. Mobicents SIP Servlets Performance Tips</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6183">9.1.1. Tuning JBoss</a></span></dt><dt><span class="section"><a href="#d0e6200">9.1.2. Tuning Mobicents SIP Servlets</a></span></dt><dt><span class="section"><a href="#d0e6229">9.1.3. Tuning The JAIN SIP Stack</a></span></dt><dt><span class="section"><a href="#d0e6346">9.1.4. Tuning The JVM</a></span></dt><dt><span class="section"><a href="#d0e6402">9.1.5. Tuning The Operating System</a></span></dt></dl></dd><dt><span class="section"><a href="#bp-Best_Practices_NAT">9.2. NAT Traversal</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6481">9.2.1. STUN</a></span></dt><dt><span class="section"><a href="#d0e6490">9.2.2. TURN</a></span></dt><dt><span class="section"><a href="#d0e6501">9.2.3. ICE</a></span></dt><dt><span class="section"><a href="#d0e6516">9.2.4. Other Approaches</a></span></dt></dl></dd></dl></div><p>This chapter discusses Best Practices related to Mobicents
  SIP Servlets usage in real world deployments.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="bp-Best_Practices_Perf_Tips"/>9.1. Mobicents SIP Servlets Performance Tips</h2></div></div></div><p>Because the default profile of Mobicents SIP Servlets is targeted at a
    development environment, some tuning is required to make the server performance suitable for a production environment.</p><p>A useful presentation from OKI Japan </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6183"/>9.1.1. Tuning JBoss</h3></div></div></div><p>To ensure the server is finely tuned for a production envirionment, certain configuration must be changed. Visit the <a class="ulink" href="http://wiki.jboss.org/wiki/Wiki.jsp?page=JBossASTuningSliming">JBoss Application Server Tuning</a> wiki page to learn about optimization techniques.
       </p><p>While it is preferable to have a fast Application Server, most of the information doesn't apply to Mobicents. In summary, the most important optimization technique is to remove logs, leaving only what is required.</p><p> Check the log configuration file in
      the following location and review the information.</p><p>
 <a class="xref" href="#bsssc-binary-SIP_Servlets_Server-Configuring_Logging" title="2.3.3. SIP Servlets Server Logging">Section 2.3.3, “SIP Servlets Server Logging”</a> 
</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6200"/>9.1.2. Tuning Mobicents SIP Servlets</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><span class="emphasis"><em>Congestion Control</em></span>: It is recommended that this feature is enabled to avoid overload of the server and that the <span class="emphasis"><em>sipMessageQueueSize</em></span> and <span class="emphasis"><em>memoryThreshold</em></span> parameters are tuned according to <a class="xref" href="#sscacc-MSS_Concurrency_and_Congestion_Control" title="8.2. Concurrency and Congestion Control">Section 8.2, “Concurrency and Congestion Control”</a>.</p></li><li class="listitem"><p><span class="emphasis"><em>Concurrency</em></span> :
          <span class="emphasis"><em>Default Value: None.</em></span>  For better performance, it is recommended to leave this value set to <strong class="userinput"><code>None</code></strong>.</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6229"/>9.1.3. Tuning The JAIN SIP Stack</h3></div></div></div><p>The stack can be fine-tuned by altering the SIP stack properties, defined in the external properties file specified by the <span class="emphasis"><em>sipStackPropertiesFile</em></span> attribute as described in <a class="xref" href="#bsssc-binary-SIP_Servlets_Server-Adding_SIP_Connectors" title="2.3.1. Configuring SIP Connectors and Bindings">Section 2.3.1, “Configuring SIP Connectors and Bindings”</a>.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><span class="emphasis"><em>gov.nist.javax.sip.THREAD_POOL_SIZE</em></span>
          </p><p><span class="emphasis"><em>Default value: 64</em></span></p><p>This thread pool is
          responsible for parsing SIP messages received from socket messages into
          objects.</p><p>A smaller value will make the stack less responsive, since
          new messages have to wait in a queue for free threads. In UDP, this
          can lead to more retransmissions.</p><p>Large thread pool sizes result in allocating resources
          that are otherwise not required.</p></li><li class="listitem"><p><span class="emphasis"><em>gov.nist.javax.sip.REENTRANT_LISTENER</em></span>
          </p><p><span class="emphasis"><em>Default value: true</em></span> </p><p>This flag indicates whether the
          SIP stack listener is executed by a single thread, or concurrently
          by the threads that parse the messages. </p><p>Mobicents SIP
          Servlets expects this flag to be set to <strong class="userinput"><code>true</code></strong>, therefore do not change the value.</p></li><li class="listitem"><p><span class="emphasis"><em>gov.nist.javax.sip.LOG_MESSAGE_CONTENT</em></span>
          </p><p><span class="emphasis"><em>Default value: true</em></span></p><p>Set the parameter to <strong class="userinput"><code>false</code></strong> to disable message logging.</p></li><li class="listitem"><p><span class="emphasis"><em>gov.nist.javax.sip.TRACE_LEVEL=0</em></span>
          </p><p><span class="emphasis"><em>Default value: 32</em></span>. </p><p>Set the parameter to <strong class="userinput"><code>0</code></strong> to disable JAIN SIP stack logging.</p></li><li class="listitem"><p><span class="emphasis"><em>gov.nist.javax.sip.RECEIVE_UDP_BUFFER_SIZE=65536 and gov.nist.javax.sip.SEND_UDP_BUFFER_SIZE=65536</em></span>
          </p><p><span class="emphasis"><em>Default value: 65536</em></span>. </p><p>Those properties control the size of the UDP buffer used for SIP messages. Under load, if the buffer capacity is overflown the messages are dropped causing retransmissions, further increasing the load and causing even more retransmissions.</p></li><li class="listitem"><p><span class="emphasis"><em>gov.nist.javax.sip.MAX_MESSAGE_SIZE=10000</em></span>
          </p><p><span class="emphasis"><em>Default value: 10000</em></span>. </p><p>This property controls the maximum size of content that can be read for a SIP Message on UDP.  The default is 65536. The average UDP message size is quite lower than this so reducing this property will benefit memory usage since a byte buffer of this size is created for every message received.</p><p>It also defines the maximum size of content that a TCP connection can read. Must be at least 4K. Default is "infinity" -- ie. no limit. This is to prevent DOS attacks launched by writing to a TCP connection until the server chokes.</p></li><li class="listitem"><p><span class="emphasis"><em>gov.nist.javax.sip.TCP_POST_PARSING_THREAD_POOL_SIZE=30</em></span>
          </p><p><span class="emphasis"><em>Default value: 30</em></span>. </p><p>Use 0 or do not set this option to disable it. When using TCP, your phones/clients usually connect independently, creating their own TCP sockets. Sometimes however SIP devices are allowed to tunnel multiple calls over a single socket. This can also be simulated with SIPP by running "sipp -t t1".</p><p>In the stack, each TCP socket has it's own thread. When all calls are using the same socket they all use a single thread, which leads to severe performance penalty, especially on multi-core machines. This option instructs the SIP stack to use a thread pool and split the CPU load between many threads. The number of the threads is specified in this parameter.</p><p>The processing is split immediately after the parsing of the message. It cannot be split before the parsing because in TCP the SIP message size is in the Content-Length header of the message and the access to the TCP network stream has to be synchronized.</p><p>Additionally, in TCP the message size can be larger. This causes most of the parsing for all calls to occur in a single thread, which may have impact on the performance in trivial applications using a single socket for all calls. In most applications it doesn't have performance impact. If the phones/clients use separate TCP sockets for each call, this option doesn't have much impact, except the slightly increased memory footprint caused by the thread pool. It is recommended to disable this option in this case by setting it 0 or not setting it at all. You can simulate multi-socket mode with "sipp -t t0". With this option also we avoid closing the TCP socket when something fails, because we must keep processing other messages for other calls. Note: This option relies on accurate Content-Length headers in the SIP messages. It cannot recover once a malformed message is processed, because the stream iterator will not be aligned any more. Eventually the connection will be closed.</p></li></ul></div><p>The full list of JAIN SIP stack properties is available from
      <a class="ulink" href="http://snad.ncsl.nist.gov/proj/iptel/jain-sip-1.2/javadoc/javax/sip/SipStack.html">the SIP Stack Properties Home Page</a>
      and the full list of implementation specific properties are available
      from the <a class="ulink" href="http://snad.ncsl.nist.gov/proj/iptel/jain-sip-1.2/javadoc/gov/nist/javax/sip/SipStackImpl.html">SIP Stack Implementation Home Page</a>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6346"/>9.1.4. Tuning The JVM</h3></div></div></div><p>The following tuning information applies to Sun JDK 1.6, however the information should also apply
      to Sun JDK 1.5.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>For more information on tuning Mobicents SIP Servlets performance, refer to the <a class="ulink" href="http://www.slideshare.net/jean.deruelle/tuning-and-development-with-sip-servlets-on-mobicents">OKI Japan Presentation</a>.</p><p>For more information on performance, refer to the <a class="ulink" href="http://java.sun.com/performance/reference/whitepapers/6_performance.html">Performance White Paper</a>.</p></div><p>To pass arguments to the JVM, change
      <code class="filename">$JBOSS_HOME/bin/standalone.conf</code> (Linux) or <code class="filename">$JBOSS_HOME/bin/standalone.bat</code> (Windows).</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><span class="bold"><strong>Garbage Collection</strong></span> </p><p>JVM
          ergonomics automatically attempt to select the best garbage collector. The
          default behaviour is to select the throughput collector, however a disadvantage of the throughput collector is that it can have long pauses times, which
          ultimately blocks JVM processing. </p><p>For low-load implementations, consider using the incremental, low-pause, garbage collector
          (activated by specifying <span class="emphasis"><em>
              <strong class="userinput"><code>-XX:+UseConcMarkSweepGC -XX:+CMSIncrementalMode</code></strong>
            </em></span>). Many SIP applications can benefit from this garbage collector type because it reduces the retransmission amount. </p><p>For more
          information please read: <a class="ulink" href="http://java.sun.com/javase/technologies/hotspot/gc/gc_tuning_6.html">Garbage Collector Tuning </a></p></li><li class="listitem"><p><span class="bold"><strong>Heap</strong></span> <span class="bold"><strong>Size</strong></span> </p><p>Heap size is an important consideration for
          garbage collection. Having an unnecessarily large heap can stop the JVM for
          seconds, to perform garbage collection.</p><p>Small heap sizes are not
          recommended either, because they put unnecessary pressure on the garbage
          collection system. </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6402"/>9.1.5. Tuning The Operating System</h3></div></div></div><p>The following tuning information is provided for Red Hat Enterprise Linux (RHEL) servers that are running high-load configurations. The tuning information should also apply to other Linux distributions.</p><p>After you have configured RHEL with the tuning information, you must restart the operating system. You should see improvements in I/O response times. With SIP, the
      performance improvement can be as high as 20%. </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><span class="bold"><strong>Large Memory Pages</strong></span> </p><p>Setting large memory pages
          can reduce CPU utilization by up to 5%. </p><p>Ensure that  the option
          <span class="emphasis"><em>
              <strong class="userinput"><code>-XX:+UseLargePages</code></strong>
            </em></span> is passed and ensure that the following Java
          HotSpot(TM) Server VM warning does not occur:</p><p><code class="literal">Failed to reserve shared memory (errno = 22)" when starting JBoss.</code> It means that the number of pages at OS level is still not enough.</p><p>To learn
          more about large memory pages, and how to configure them, refer to 
          <a class="ulink" href="http://java.sun.com/javase/technologies/hotspot/largememory.jsp">Java Support for Large Memory Pages</a> and <a class="ulink" href="http://andrigoss.blogspot.com/2008/02/jvm-performance-tuning.html">Andrig's Miller blog post</a>.</p></li><li class="listitem"><p><span class="emphasis"><em>Network buffers</em></span> </p><p>You can
          increase the network buffers size by adding the following lines to
          your <code class="filename">/etc/sysctl.conf</code> file:</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><p><strong class="userinput"><code>net.core.rmem_max = 16777216</code></strong></p></li><li class="listitem"><p><strong class="userinput"><code>net.core.wmem_max = 16777216</code></strong></p></li><li class="listitem"><p><strong class="userinput"><code>net.ipv4.tcp_rmem = 4096 87380 16777216</code></strong></p></li><li class="listitem"><p><strong class="userinput"><code>net.ipv4.tcp_wmem = 4096 65536 16777216</code></strong></p></li><li class="listitem"><p><strong class="userinput"><code>net.core.netdev_max_backlog = 300000</code></strong></p></li></ul></div></li><li class="listitem"><p>Execute the following command to set the network interface address:</p><p><span class="command"><strong>sudo ifconfig [eth0] txqueuelen 1000 # </strong></span></p><p>Replace [eth0] with the correct name of the
          actual network interface you are setting up.</p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="bp-Best_Practices_NAT"/>9.2. NAT Traversal</h2></div></div></div><p>In a production environment, it is common to see SIP and Media
    data passing through different kinds of Network Address Translation (NAT) to reach the
    required endpoints. Because NAT Traversal is a complex topic, refer to the following information to help determine the most effective method to handle NAT issues.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6481"/>9.2.1. STUN</h3></div></div></div><p>STUN (Session Traversal Utilities for NAT) is not generally
      considered a viable solution for enterprises because STUN cannot be used
      with symmetric NATs.</p><p>Most enterprise-grade
      firewalls are symmetric, therefore STUN support must be provided in the SIP Clients themselves.
      </p><p>Most of the proxy and media gateways installed by VoIP providers 
      recognize the public IP address the packets have originated from. When both SIP end points are behind a NAT, they can act as
      gateways to clients behind NAT.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6490"/>9.2.2. TURN</h3></div></div></div><p>TURN (Traversal Using Relay NAT) is an IETF standard, which
      implements media relays for SIP end-points. The standard overcomes the problems of
      clients behind symmetric NATs which cannot rely on STUN to solve NAT
      traversal.</p><p>TURN connects clients behind a NAT to a single peer, providing the same protection offered by symmetric NATs and
      firewalls. The TURN server acts as a relay; any data received is
      forwarded. </p><p>This type of implementation is not ideal. It assumes the clients
      have a trust relationship with a TURN server, and a request session
      allocation based on shared credentials. </p><p>This can result in scalability issues,
      and requires changes in the SIP clients. It is also impossible to determine
      when a direct, or TURN, connection is appropriate.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6501"/>9.2.3. ICE</h3></div></div></div><p>ICE (Interactive Connection Establishment) leverages both
      STUN and TURN to solve the NAT traversal issues.</p><p>It allows devices to
      probe for multiple paths of communication, by attempting to use different
      port numbers and STUN techniques. If ICE support is present in both
      devices, it is quite possible that the devices can initiate and maintain communication
      end-to-end, without any intermediary media relay.</p><p>Additionally, ICE can
      detect cases where direct communication is impossible and automatically initiate fall-back to a media relay. </p><p>ICE is not currently in widespread use in SIP devices, because ICE capability must be embedded within 
      the SIP devices. </p><p>Depending
      on the negotiated connection, a reINVITE may be required during a session, which adds more
      load to the SIP network and more latency to the call.</p><p>If the
      initiating ICE client attempts to call a non-ICE client, then the call
      setup-process will revert to a conventional SIP call requiring NAT
      traversal to be solved by other means.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6516"/>9.2.4. Other Approaches</h3></div></div></div><p>While the above is a good solution to circumvent NAT issues. There might be cases where it is not possible to use those solutions at all.</p><p>Other approaches include using proxy and media that can act as
      gateways, Session Border Controllers, enhanced Firewall with Application
      Layer Gateway (ALG) and Tunnelling.</p><p>
    	Here is more information on <a class="ulink" href="http://groups.google.com/group/mobicents-public/browse_thread/thread/5f1d6cbda9e8c302">Session Border Controllers</a> and how they can resolve NAT issues when above solutions 
    	are not possible
    </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="Appendix"/>Chapter 10. Apendix</h1></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#install-configure-JDK">10.1. Java Development Kit (<acronym class="acronym">JDK</acronym>): Installing, Configuring and Running</a></span></dt><dd><dl><dt><span class="section"><a href="#JRE-or-JDK-32Bit-or-64Bit">10.1.1.  JRE versus JDK - 32-Bit versus 64-Bit</a></span></dt><dt><span class="section"><a href="#Downloading-JDK">10.1.2. Downloading JDK </a></span></dt><dt><span class="section"><a href="#install-JDK-on-windows">10.1.3. Installing JDK on Windows</a></span></dt><dt><span class="section"><a href="#setting-ENV-linux">10.1.4. Setting Linux JAVA_HOME Environment Variables </a></span></dt><dt><span class="section"><a href="#setting-correct-java-version">10.1.5. Setting the Correct Java Version </a></span></dt><dt><span class="section"><a href="#setting-ENV-windows">10.1.6. Setting JAVA_HOME Environment Variables on Windows</a></span></dt><dt><span class="section"><a href="#install-JDK-linux-windows">10.1.7.  Uninstalling JDK on Linux and Windows</a></span></dt><dt><span class="section"><a href="#setting-jboss-ENV-variable-windows-unix">10.1.8. Setting the JBOSS_HOME Environment Variable</a></span></dt><dt><span class="section"><a href="#setting-CATALINA_HOME-ENV-linux-windows">10.1.9. Setting CATALINA_HOME on Linux and Windows</a></span></dt></dl></dd></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="install-configure-JDK"/>10.1. Java Development Kit (<acronym class="acronym">JDK</acronym>): Installing, Configuring and Running</h2></div></div></div><p>
		The <span class="application">Mobicents Platform</span> is written in Java; therefore, before running any <span class="application">Mobicents</span> server, you must have a working Java Runtime Environment (<acronym class="acronym">JRE</acronym>) or Java Development Kit (<acronym class="acronym">JDK</acronym>) installed on your system. In addition, the JRE or JDK you are using to run <span class="application">Mobicents</span> must be version 5 or higher<a href="#ftn.d0e6555" class="footnote"><sup class="footnote"><a id="d0e6555"/>[1]</sup></a>.
	</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="JRE-or-JDK-32Bit-or-64Bit"/>10.1.1.  JRE versus JDK - 32-Bit versus 64-Bit</h3></div></div></div><p><strong>Should I Install the JRE or JDK? </strong>
			Although you can run <span class="application">Mobicents</span> servers using the Java Runtime Environment, we assume that most users are developers interested in developing Java-based, <span class="application">Mobicents</span>-driven solutions. Therefore, in this guide we take the tact of showing how to install the full Java Development Kit.
		</p><p><strong>Should I Install the 32-Bit or the 64-Bit JDK, and Does It Matter? </strong>
			Briefly stated: if you are running on a 64-Bit Linux or Windows platform, you should consider installing and running the 64-bit JDK over the 32-bit one. Here are some heuristics for determining whether you would rather run the 64-bit Java Virtual Machine (JVM) over its 32-bit cousin for your application:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
				Wider datapath: the pipe between RAM and CPU is doubled, which improves the performance of memory-bound applications when using a 64-bit JVM.
			</p></li><li class="listitem"><p>
				64-bit memory addressing gives virtually unlimited (1 exabyte) heap allocation. However large heaps affect garbage collection.
			</p></li><li class="listitem"><p>
				Applications that run with more than 1.5 GB of RAM (including free space for garbage collection optimization) should utilize the 64-bit JVM.
			</p></li><li class="listitem"><p>
				Applications that run on a 32-bit JVM and do not require more than minimal heap sizes will gain nothing from a 64-bit JVM. Barring memory issues, 64-bit hardware with the same relative clock speed and architecture is not likely to run Java applications faster than their 32-bit cousin.
			</p></li></ul></div><p>
		Note that the following instructions detail how to download and install the 32-bit JDK, although the steps are nearly identical for installing the 64-bit version.
	</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Downloading-JDK"/>10.1.2. Downloading JDK </h3></div></div></div><p>
			You can download the Sun JDK 5.0 (Java 2 Development Kit) from Sun's website: <a class="ulink" href="http://java.sun.com/javase/downloads/index_jdk5.jsp">http://java.sun.com/javase/downloads/index_jdk5.jsp</a>. Click on the <span class="guilabel">Download</span> link next to "JDK 5.0 Update <em class="replaceable"><code>&lt;x&gt;</code></em>" (where <em class="replaceable"><code>&lt;x&gt;</code></em> is the latest minor version release number). On the next page, select your language and platform (both architecture—whether 32- or 64-bit—and operating system), read and agree to the <code class="literal">Java Development Kit 5.0 License Agreement</code>, and proceed to the download page.
		</p><p>
		The Sun website will present two download alternatives to you: one is an RPM inside a self-extracting file (for example, <code class="filename">jdk-1_5_0_16-linux-i586-rpm.bin</code>), and the other is merely a self-extracting file (e.g. <code class="filename">jdk-1_5_0_16-linux-i586.bin</code>). If you are installing the JDK on Red Hat Enterprise Linux, Fedora, or another RPM-based Linux system, we suggest that you download the self-extracting file containing the RPM package, which will set up and use the SysV service scripts in addition to installing the JDK. We also suggest installing the self-extracting RPM file if you will be running <span class="application">Mobicents</span> in a production environment.
	</p><p><strong>Installing. </strong>
			The following procedures detail how to install the Java Development Kit on both Linux and Windows.
		</p><div class="procedure"><a id="d0e6637"/><p class="title"><strong>Procedure 10.1. Installing the JDK on Linux</strong></p><ul class="procedure"><li class="step"><p>
				Regardless of which file you downloaded, you can install it on Linux by simply making sure the file is executable and then running it:
			</p><pre class="screen">~]$ chmod +x "jdk-1_5_0_&lt;minor_version&gt;-linux-&lt;architecture&gt;-rpm.bin"
~]$ ./"jdk-1_5_0_&lt;minor_version&gt;-linux-&lt;architecture&gt;-rpm.bin"</pre></li></ul></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Moving from Non-RPM Installer to SysV Service Scripts</h2><p>
			If you download the non-RPM self-extracting file (and installed it), and you are running on an RPM-based system, you can still set up the SysV service scripts by downloading and installing one of the <code class="literal">-compat</code> packages from the JPackage project. Remember to download the <code class="literal">-compat</code> package which corresponds correctly to the minor release number of the JDK you installed. The compat packages are available from <a class="ulink" href="ftp://jpackage.hmdc.harvard.edu/JPackage/1.7/generic/RPMS.non-free/">ftp://jpackage.hmdc.harvard.edu/JPackage/1.7/generic/RPMS.non-free/</a>.
		</p></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2><p>
			You do not need to install a <code class="literal">-compat</code> package in addition to the JDK if you installed the self-extracting RPM file! The <code class="literal">-compat</code> package merely performs the same SysV service script set up that the RPM version of the JDK installer does.
		</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="install-JDK-on-windows"/>10.1.3. Installing JDK on Windows</h3></div></div></div><div class="procedure"><ul class="procedure"><li class="step"><p>
				Using Explorer, simply double-click the downloaded self-extracting installer and follow the instructions to install the JDK.
			</p></li></ul></div><p><strong>Configuring. </strong>
			Configuring your system for the JDK consists in two tasks: setting the <code class="envar">JAVA_HOME</code> environment variable, and ensuring that the system is using the proper JDK (or JRE) using the <span class="command"><strong>alternatives</strong></span> command. Setting <code class="envar">JAVA_HOME</code> usually overrides the values for <span class="command"><strong>java</strong></span>, <span class="command"><strong>javac</strong></span> and <span class="command"><strong>java_sdk_1.5.0</strong></span> in <span class="command"><strong>alternatives</strong></span>, but we will set them all just to be safe and consistent.
		</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="setting-ENV-linux"/>10.1.4. Setting Linux JAVA_HOME Environment Variables </h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Setting the <code class="envar">JAVA_HOME</code> Environment Variable on Generic Linux</span></dt><dd><p>
					After installing the JDK, you must ensure that the <code class="envar">JAVA_HOME</code> environment variable exists and points to the location of your JDK installation.
				</p><p><strong>Setting the <code class="envar">JAVA_HOME</code> Environment Variable on Linux. </strong>
						You can determine whether <code class="envar">JAVA_HOME</code> is set on your system by <span class="command"><strong>echo</strong></span>ing it on the command line:
					</p><pre class="screen">~]$ echo $JAVA_HOME</pre><p>
					If <code class="envar">JAVA_HOME</code> is not set already, then you must set its value to the location of the JDK installation on your system. You can do this by adding two lines to your personal <code class="filename">~/.bashrc</code> configuration file. Open <code class="filename">~/.bashrc</code> (or create it if it doesn't exist) and add a line similar to the following one anywhere inside the file:
				</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">export JAVA_HOME="/usr/lib/jvm/jdk1.5.0_&lt;version&gt;"
</pre><p>
					You should also set this environment variable for any other users who will be running <span class="application">Mobicents</span> (any environment variables <span class="command"><strong>export</strong></span>ed from <code class="filename">~/.bashrc</code> files are local to that user).
				</p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="setting-correct-java-version"/>10.1.5. Setting the Correct Java Version </h3></div></div></div><dt><span class="term">Setting <code class="envar">java</code>, <code class="envar">javac</code> and <code class="envar">java_sdk_1.5.0</code> Using the <span class="command"><strong>alternatives</strong></span> command </span></dt><dd><p><strong>Selecting the Correct System JVM on Linux using <span class="command"><strong>alternatives</strong></span>
					. </strong>
						On systems with the <span class="command"><strong>alternatives</strong></span> command, including Red Hat Enterprise Linux and Fedora, you can easily choose which JDK (or JRE) installation you wish to use, as well as which <span class="command"><strong>java</strong></span> and <span class="command"><strong>javac</strong></span> executables should be run when called.
					</p><p>
					<span class="emphasis"><em>As the root user</em></span>, call <span class="command"><strong>/usr/sbin/alternatives</strong></span> with the <code class="option">--config java</code> option to select between JDKs and JREs installed on your system:
				</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">root@localhost ~]$ /usr/sbin/alternatives --config java

There are 3 programs which provide 'java'.

  Selection    Command
-----------------------------------------------
   1           /usr/lib/jvm/jre-1.5.0-gcj/bin/java
   2           /usr/lib/jvm/jre-1.6.0-sun/bin/java
*+ 3         /usr/lib/jvm/jre-1.5.0-sun/bin/java


Enter to keep the current selection[+], or type selection number:
</pre><p>
					In our case, we want to use the Sun JDK, version 5, that we downloaded and installed, to run the <span class="command"><strong>java</strong></span> executable. In the <span class="command"><strong>alternatives</strong></span> information printout above, a plus (<code class="literal">+</code>) next to a number indicates the one currently being used. As per <span class="command"><strong>alternatives</strong></span>' instructions, pressing <span class="keycap"><strong>Enter</strong></span> will simply keep the current JVM, or you can enter the number corresponding to the JVM you would prefer to use.
				</p><p>
					Repeat the procedure above for the <span class="command"><strong>javac</strong></span> command and the <code class="literal">java_sdk_1.5.0</code> environment variable, <span class="emphasis"><em>as the root user</em></span>:
				</p><pre class="screen">~]$ /usr/sbin/alternatives --config javac</pre><pre class="screen">~]$ /usr/sbin/alternatives --config java_sdk_1.5.0</pre></dd></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="setting-ENV-windows"/>10.1.6. Setting JAVA_HOME Environment Variables on Windows</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Setting the <code class="envar">JAVA_HOME</code> Environment Variable on Windows</span></dt><dd><p>
					For information on how to set environment variables in Windows, refer to <a class="ulink" href="http://support.microsoft.com/kb/931715">http://support.microsoft.com/kb/931715</a>.
				</p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="install-JDK-linux-windows"/>10.1.7.  Uninstalling JDK on Linux and Windows</h3></div></div></div><p><strong>Uninstalling. </strong>
			There is usually no reason (other than space concerns) to remove a particular JDK from your system, given that you can switch between JDKs and JREs easily using <span class="command"><strong>alternatives</strong></span>, and/or by setting <code class="envar">JAVA_HOME</code>.
		</p><p><strong>Uninstalling the JDK on Linux. </strong>
			On RPM-based systems, you can uninstall the JDK using the <span class="command"><strong>yum <code class="option">remove &lt;jdk_rpm_name&gt;</code>
			</strong></span> command.
		</p><p><strong>Uninstalling the JDK on Windows. </strong>
			On Windows systems, check the JDK entry in the <code class="literal">Start</code> menu for an uninstall command, or use <code class="literal">Add/Remove Programs</code>.
		</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="setting-jboss-ENV-variable-windows-unix"/>10.1.8. Setting the JBOSS_HOME Environment Variable</h3></div></div></div><p>
		The <span class="application">Mobicents Platform</span> (<span class="application">Mobicents</span>) is built on top of the <span class="application">JBoss Application Server</span> (<span class="application">JBoss AS</span>). You do not need to set the <code class="envar">JBOSS_HOME</code> environment variable to run any of the <span class="application">Mobicents Platform</span> servers <span class="emphasis"><em>unless</em></span> <code class="envar">JBOSS_HOME</code> is <span class="emphasis"><em>already</em></span> set.
	</p><p>The best way to know for sure whether <code class="envar">JBOSS_HOME</code> was set previously or not is to perform a simple check which may save you time and frustration.</p><p><strong>Checking to See If JBOSS_HOME is Set on Unix. </strong>At the command line, <span class="command"><strong>echo</strong></span>
			<strong class="userinput"><code>$JBOSS_HOME</code></strong> to see if it is currently defined in your environment:</p><pre class="screen">~]$ echo $JBOSS_HOME</pre><p>The <span class="application">Mobicents Platform</span> and most Mobicents servers are built on top of the <span class="application">JBoss Application Server</span> (<span class="application">JBoss AS</span>). When the <span class="application">Mobicents Platform</span> or Mobicents servers are built <span class="emphasis"><em>from source</em></span>, then <code class="envar">JBOSS_HOME</code> <span class="emphasis"><em>must</em></span> be set, because the Mobicents files are installed into (or <span class="quote">“<span class="quote">over top of</span>”</span> if you prefer) a clean <span class="application">JBoss AS</span> installation, and the build process assumes that the location pointed to by the <code class="envar">JBOSS_HOME</code> environment variable at the time of building is the <span class="application">JBoss AS</span> installation into which you want it to install the Mobicents files.
	</p><p>This guide does not detail building the <span class="application">Mobicents Platform</span> or any Mobicents servers from source. It is nevertheless useful to understand the role played by <span class="application">JBoss AS</span> and <code class="envar">JBOSS_HOME</code> in the Mobicents ecosystem.</p><p>
		The immediately-following section considers whether you need to set <code class="envar">JBOSS_HOME</code> at all and, if so, when. The subsequent sections detail how to set <code class="envar">JBOSS_HOME</code> on Unix and Windows
	</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2><p>
			Even if you fall into the category below of <span class="emphasis"><em>not needing</em></span> to set <code class="envar">JBOSS_HOME</code>, you may want to for various reasons anyway. Also, even if you are instructed that you do <span class="emphasis"><em>not need</em></span> to set <code class="envar">JBOSS_HOME</code>, it is good practice nonetheless to check and make sure that <code class="envar">JBOSS_HOME</code> actually <span class="emphasis"><em>isn't</em></span> set or defined on your system for some reason. This can save you both time and frustration.
		</p></div><h4><a id="d0e7022"/>You <span class="emphasis"><em>DO NOT NEED</em></span> to set <code class="envar">JBOSS_HOME</code> if...</h4><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
				...you have installed the <span class="application">Mobicents Platform</span> binary distribution.
			</p></li><li class="listitem"><p>
				...you have installed a Mobicents server binary distribution <span class="emphasis"><em>which bundles <span class="application">JBoss AS</span>.</em></span>
			</p></li></ul></div><h4><a id="d0e7046"/>You <span class="emphasis"><em>MUST</em></span> set <code class="envar">JBOSS_HOME</code> if...</h4><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
				...you are installing the <span class="application">Mobicents Platform</span> or any of the Mobicents servers <span class="emphasis"><em>from source</em></span>.
			</p></li><li class="listitem"><p>
				...you are installing the <span class="application">Mobicents Platform</span> binary distribution, or one of the Mobicents server binary distributions, which <span class="emphasis"><em>do not</em></span> bundle <span class="application">JBoss AS</span>.
			</p></li></ul></div><p>
		Naturally, if you installed the <span class="application">Mobicents Platform</span> or one of the Mobicents server binary releases which <span class="emphasis"><em>do not</em></span> bundle <span class="application">JBoss AS</span>, yet requires it to run, then you should <a class="ulink" href="http://docs.jboss.org/jbossas/docs/Installation_And_Getting_Started_Guide/5/html_single/index.html">install <span class="application">JBoss AS</span>
		</a> before setting <code class="envar">JBOSS_HOME</code> or proceeding with anything else.
	</p><p><strong>Setting the JBOSS_HOME Environment Variable on Unix. </strong>
			The <code class="envar">JBOSS_HOME</code> environment variable must point to the directory which contains all of the files for the <span class="phrase"><span class="application">Mobicents Platform</span> or individual Mobicents server</span> that you installed. As another hint, this topmost directory contains a <code class="filename">bin</code> subdirectory.
		</p><p>
		Setting <code class="envar">JBOSS_HOME</code> in your personal <code class="filename">~/.bashrc</code> startup script carries the advantage of retaining effect over reboots. Each time you log in, the environment variable is sure to be set for you, as a user. On Unix, it is possible to set <code class="envar">JBOSS_HOME</code> as a system-wide environment variable, by defining it in <code class="filename">/etc/bashrc</code>, but this method is neither recommended nor detailed in these instructions.
	</p><div class="procedure"><a id="d0e7126"/><p class="title"><strong>Procedure 10.2. To Set JBOSS_HOME on Unix...</strong></p><ol class="procedure" type="1"><li class="step"><p>
				Open the <code class="filename">~/.bashrc</code> startup script, which is a hidden file in your home directory, in a text editor, and insert the following line on its own line while substituting for the actual install location on your system:
			</p><pre class="screen">export JBOSS_HOME="/home/&lt;username&gt;/&lt;path&gt;/&lt;to&gt;/&lt;install_directory&gt;"</pre></li><li class="step"><p>
				Save and close the <code class="filename">.bashrc</code> startup script.
			</p></li><li class="step"><p>
				You should <span class="command"><strong>source</strong></span> the <code class="filename">.bashrc</code> script to force your change to take effect, so that <code class="envar">JBOSS_HOME</code> becomes set for the current session<a href="#ftn.d0e7156" class="footnote"><sup class="footnote"><a id="d0e7156"/>[2]</sup></a>.
			</p><pre class="screen">~]$ source ~/.bashrc</pre></li><li class="step"><p>
				Finally, ensure that <code class="envar">JBOSS_HOME</code> is set in the current session, and actually points to the correct location:
			</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>
					The command line usage below is based upon a binary installation of the <span class="application">Mobicents Platform</span>. In this sample output, <code class="envar">JBOSS_HOME</code> has been set correctly to the <em class="replaceable"><code>topmost_directory</code></em> of the <span class="application">Mobicents</span> installation. Note that if you are installing one of the standalone <span class="application">Mobicents</span> servers (with <span class="application">JBoss AS</span> bundled!), then <code class="envar">JBOSS_HOME</code> would point to the <em class="replaceable"><code>topmost_directory</code></em> of your server installation.
				</p></div><pre class="screen">~]$ echo $JBOSS_HOME
/home/silas/mobicents-all-1.2.1.GA-jboss-4.2.3.GA/jboss/</pre></li></ol></div><p><strong>Setting the JBOSS_HOME Environment Variable on Windows. </strong>
			The <code class="envar">JBOSS_HOME</code> environment variable must point to the directory which contains all of the files for the <span class="phrase">Mobicents Platform or individual Mobicents server</span> that you installed. As another hint, this topmost directory contains a <code class="filename">bin</code> subdirectory.
		</p><p>
		For information on how to set environment variables in recent versions of Windows, refer to <a class="ulink" href="http://support.microsoft.com/kb/931715">http://support.microsoft.com/kb/931715</a>.
	</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="setting-CATALINA_HOME-ENV-linux-windows"/>10.1.9. Setting CATALINA_HOME on Linux and Windows</h3></div></div></div><div class="procedure"><a id="bssswticar-Setting_the_CATALINA_HOME_Environment_Variable_on_Linux"/><p class="title"><strong>Procedure 10.3. Setting the <code class="envar">CATALINA_HOME</code> Environment Variable on Linux</strong></p><ol class="procedure" type="1"><li class="step"><p>The <code class="envar">CATALINA_HOME</code> environment variable must point to the location of your Tomcat installation. Any Mobicents server which runs on top of the Tomcat servlet container has a topmost directory, i.e. the directory in which you unzipped the zip file to install the server, and underneath that directory, a <code class="filename">bin</code> directory. <code class="envar">CATALINA_HOME</code> must be set to the topmost directory of your Mobicents server installation.</p><p>Setting this variable in your personal <code class="filename">~/.bashrc</code> file has the advantage that it will always be set (for you, as a user) each time you log in or reboot the system. To do so, open <code class="filename">~/.bashrc</code> in a text editor (or create the file if it doesn't already exist) and insert the following line anywhere in the file, taking care to substitute <code class="filename">&lt;sip_server&gt;</code> for the topmost directory of the Mobicents server you installed:</p><pre class="screen">export CATALINA_HOME="/home/&lt;username&gt;/&lt;path&gt;/&lt;to&gt;/&lt;sip_server&gt;"</pre><p>Save and close <code class="filename">.bashrc</code>.</p></li><li class="step"><p>You can—and should—<span class="command"><strong>source</strong></span> your <code class="filename">.bashrc</code> file to make your change take effect (so that <code class="envar">CATALINA_HOME</code> is set) for the current session:</p><pre class="screen">~]$ source ~/.bashrc</pre></li><li class="step"><p>Finally, make sure that <code class="envar">CATALINA_HOME</code> has been set correctly (that it leads to the right directory), and has taken effect in the current session.</p><p>The following command will show the path to the directory pointed to by <code class="envar">CATALINA_HOME</code>:</p><pre class="screen">~]$ echo $CATALINA_HOME</pre><p>To be absolutely sure, change your directory to the one pointed to by <code class="envar">CATALINA_HOME</code>:</p><pre class="screen">~]$ cd $CATALINA_HOME &amp;&amp; pwd</pre></li></ol></div><div class="procedure"><a id="bssswticar-Setting_the_CATALINA_HOME_Environment_Variable_on_Windows"/><p class="title"><strong>Procedure 10.4. Setting the <code class="envar">CATALINA_HOME</code> Environment Variable on Windows</strong></p><ul class="procedure"><li class="step"><p>The <code class="envar">CATALINA_HOME</code> environment variable must point to the location of your Tomcat installation. Any Mobicents server which runs on top of the Tomcat servlet container has a topmost directory, i.e. the directory in which you unzipped the zip file to install the server, and underneath that directory, a <code class="filename">bin</code> directory. <code class="envar">CATALINA_HOME</code> must be set to the topmost directory of your Mobicents server installation.</p><p>If you are planning on running the Tomcat container as the Administrator, then you should, of course, set the <code class="envar">CATALINA_HOME</code> environment variable <span class="emphasis"><em>as the administrator</em></span>, and if you planning to run Tomcat as a normal user, then set <code class="envar">CATALINA_HOME</code> as a user environment variable.</p><p>For information on how to set environment variables in Windows, refer to <a class="ulink" href="http://support.microsoft.com/kb/931715">http://support.microsoft.com/kb/931715</a>.</p></li></ul></div></div></div><div class="footnotes"><br/><hr width="100" align="left"/><div id="ftn.d0e6555" class="footnote"><p><a href="#d0e6555" class="para"><sup class="para">[1] </sup></a>
			At this point in time, it is possible to run most <span class="application">Mobicents</span> servers, such as the JAIN SLEE Server, using a Java 6 JRE or JDK. Be aware, however, that presently the XML Document Management Server does not run on Java 6. We suggest checking the Mobicents web site, forums or discussion pages if you need to inquire about the status of running the XML Document Management Server with Java 6.
		</p></div><div id="ftn.d0e7156" class="footnote"><p><a href="#d0e7156" class="para"><sup class="para">[2] </sup></a>
					Note that any other terminals which were opened prior to your having altered <code class="filename">.bashrc</code> will need to <span class="command"><strong>source</strong></span>
						<code class="filename">~/.bashrc</code> as well should they require access to <code class="envar">JBOSS_HOME</code>.
				</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="bp-jsr289-errata"/>Chapter 11. JSR 289 Errata</h1></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#errata-Deviations">11.1. Mobicents SIP Servlets Deviations from JSR 289</a></span></dt></dl></div><p>This chapter discusses deviations from the JSR 289 specification by Mobicents
  SIP Servlets after feedback on usage in real world deployments and from the community.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="errata-Deviations"/>11.1. Mobicents SIP Servlets Deviations from JSR 289</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p><span class="emphasis"><em>Correlation of Responses to Proxy Branches </em></span>: It seems the javadoc for <a class="ulink" href="http://ci.jboss.org/jenkins/view/Mobicents/job/Mobicents-Books/lastSuccessfulBuild/artifact/api-docs/jsr289/javadocs/javax/servlet/sip/SipServlet.html#doResponse(javax.servlet.sip.SipServletResponse)">Speed Dial</a> contains an error, SipServlet.doBranchResponse() shouldn't be included as it contradicts the last sentence from the spec 10.2.4.2 Correlating responses to proxy branches :
			"Note that if the doBranchResponse() is not overridden then doResponse() method will be invoked only for the best final response as before", 
			If SipServlet.doBranchResponse() handling is done in SipServlet.doResponse() and the servlet overrides SipServlet.doResponse() then it will receive intermediate final responses 
			as well as the best final response which is not the desired behavior, so the doBranchResponse() handling is done in SipServlet.doService() method allowing applications 
			not overriding doResponse or doService to receive both intermediate final responses  on the doBranchResponse as well as the best final response on doResponse but this fixes the issue of intermediate final responses being delivered to doResponse in case the servlet overrides it.
		</p></li><li class="listitem"><p><span class="emphasis"><em>SipServletResponse typo</em></span> :
          <span class="emphasis"><em> SipServletResponse.SC_TEMPORARLY_UNAVAILABLE</em></span>  should be replaced by SC_TEMPORARILY_UNAVAILABLE.</p></li></ul></div></div></div><div class="appendix"><div class="titlepage"><div><div><h1 class="title"><a id="d0e7362"/>Appendix A. Revision History</h1></div></div></div><p>
		<div class="revhistory"><table summary="Revision History"><tr><th align="left" valign="top" colspan="3"><strong>Revision History</strong></th></tr><tr><td align="left">Revision 4.0</td><td align="left">Mon Jan 24 2011</td><td align="left"><span class="author"><span class="firstname">Tom</span> <span class="surname">Wells</span></span></td></tr><tr><td align="left" colspan="3">
          <table border="0" summary="Simple list" class="simplelist"><tr><td>Publican valid edition of community documentation.</td></tr></table>
        </td></tr><tr><td align="left">Revision 3.0</td><td align="left">Thu Jun 11 2009</td><td align="left"><span class="author"><span class="firstname">Jared</span> <span class="surname">Morgan</span></span></td></tr><tr><td align="left" colspan="3">
          <table border="0" summary="Simple list" class="simplelist"><tr><td>Second release of the "parameterized" documentation.</td></tr></table>
        </td></tr><tr><td align="left">Revision 2.0</td><td align="left">Fri Mar 06 2009</td><td align="left"><span class="author"><span class="firstname">Douglas</span> <span class="surname">Silas</span></span></td></tr><tr><td align="left" colspan="3">
          <table border="0" summary="Simple list" class="simplelist"><tr><td>First release of the "parameterized", and much-improved JBCP documentation.</td></tr></table>
        </td></tr></table></div>
  </p></div></div></body></html>